<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="description" content="Documentation for Hugo Learn Theme">
<meta name="author" content="Mathieu Cornic">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>touchEventNative :: 郑欢的学习总结</title>

    
    <link href="/css/nucleus.css?1611382862" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1611382862" rel="stylesheet">
    <link href="/css/hybrid.css?1611382862" rel="stylesheet">
    <link href="/css/featherlight.min.css?1611382862" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1611382862" rel="stylesheet">
    <link href="/css/auto-complete.css?1611382862" rel="stylesheet">
    <link href="/css/atom-one-dark.css?1611382862" rel="stylesheet">
    <link href="/css/theme.css?1611382862" rel="stylesheet">
    <link href="/css/hugo-theme.css?1611382862" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1611382862" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1611382862"></script>

    <script src="/js/auto_toc_scroll.js?1611382862"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/en'>
    <img src="/avatar.png" width="60px" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1611382862"></script>
<script type="text/javascript" src="/js/auto-complete.js?1611382862"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/huanle19891345.github.io\/\/en";
    
</script>
<script type="text/javascript" src="/js/search.js?1611382862"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/en/android/" title="android" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/">
          android
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/google/" title="google" class="dd-item
        
        
        
        ">
      <a href="/en/android/google/">
          google
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/google/supporttoandroidx/" title="supportToAndroidx" class="dd-item ">
        <a href="/en/android/google/supporttoandroidx/">
        supportToAndroidx
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/" title="系统机制原理" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/">
          系统机制原理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/" title="ashmem" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/">
          ashmem
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/" title="匿名共享内存Ashmem" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/">
        匿名共享内存Ashmem
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/" title="bitmap" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/">
          bitmap
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/" title="Bitmap" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/">
        Bitmap
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/" title="BitmapSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/">
        BitmapSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/" title="handler" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/">
          handler
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/" title="Looper" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/">
        Looper
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/" title="ThreadLocal" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/">
        ThreadLocal
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/" title="input" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/">
          input
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/" title="touchEventNative" class="dd-item active">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/">
        touchEventNative
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/" title="zygote" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/">
          zygote
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/" title="SystemServerSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/">
        SystemServerSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/" title="ZygoteSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/">
        ZygoteSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/" title="Zygote进程" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/">
        Zygote进程
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/" title="多进程" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">
          多进程
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/" title="binder" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/">
          binder
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/" title="BinderClient" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/">
        BinderClient
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/" title="BinderDeath" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/">
        BinderDeath
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/" title="BinderKernel" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/">
        BinderKernel
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/" title="BinderServer" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/">
        BinderServer
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/" title="BinderServiceManager" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/">
        BinderServiceManager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/" title="Binder原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/">
        Binder原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/" title="mmkv" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/">
          mmkv
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/" title="MMKV" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/">
        MMKV
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/" title="系统绘制" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/">
          系统绘制
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/" title="Graphics" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/">
        Graphics
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/" title="Vsync" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/">
        Vsync
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/" title="Vsync_SurfaceFlinger" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/">
        Vsync_SurfaceFlinger
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/" title="硬件加速绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/">
        硬件加速绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/" title="绘制原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/">
        绘制原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/" title="软件绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/">
        软件绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" title="跨平台" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">
          跨平台
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/" title="flutter" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/">
          flutter
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/" title="通信" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/">
          通信
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" title="Flutter消息机制" class="dd-item ">
        <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/">
        Flutter消息机制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/huanle19891345"><i class='fab fa-fw fa-github'></i> GitHub repo</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/showcase"><i class='fas fa-fw fa-camera'></i> Showcases</a>
              </li>
          
              <li>
                  <a class="padding" href="https://gohugo.io/"><i class='fas fa-fw fa-bookmark'></i> Hugo Documentation</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/credits"><i class='fas fa-fw fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/en/'>技术探索总结</a> > <a href='/en/android/'>android</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/'>系统机制原理</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/'>input</a> > touchEventNative
          
        
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#原理图">原理图</a></li>
    <li><a href="#systemserver">SystemServer</a>
      <ul>
        <li><a href="#startotherservices">startOtherServices</a></li>
      </ul>
    </li>
    <li><a href="#inputmanagerservice">InputManagerService</a>
      <ul>
        <li><a href="#start">start</a></li>
        <li><a href="#registerinputchannel">registerInputChannel</a></li>
      </ul>
    </li>
    <li><a href="#com_android_server_input_inputmanagerservice">com_android_server_input_InputManagerService</a>
      <ul>
        <li><a href="#nativeinit">nativeInit</a></li>
        <li><a href="#nativestart">nativeStart</a></li>
        <li><a href="#nativeregisterinputchannel">nativeRegisterInputChannel</a></li>
      </ul>
    </li>
    <li><a href="#nativeinputmanager">NativeInputManager</a>
      <ul>
        <li><a href="#registerinputchannel-1">registerInputChannel</a></li>
      </ul>
    </li>
    <li><a href="#inputmanager">InputManager</a>
      <ul>
        <li><a href="#initialize">initialize</a></li>
        <li><a href="#start-1">start</a></li>
      </ul>
    </li>
    <li><a href="#eventhub">EventHub</a>
      <ul>
        <li><a href="#eventhub-1">EventHub</a></li>
        <li><a href="#getevents">getEvents</a></li>
        <li><a href="#readnotifylocked">readNotifyLocked</a></li>
      </ul>
    </li>
    <li><a href="#inputreaderthread">InputReaderThread</a>
      <ul>
        <li><a href="#threadloop">threadLoop</a></li>
      </ul>
    </li>
    <li><a href="#inputreader">InputReader</a>
      <ul>
        <li><a href="#threadloop-1">threadLoop</a></li>
        <li><a href="#looponce">loopOnce</a></li>
      </ul>
    </li>
    <li><a href="#queuedinputlistener">QueuedInputListener</a>
      <ul>
        <li><a href="#flush">flush</a></li>
      </ul>
    </li>
    <li><a href="#notifymotionargs">NotifyMotionArgs</a>
      <ul>
        <li><a href="#notify">notify</a></li>
      </ul>
    </li>
    <li><a href="#inputdispatcher">InputDispatcher</a>
      <ul>
        <li><a href="#threadloop-2">threadLoop</a></li>
        <li><a href="#dispatchonce">dispatchOnce</a></li>
        <li><a href="#notifymotion">notifyMotion</a></li>
        <li><a href="#dispatchonceinnerlocked">dispatchOnceInnerLocked</a></li>
        <li><a href="#dispatchmotionlocked">dispatchMotionLocked</a></li>
        <li><a href="#dispatcheventlocked">dispatchEventLocked</a></li>
        <li><a href="#preparedispatchcyclelocked">prepareDispatchCycleLocked</a></li>
        <li><a href="#enqueuedispatchentrieslocked">enqueueDispatchEntriesLocked</a></li>
        <li><a href="#startdispatchcyclelocked">startDispatchCycleLocked</a></li>
        <li><a href="#handlereceivecallback">handleReceiveCallback</a></li>
      </ul>
    </li>
    <li><a href="#inputpublisher">InputPublisher</a>
      <ul>
        <li><a href="#publishmotionevent">publishMotionEvent</a></li>
      </ul>
    </li>
    <li><a href="#inputconsumer">InputConsumer</a>
      <ul>
        <li><a href="#sendfinishedsignal">sendFinishedSignal</a></li>
        <li><a href="#sendunchainedfinishedsignal">sendUnchainedFinishedSignal</a></li>
      </ul>
    </li>
    <li><a href="#inputchannel两个socket实现双向监听">InputChannel(两个Socket实现双向监听)</a>
      <ul>
        <li><a href="#sendmessage">sendMessage</a></li>
        <li><a href="#socketchannel-systemserver进程">Socket/Channel SystemServer进程</a>
          <ul>
            <li><a href="#registerinputchannel-2">registerInputChannel</a></li>
          </ul>
        </li>
        <li><a href="#socketchannel-app进程">Socket/Channel app进程</a></li>
      </ul>
    </li>
    <li><a href="#loopercpp">Looper.cpp</a>
      <ul>
        <li><a href="#pollinner">pollInner</a></li>
      </ul>
    </li>
    <li><a href="#nativeinputeventreceiver">NativeInputEventReceiver</a>
      <ul>
        <li><a href="#handleevent">handleEvent</a></li>
        <li><a href="#consumeevents">consumeEvents</a></li>
      </ul>
    </li>
    <li><a href="#inputeventreceiver">InputEventReceiver</a>
      <ul>
        <li><a href="#dispatchinputevent">dispatchInputEvent</a></li>
        <li><a href="#finishinputevent">finishInputEvent</a></li>
      </ul>
    </li>
    <li><a href="#android_view_inputeventreceiver">android_view_InputEventReceiver</a>
      <ul>
        <li><a href="#nativefinishinputevent">nativeFinishInputEvent</a></li>
        <li><a href="#finishinputevent-1">finishInputEvent</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              touchEventNative
            </h1>
          

        


<h2 id="原理图">原理图</h2>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative.assets/input.png" alt=""></p>
<h2 id="systemserver">SystemServer</h2>
<h3 id="startotherservices">startOtherServices</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startOtherServices</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            inputManager <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputManagerService<span style="color:#f92672">(</span>context<span style="color:#f92672">);</span>
  
            wm <span style="color:#f92672">=</span> WindowManagerService<span style="color:#f92672">.</span><span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> inputManager<span style="color:#f92672">,</span>
                    mFactoryTestMode <span style="color:#f92672">!=</span> FactoryTest<span style="color:#f92672">.</span><span style="color:#a6e22e">FACTORY_TEST_LOW_LEVEL</span><span style="color:#f92672">,</span>
                    <span style="color:#f92672">!</span>mFirstBoot<span style="color:#f92672">,</span> mOnlyCore<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> PhoneWindowManager<span style="color:#f92672">());</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">WINDOW_SERVICE</span><span style="color:#f92672">,</span> wm<span style="color:#f92672">,</span> <span style="color:#75715e">/* allowIsolated= */</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span>
                    DUMP_FLAG_PRIORITY_CRITICAL <span style="color:#f92672">|</span> DUMP_FLAG_PROTO<span style="color:#f92672">);</span>
            ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">INPUT_SERVICE</span><span style="color:#f92672">,</span> inputManager<span style="color:#f92672">,</span>
                    <span style="color:#75715e">/* allowIsolated= */</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> DUMP_FLAG_PRIORITY_CRITICAL<span style="color:#f92672">);</span>
  
          <span style="color:#f92672">......</span>
            inputManager<span style="color:#f92672">.</span><span style="color:#a6e22e">setWindowManagerCallbacks</span><span style="color:#f92672">(</span>wm<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputMonitor</span><span style="color:#f92672">());</span>
            inputManager<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="inputmanagerservice">InputManagerService</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InputManagerService</span> <span style="color:#66d9ef">extends</span> IInputManager<span style="color:#f92672">.</span><span style="color:#a6e22e">Stub</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">InputManagerService</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mContext</span> <span style="color:#f92672">=</span> context<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mHandler</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputManagerHandler<span style="color:#f92672">(</span>DisplayThread<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getLooper</span><span style="color:#f92672">());</span>

        mPtr <span style="color:#f92672">=</span> nativeInit<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> mContext<span style="color:#f92672">,</span> mHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">getLooper</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getQueue</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="start">start</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span>() {
        Slog.i(TAG, <span style="color:#e6db74">&#34;Starting input manager&#34;</span>);
        nativeStart(mPtr);
    }
</code></pre></div><h3 id="registerinputchannel">registerInputChannel</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerInputChannel</span><span style="color:#f92672">(</span>InputChannel inputChannel<span style="color:#f92672">,</span>
            InputWindowHandle inputWindowHandle<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        nativeRegisterInputChannel<span style="color:#f92672">(</span>mPtr<span style="color:#f92672">,</span> inputChannel<span style="color:#f92672">,</span> inputWindowHandle<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp</p>
<h2 id="com_android_server_input_inputmanagerservice">com_android_server_input_InputManagerService</h2>
<h3 id="nativeinit">nativeInit</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> jlong <span style="color:#a6e22e">nativeInit</span>(JNIEnv<span style="color:#f92672">*</span> env, jclass <span style="color:#75715e">/* clazz */</span>,
        jobject serviceObj, jobject contextObj, jobject messageQueueObj) {
    sp<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">&gt;</span> messageQueue <span style="color:#f92672">=</span> android_os_MessageQueue_getMessageQueue(env, messageQueueObj);

    NativeInputManager<span style="color:#f92672">*</span> im <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NativeInputManager(contextObj, serviceObj,
            messageQueue<span style="color:#f92672">-&gt;</span>getLooper());
    im<span style="color:#f92672">-&gt;</span>incStrong(<span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>jlong<span style="color:#f92672">&gt;</span>(im);
}
</code></pre></div><h3 id="nativestart">nativeStart</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">nativeStart</span>(JNIEnv<span style="color:#f92672">*</span> env, jclass <span style="color:#75715e">/* clazz */</span>, jlong ptr) {
    NativeInputManager<span style="color:#f92672">*</span> im <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>NativeInputManager<span style="color:#f92672">*&gt;</span>(ptr);

    status_t result <span style="color:#f92672">=</span> im<span style="color:#f92672">-&gt;</span>getInputManager()<span style="color:#f92672">-&gt;</span>start();
}
</code></pre></div><h3 id="nativeregisterinputchannel">nativeRegisterInputChannel</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">nativeRegisterInputChannel</span>(JNIEnv<span style="color:#f92672">*</span> env, jclass <span style="color:#75715e">/* clazz */</span>,
        jlong ptr, jobject inputChannelObj, jobject inputWindowHandleObj, jboolean monitor) {
    NativeInputManager<span style="color:#f92672">*</span> im <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>NativeInputManager<span style="color:#f92672">*&gt;</span>(ptr);
      status_t status <span style="color:#f92672">=</span> im<span style="color:#f92672">-&gt;</span>registerInputChannel(
            env, inputChannel, inputWindowHandle, monitor);
}
</code></pre></div><p>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp</p>
<h2 id="nativeinputmanager">NativeInputManager</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">NativeInputManager:<span style="color:#f92672">:</span>NativeInputManager<span style="color:#f92672">(</span>jobject contextObj<span style="color:#f92672">,</span>
        jobject serviceObj<span style="color:#f92672">,</span> <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>Looper<span style="color:#f92672">&gt;&amp;</span> looper<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
        mLooper<span style="color:#f92672">(</span>looper<span style="color:#f92672">),</span> mInteractive<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    sp<span style="color:#f92672">&lt;</span>EventHub<span style="color:#f92672">&gt;</span> eventHub <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EventHub<span style="color:#f92672">();</span>
    mInputManager <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputManager<span style="color:#f92672">(</span>eventHub<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="registerinputchannel-1">registerInputChannel</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t NativeInputManager<span style="color:#f92672">::</span>registerInputChannel(JNIEnv<span style="color:#f92672">*</span> <span style="color:#75715e">/* env */</span>,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputChannel<span style="color:#f92672">&gt;&amp;</span> inputChannel,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputWindowHandle<span style="color:#f92672">&gt;&amp;</span> inputWindowHandle, <span style="color:#66d9ef">bool</span> monitor) {
    ATRACE_CALL();
    <span style="color:#66d9ef">return</span> mInputManager<span style="color:#f92672">-&gt;</span>getDispatcher()<span style="color:#f92672">-&gt;</span>registerInputChannel(
            inputChannel, inputWindowHandle, monitor);
}
</code></pre></div><p>frameworks/native/services/inputflinger/InputManager.cpp</p>
<h2 id="inputmanager">InputManager</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">InputManager<span style="color:#f92672">::</span>InputManager(
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>EventHubInterface<span style="color:#f92672">&gt;&amp;</span> eventHub,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputReaderPolicyInterface<span style="color:#f92672">&gt;&amp;</span> readerPolicy,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputDispatcherPolicyInterface<span style="color:#f92672">&gt;&amp;</span> dispatcherPolicy) {
    mDispatcher <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputDispatcher(dispatcherPolicy);
    mReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputReader(eventHub, readerPolicy, mDispatcher);
    initialize();
}
</code></pre></div><h3 id="initialize">initialize</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> InputManager<span style="color:#f92672">::</span>initialize() {
    mReaderThread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputReaderThread(mReader);
    mDispatcherThread <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputDispatcherThread(mDispatcher);
}
</code></pre></div><h3 id="start-1">start</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t InputManager<span style="color:#f92672">::</span>start() {
    status_t result <span style="color:#f92672">=</span> mDispatcherThread<span style="color:#f92672">-&gt;</span>run(<span style="color:#e6db74">&#34;InputDispatcher&#34;</span>, PRIORITY_URGENT_DISPLAY);
    result <span style="color:#f92672">=</span> mReaderThread<span style="color:#f92672">-&gt;</span>run(<span style="color:#e6db74">&#34;InputReader&#34;</span>, PRIORITY_URGENT_DISPLAY);
    <span style="color:#66d9ef">return</span> OK;
}
</code></pre></div><p>frameworks/native/services/inputflinger/EventHub.cpp</p>
<h2 id="eventhub">EventHub</h2>
<h3 id="eventhub-1">EventHub</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">EventHub<span style="color:#f92672">::</span>EventHub(<span style="color:#66d9ef">void</span>) <span style="color:#f92672">:</span> {
     mEpollFd <span style="color:#f92672">=</span> epoll_create(EPOLL_SIZE_HINT);

    mINotifyFd <span style="color:#f92672">=</span> inotify_init();
    <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> inotify_add_watch(mINotifyFd, DEVICE_PATH, IN_DELETE <span style="color:#f92672">|</span> IN_CREATE);

    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">epoll_event</span> eventItem;
    memset(<span style="color:#f92672">&amp;</span>eventItem, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(eventItem));
    eventItem.events <span style="color:#f92672">=</span> EPOLLIN;
    eventItem.data.u32 <span style="color:#f92672">=</span> EPOLL_ID_INOTIFY;
    result <span style="color:#f92672">=</span> epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mINotifyFd, <span style="color:#f92672">&amp;</span>eventItem);
    
    <span style="color:#66d9ef">int</span> wakeFds[<span style="color:#ae81ff">2</span>];
    result <span style="color:#f92672">=</span> pipe(wakeFds);

    mWakeReadPipeFd <span style="color:#f92672">=</span> wakeFds[<span style="color:#ae81ff">0</span>];
    mWakeWritePipeFd <span style="color:#f92672">=</span> wakeFds[<span style="color:#ae81ff">1</span>];

    result <span style="color:#f92672">=</span> fcntl(mWakeReadPipeFd, F_SETFL, O_NONBLOCK);
    result <span style="color:#f92672">=</span> fcntl(mWakeWritePipeFd, F_SETFL, O_NONBLOCK);

    eventItem.data.u32 <span style="color:#f92672">=</span> EPOLL_ID_WAKE;
    result <span style="color:#f92672">=</span> epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mWakeReadPipeFd, <span style="color:#f92672">&amp;</span>eventItem);
}
</code></pre></div><h3 id="getevents">getEvents</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">size_t EventHub<span style="color:#f92672">::</span>getEvents(<span style="color:#66d9ef">int</span> timeoutMillis, RawEvent<span style="color:#f92672">*</span> buffer, size_t bufferSize) {
        <span style="color:#66d9ef">for</span> (;;) {
         <span style="color:#75715e">// Grab the next input event.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span> deviceChanged <span style="color:#f92672">=</span> false;
        <span style="color:#66d9ef">while</span> (mPendingEventIndex <span style="color:#f92672">&lt;</span> mPendingEventCount) {
            <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">epoll_event</span><span style="color:#f92672">&amp;</span> eventItem <span style="color:#f92672">=</span> mPendingEventItems[mPendingEventIndex<span style="color:#f92672">++</span>];
            <span style="color:#66d9ef">if</span> (eventItem.data.u32 <span style="color:#f92672">==</span> EPOLL_ID_INOTIFY) {
                <span style="color:#66d9ef">if</span> (eventItem.events <span style="color:#f92672">&amp;</span> EPOLLIN) {
                    mPendingINotify <span style="color:#f92672">=</span> true;
                }
                <span style="color:#66d9ef">continue</span>;
            }
            ......
           <span style="color:#66d9ef">if</span> (mPendingINotify <span style="color:#f92672">&amp;&amp;</span> mPendingEventIndex <span style="color:#f92672">&gt;=</span> mPendingEventCount) {
            mPendingINotify <span style="color:#f92672">=</span> false;
            readNotifyLocked();
           }
        }
        <span style="color:#66d9ef">int</span> pollResult <span style="color:#f92672">=</span> epoll_wait(mEpollFd, mPendingEventItems, EPOLL_MAX_EVENTS, timeoutMillis);
        }
</code></pre></div><h3 id="readnotifylocked">readNotifyLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t EventHub<span style="color:#f92672">::</span>readNotifyLocked() {
    res <span style="color:#f92672">=</span> read(mINotifyFd, event_buf, <span style="color:#66d9ef">sizeof</span>(event_buf));
}
</code></pre></div><p>frameworks/native/services/inputflinger/InputReader.cpp</p>
<h2 id="inputreaderthread">InputReaderThread</h2>
<h3 id="threadloop">threadLoop</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">bool</span> InputReaderThread<span style="color:#f92672">::</span>threadLoop() {
    mReader<span style="color:#f92672">-&gt;</span>loopOnce();
    <span style="color:#66d9ef">return</span> true;
}
</code></pre></div><p>frameworks/native/services/inputflinger/InputReader.cpp</p>
<h2 id="inputreader">InputReader</h2>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative.assets/input_reader_seq.jpg" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">InputReader<span style="color:#f92672">::</span>InputReader(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>EventHubInterface<span style="color:#f92672">&gt;&amp;</span> eventHub,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputReaderPolicyInterface<span style="color:#f92672">&gt;&amp;</span> policy,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputListenerInterface<span style="color:#f92672">&gt;&amp;</span> listener) <span style="color:#f92672">:</span>
        mContext(<span style="color:#66d9ef">this</span>), mEventHub(eventHub), mPolicy(policy), {
    mQueuedListener <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> QueuedInputListener(listener);
 }
</code></pre></div><h3 id="threadloop-1">threadLoop</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">bool</span> InputReaderThread<span style="color:#f92672">::</span>threadLoop() {
    mReader<span style="color:#f92672">-&gt;</span>loopOnce();
    <span style="color:#66d9ef">return</span> true;
}
</code></pre></div><h3 id="looponce">loopOnce</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> InputReader<span style="color:#f92672">::</span>loopOnce() {
  size_t count <span style="color:#f92672">=</span> mEventHub<span style="color:#f92672">-&gt;</span>getEvents(timeoutMillis, mEventBuffer, EVENT_BUFFER_SIZE);
        <span style="color:#66d9ef">if</span> (count) {
            processEventsLocked(mEventBuffer, count);
        }
    <span style="color:#75715e">// Flush queued events out to the listener.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// This must happen outside of the lock because the listener could potentially call
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// back into the InputReader&#39;s methods, such as getScanCodeState, or become blocked
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// on another thread similarly waiting to acquire the InputReader lock thereby
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// resulting in a deadlock.  This situation is actually quite plausible because the
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// listener is actually the input dispatcher, which calls into the window manager,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// which occasionally calls into the input reader.
</span><span style="color:#75715e"></span>    mQueuedListener<span style="color:#f92672">-&gt;</span>flush();
}
</code></pre></div><p><a href="#getevents">getevents</a></p>
<p><a href="#flush">flush</a></p>
<p>frameworks/native/services/inputflinger/InputListener.cpp</p>
<h2 id="queuedinputlistener">QueuedInputListener</h2>
<h3 id="flush">flush</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> QueuedInputListener<span style="color:#f92672">::</span>flush() {
    size_t count <span style="color:#f92672">=</span> mArgsQueue.size();
    <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">++</span>) {
        NotifyArgs<span style="color:#f92672">*</span> args <span style="color:#f92672">=</span> mArgsQueue[i];
        args<span style="color:#f92672">-&gt;</span>notify(mInnerListener);
        <span style="color:#66d9ef">delete</span> args;
    }
    mArgsQueue.clear();
}
</code></pre></div><h2 id="notifymotionargs">NotifyMotionArgs</h2>
<h3 id="notify">notify</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> NotifyMotionArgs<span style="color:#f92672">::</span>notify(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputListenerInterface<span style="color:#f92672">&gt;&amp;</span> listener) <span style="color:#66d9ef">const</span> {
    listener<span style="color:#f92672">-&gt;</span>notifyMotion(<span style="color:#66d9ef">this</span>);
}
</code></pre></div><p><a href="#notifymotion">notifymotion</a></p>
<p>frameworks/native/services/inputflinger/InputDispatcher.cpp</p>
<h2 id="inputdispatcher">InputDispatcher</h2>
<h3 id="threadloop-2">threadLoop</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">bool</span> InputDispatcherThread<span style="color:#f92672">::</span>threadLoop() {
    mDispatcher<span style="color:#f92672">-&gt;</span>dispatchOnce();
    <span style="color:#66d9ef">return</span> true;
}
</code></pre></div><h3 id="dispatchonce">dispatchOnce</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> InputDispatcher<span style="color:#f92672">::</span>dispatchOnce() {
  
        <span style="color:#75715e">// Run a dispatch loop if there are no pending commands.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// The dispatch loop might enqueue commands to run afterwards.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>haveCommandsLocked()) {
            dispatchOnceInnerLocked(<span style="color:#f92672">&amp;</span>nextWakeupTime);
        }
  
    <span style="color:#75715e">// Wait for callback or timeout or wake.  (make sure we round up, not down)
</span><span style="color:#75715e"></span>    nsecs_t currentTime <span style="color:#f92672">=</span> now();
    <span style="color:#66d9ef">int</span> timeoutMillis <span style="color:#f92672">=</span> toMillisecondTimeoutDelay(currentTime, nextWakeupTime);
    mLooper<span style="color:#f92672">-&gt;</span>pollOnce(timeoutMillis);<span style="color:#75715e">//registerInputChannel时通过Looper.wake()唤醒线程
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="notifymotion">notifyMotion</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> InputDispatcher<span style="color:#f92672">::</span>notifyMotion(<span style="color:#66d9ef">const</span> NotifyMotionArgs<span style="color:#f92672">*</span> args) { 
    <span style="color:#66d9ef">if</span> (needWake) {
        mLooper<span style="color:#f92672">-&gt;</span>wake();
    }
}
</code></pre></div><h3 id="dispatchonceinnerlocked">dispatchOnceInnerLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">void</span> InputDispatcher<span style="color:#f92672">::</span>dispatchOnceInnerLocked<span style="color:#f92672">(</span>nsecs_t<span style="color:#f92672">*</span> nextWakeupTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">case</span> EventEntry<span style="color:#f92672">::</span>TYPE_MOTION<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
        MotionEntry<span style="color:#f92672">*</span> typedEntry <span style="color:#f92672">=</span> static_cast<span style="color:#f92672">&lt;</span>MotionEntry<span style="color:#f92672">*&gt;(</span>mPendingEvent<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dropReason <span style="color:#f92672">==</span> DROP_REASON_NOT_DROPPED <span style="color:#f92672">&amp;&amp;</span> isAppSwitchDue<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            dropReason <span style="color:#f92672">=</span> DROP_REASON_APP_SWITCH<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dropReason <span style="color:#f92672">==</span> DROP_REASON_NOT_DROPPED
                <span style="color:#f92672">&amp;&amp;</span> isStaleEventLocked<span style="color:#f92672">(</span>currentTime<span style="color:#f92672">,</span> typedEntry<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            dropReason <span style="color:#f92672">=</span> DROP_REASON_STALE<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dropReason <span style="color:#f92672">==</span> DROP_REASON_NOT_DROPPED <span style="color:#f92672">&amp;&amp;</span> mNextUnblockedEvent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            dropReason <span style="color:#f92672">=</span> DROP_REASON_BLOCKED<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        done <span style="color:#f92672">=</span> dispatchMotionLocked<span style="color:#f92672">(</span>currentTime<span style="color:#f92672">,</span> typedEntry<span style="color:#f92672">,</span>
                <span style="color:#f92672">&amp;</span>dropReason<span style="color:#f92672">,</span> nextWakeupTime<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="dispatchmotionlocked">dispatchMotionLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">bool InputDispatcher<span style="color:#f92672">::</span>dispatchMotionLocked<span style="color:#f92672">(</span>
        nsecs_t currentTime<span style="color:#f92672">,</span> MotionEntry<span style="color:#f92672">*</span> entry<span style="color:#f92672">,</span> DropReason<span style="color:#f92672">*</span> dropReason<span style="color:#f92672">,</span> nsecs_t<span style="color:#f92672">*</span> nextWakeupTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    dispatchEventLocked<span style="color:#f92672">(</span>currentTime<span style="color:#f92672">,</span> entry<span style="color:#f92672">,</span> inputTargets<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="dispatcheventlocked">dispatchEventLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> InputDispatcher<span style="color:#f92672">::</span>dispatchEventLocked(nsecs_t currentTime,
        EventEntry<span style="color:#f92672">*</span> eventEntry, <span style="color:#66d9ef">const</span> Vector<span style="color:#f92672">&lt;</span>InputTarget<span style="color:#f92672">&gt;&amp;</span> inputTargets) {
      <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> inputTargets.size(); i<span style="color:#f92672">++</span>) {
        <span style="color:#66d9ef">const</span> InputTarget<span style="color:#f92672">&amp;</span> inputTarget <span style="color:#f92672">=</span> inputTargets.itemAt(i);

        ssize_t connectionIndex <span style="color:#f92672">=</span> getConnectionIndexLocked(inputTarget.inputChannel);
        <span style="color:#66d9ef">if</span> (connectionIndex <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) {
            sp<span style="color:#f92672">&lt;</span>Connection<span style="color:#f92672">&gt;</span> connection <span style="color:#f92672">=</span> mConnectionsByFd.valueAt(connectionIndex);
            prepareDispatchCycleLocked(currentTime, connection, eventEntry, <span style="color:#f92672">&amp;</span>inputTarget);
        } 
}
</code></pre></div><h3 id="preparedispatchcyclelocked">prepareDispatchCycleLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> InputDispatcher<span style="color:#f92672">::</span>prepareDispatchCycleLocked(nsecs_t currentTime,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>Connection<span style="color:#f92672">&gt;&amp;</span> connection, EventEntry<span style="color:#f92672">*</span> eventEntry, <span style="color:#66d9ef">const</span> InputTarget<span style="color:#f92672">*</span> inputTarget) {
                enqueueDispatchEntriesLocked(currentTime, connection, splitMotionEntry, inputTarget);
}
</code></pre></div><h3 id="enqueuedispatchentrieslocked">enqueueDispatchEntriesLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> InputDispatcher<span style="color:#f92672">::</span>enqueueDispatchEntriesLocked(nsecs_t currentTime,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>Connection<span style="color:#f92672">&gt;&amp;</span> connection, EventEntry<span style="color:#f92672">*</span> eventEntry, <span style="color:#66d9ef">const</span> InputTarget<span style="color:#f92672">*</span> inputTarget) {
    <span style="color:#66d9ef">bool</span> wasEmpty <span style="color:#f92672">=</span> connection<span style="color:#f92672">-&gt;</span>outboundQueue.isEmpty();
    ......

    <span style="color:#75715e">// If the outbound queue was previously empty, start the dispatch cycle going.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (wasEmpty <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>connection<span style="color:#f92672">-&gt;</span>outboundQueue.isEmpty()) {
        startDispatchCycleLocked(currentTime, connection);
    }
}
</code></pre></div><h3 id="startdispatchcyclelocked">startDispatchCycleLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> InputDispatcher<span style="color:#f92672">::</span>startDispatchCycleLocked(nsecs_t currentTime,
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>Connection<span style="color:#f92672">&gt;&amp;</span> connection) {
  
          EventEntry<span style="color:#f92672">*</span> eventEntry <span style="color:#f92672">=</span> dispatchEntry<span style="color:#f92672">-&gt;</span>eventEntry;
        <span style="color:#66d9ef">switch</span> (eventEntry<span style="color:#f92672">-&gt;</span>type) {
        <span style="color:#66d9ef">case</span> EventEntry<span style="color:#f92672">::</span>TYPE_KEY: {
            KeyEntry<span style="color:#f92672">*</span> keyEntry <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>KeyEntry<span style="color:#f92672">*&gt;</span>(eventEntry);

            <span style="color:#75715e">// Publish the key event.
</span><span style="color:#75715e"></span>            status <span style="color:#f92672">=</span> connection<span style="color:#f92672">-&gt;</span>inputPublisher.publishKeyEvent(dispatchEntry<span style="color:#f92672">-&gt;</span>seq,
                    keyEntry<span style="color:#f92672">-&gt;</span>deviceId, keyEntry<span style="color:#f92672">-&gt;</span>source,
                    dispatchEntry<span style="color:#f92672">-&gt;</span>resolvedAction, dispatchEntry<span style="color:#f92672">-&gt;</span>resolvedFlags,
                    keyEntry<span style="color:#f92672">-&gt;</span>keyCode, keyEntry<span style="color:#f92672">-&gt;</span>scanCode,
                    keyEntry<span style="color:#f92672">-&gt;</span>metaState, keyEntry<span style="color:#f92672">-&gt;</span>repeatCount, keyEntry<span style="color:#f92672">-&gt;</span>downTime,
                    keyEntry<span style="color:#f92672">-&gt;</span>eventTime);
            <span style="color:#66d9ef">break</span>;
        }
            <span style="color:#66d9ef">case</span> EventEntry<span style="color:#f92672">::</span>TYPE_MOTION: {
                          <span style="color:#75715e">// Publish the motion event.
</span><span style="color:#75715e"></span>            status <span style="color:#f92672">=</span> connection<span style="color:#f92672">-&gt;</span>inputPublisher.publishMotionEvent(dispatchEntry<span style="color:#f92672">-&gt;</span>seq,
                    motionEntry<span style="color:#f92672">-&gt;</span>deviceId, motionEntry<span style="color:#f92672">-&gt;</span>source, motionEntry<span style="color:#f92672">-&gt;</span>displayId,
                    dispatchEntry<span style="color:#f92672">-&gt;</span>resolvedAction, motionEntry<span style="color:#f92672">-&gt;</span>actionButton,
                    dispatchEntry<span style="color:#f92672">-&gt;</span>resolvedFlags, motionEntry<span style="color:#f92672">-&gt;</span>edgeFlags,
                    motionEntry<span style="color:#f92672">-&gt;</span>metaState, motionEntry<span style="color:#f92672">-&gt;</span>buttonState,
                    xOffset, yOffset, motionEntry<span style="color:#f92672">-&gt;</span>xPrecision, motionEntry<span style="color:#f92672">-&gt;</span>yPrecision,
                    motionEntry<span style="color:#f92672">-&gt;</span>downTime, motionEntry<span style="color:#f92672">-&gt;</span>eventTime,
                    motionEntry<span style="color:#f92672">-&gt;</span>pointerCount, motionEntry<span style="color:#f92672">-&gt;</span>pointerProperties,
                    usingCoords);
            <span style="color:#66d9ef">break</span>;
            }
</code></pre></div><p><a href="#publishmotionevent">publishmotionevent</a></p>
<h3 id="handlereceivecallback">handleReceiveCallback</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> InputDispatcher<span style="color:#f92672">::</span>handleReceiveCallback(<span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> events, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> data) {
    InputDispatcher<span style="color:#f92672">*</span> d <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>InputDispatcher<span style="color:#f92672">*&gt;</span>(data);
    ssize_t connectionIndex <span style="color:#f92672">=</span> d<span style="color:#f92672">-&gt;</span>mConnectionsByFd.indexOfKey(fd);
        sp<span style="color:#f92672">&lt;</span>Connection<span style="color:#f92672">&gt;</span> connection <span style="color:#f92672">=</span> d<span style="color:#f92672">-&gt;</span>mConnectionsByFd.valueAt(connectionIndex);
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(events <span style="color:#f92672">&amp;</span> (ALOOPER_EVENT_ERROR <span style="color:#f92672">|</span> ALOOPER_EVENT_HANGUP))) {
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(events <span style="color:#f92672">&amp;</span> ALOOPER_EVENT_INPUT)) {<span style="color:#75715e">//仅仅对ALOOPER_EVENT_INPUT事件类型进行处理
</span><span style="color:#75715e"></span>                ALOGW(<span style="color:#e6db74">&#34;channel &#39;%s&#39; ~ Received spurious callback for unhandled poll event.  &#34;</span>
                        <span style="color:#e6db74">&#34;events=0x%x&#34;</span>, connection<span style="color:#f92672">-&gt;</span>getInputChannelName().c_str(), events);
                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
            }
            nsecs_t currentTime <span style="color:#f92672">=</span> now();
            <span style="color:#66d9ef">bool</span> gotOne <span style="color:#f92672">=</span> false;
            status_t status;
            <span style="color:#66d9ef">for</span> (;;) {
                <span style="color:#66d9ef">uint32_t</span> seq;
                <span style="color:#66d9ef">bool</span> handled;
                status <span style="color:#f92672">=</span> connection<span style="color:#f92672">-&gt;</span>inputPublisher.receiveFinishedSignal(<span style="color:#f92672">&amp;</span>seq, <span style="color:#f92672">&amp;</span>handled);
                <span style="color:#66d9ef">if</span> (status) {
                    <span style="color:#66d9ef">break</span>;
                }
                d<span style="color:#f92672">-&gt;</span>finishDispatchCycleLocked(currentTime, connection, seq, handled);
                gotOne <span style="color:#f92672">=</span> true;
            }
            <span style="color:#66d9ef">if</span> (gotOne) {
                d<span style="color:#f92672">-&gt;</span>runCommandsLockedInterruptible();
                <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> WOULD_BLOCK) {
                    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
                }
            }
        }
</code></pre></div><p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative.assets/input_dispatcher_seq.jpg" alt=""></p>
<ul>
<li>
<p><a href="http://gityuan.com/2016/12/11/input-reader/">Input系统—InputReader线程</a>：通过EventHub从/dev/input节点获取事件，转换成EventEntry事件加入到InputDispatcher的mInboundQueue。</p>
</li>
<li>
<p><a href="http://gityuan.com/2016/12/17/input-dispatcher/">Input系统—InputDispatcher线程</a>：从mInboundQueue队列取出事件，转换成DispatchEntry事件加入到connection的outboundQueue队列。再然后开始处理分发事件，取出outbound队列，放入waitQueue.</p>
</li>
<li>
<p>Input系统—UI线程</p>
<p>：创建socket pair，分别位于”InputDispatcher”线程和focused窗口所在进程的UI主线程，可相互通信。</p>
<ul>
<li>UI主线程：通过setFdEvents()， 监听socket客户端，收到消息后回调NativeInputEventReceiver();【见小节2.1】</li>
<li>“InputDispatcher”线程： 通过IMS.registerInputChannel()，监听socket服务端，收到消息后回调handleReceiveCallback；【见小节3.1】</li>
</ul>
</li>
</ul>
<p>前面文章都是介绍了两个线程InputReader和InputDispatcher的工作过程。在InputDispatcher的过程讲到 调用InputChanel通过socket与远程进程通信，本文便展开讲解这个socket是如何建立的。</p>
<p>对于InputReader和InputDispatcher都是运行在system_server进程； 用户点击的界面往往可能是某一个app，而每个app一般地都运行在自己的进程，这里就涉及到跨进程通信，app进程是如何与system进程建立通信。</p>
<p>frameworks/native/libs/input/InputTransport.cpp</p>
<h2 id="inputpublisher">InputPublisher</h2>
<h3 id="publishmotionevent">publishMotionEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t InputPublisher<span style="color:#f92672">::</span>publishMotionEvent(
        <span style="color:#66d9ef">uint32_t</span> seq,...... {
      <span style="color:#66d9ef">return</span> mChannel<span style="color:#f92672">-&gt;</span>sendMessage(<span style="color:#f92672">&amp;</span>msg);
}
</code></pre></div><h2 id="inputconsumer">InputConsumer</h2>
<h3 id="sendfinishedsignal">sendFinishedSignal</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t InputConsumer<span style="color:#f92672">::</span>sendFinishedSignal(<span style="color:#66d9ef">uint32_t</span> seq, <span style="color:#66d9ef">bool</span> handled) {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sendUnchainedFinishedSignal</span>(seq, handled);
}
</code></pre></div><h3 id="sendunchainedfinishedsignal">sendUnchainedFinishedSignal</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t InputConsumer<span style="color:#f92672">::</span>sendUnchainedFinishedSignal(<span style="color:#66d9ef">uint32_t</span> seq, <span style="color:#66d9ef">bool</span> handled) {
    InputMessage msg;
    msg.header.type <span style="color:#f92672">=</span> InputMessage<span style="color:#f92672">::</span>TYPE_FINISHED;
    msg.body.finished.seq <span style="color:#f92672">=</span> seq;
    msg.body.finished.handled <span style="color:#f92672">=</span> handled;
    <span style="color:#66d9ef">return</span> mChannel<span style="color:#f92672">-&gt;</span>sendMessage(<span style="color:#f92672">&amp;</span>msg);
}
</code></pre></div><h2 id="inputchannel两个socket实现双向监听">InputChannel(两个Socket实现双向监听)</h2>
<h3 id="sendmessage">sendMessage</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t InputChannel<span style="color:#f92672">::</span>sendMessage(<span style="color:#66d9ef">const</span> InputMessage<span style="color:#f92672">*</span> msg) {
    size_t msgLength <span style="color:#f92672">=</span> msg<span style="color:#f92672">-&gt;</span>size();
    ssize_t nWrite;
    <span style="color:#66d9ef">do</span> {
        nWrite <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>send(mFd, msg, msgLength, MSG_DONTWAIT <span style="color:#f92672">|</span> MSG_NOSIGNAL);
    } <span style="color:#66d9ef">while</span> (nWrite <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> errno <span style="color:#f92672">==</span> EINTR);
</code></pre></div><h3 id="socketchannel-systemserver进程">Socket/Channel SystemServer进程</h3>
<p>[-&gt; WindowManagerService.java]</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">addWindow</span><span style="color:#f92672">(</span>Session session<span style="color:#f92672">,</span> IWindow client<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> seq<span style="color:#f92672">,</span> WindowManager<span style="color:#f92672">.</span><span style="color:#a6e22e">LayoutParams</span> attrs<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> viewVisibility<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> displayId<span style="color:#f92672">,</span> Rect outContentInsets<span style="color:#f92672">,</span> Rect outStableInsets<span style="color:#f92672">,</span> Rect outOutsets<span style="color:#f92672">,</span> InputChannel outInputChannel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

</code></pre></div><p>inputChannels数组：</p>
<ul>
<li>inputChannels[0]所对应的InputChannel名称的后缀为<code>(server)</code>;</li>
<li>inputChannels[1]所对应的InputChannel名称的后缀为<code>(client)</code>；</li>
</ul>
<p>其中：</p>
<ul>
<li>服务端inputChannels[0]保存到WindowState的mInputChannel；</li>
<li>客户端inputChannels[1]传递给outInputChannel，最终传递给ViewRootImpl的mInputChannel；</li>
</ul>
<p>[-&gt; InputTransport.cpp]</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">status_t InputChannel<span style="color:#f92672">::</span>openInputChannelPair<span style="color:#f92672">(</span><span style="color:#66d9ef">const</span> String8<span style="color:#f92672">&amp;</span> name<span style="color:#f92672">,</span>
        sp<span style="color:#f92672">&lt;</span>InputChannel<span style="color:#f92672">&gt;&amp;</span> outServerChannel<span style="color:#f92672">,</span> sp<span style="color:#f92672">&lt;</span>InputChannel<span style="color:#f92672">&gt;&amp;</span> outClientChannel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> sockets<span style="color:#f92672">[</span>2<span style="color:#f92672">];</span>
    <span style="color:#75715e">//真正创建socket对的地方【核心】
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>socketpair<span style="color:#f92672">(</span>AF_UNIX<span style="color:#f92672">,</span> SOCK_SEQPACKET<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> sockets<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">int</span> bufferSize <span style="color:#f92672">=</span> SOCKET_BUFFER_SIZE<span style="color:#f92672">;</span> <span style="color:#75715e">//32k
</span><span style="color:#75715e"></span>    setsockopt<span style="color:#f92672">(</span>sockets<span style="color:#f92672">[</span>0<span style="color:#f92672">],</span> SOL_SOCKET<span style="color:#f92672">,</span> SO_SNDBUF<span style="color:#f92672">,</span> <span style="color:#f92672">&amp;</span>bufferSize<span style="color:#f92672">,</span> sizeof<span style="color:#f92672">(</span>bufferSize<span style="color:#f92672">));</span>
    setsockopt<span style="color:#f92672">(</span>sockets<span style="color:#f92672">[</span>0<span style="color:#f92672">],</span> SOL_SOCKET<span style="color:#f92672">,</span> SO_RCVBUF<span style="color:#f92672">,</span> <span style="color:#f92672">&amp;</span>bufferSize<span style="color:#f92672">,</span> sizeof<span style="color:#f92672">(</span>bufferSize<span style="color:#f92672">));</span>
    setsockopt<span style="color:#f92672">(</span>sockets<span style="color:#f92672">[</span>1<span style="color:#f92672">],</span> SOL_SOCKET<span style="color:#f92672">,</span> SO_SNDBUF<span style="color:#f92672">,</span> <span style="color:#f92672">&amp;</span>bufferSize<span style="color:#f92672">,</span> sizeof<span style="color:#f92672">(</span>bufferSize<span style="color:#f92672">));</span>
    setsockopt<span style="color:#f92672">(</span>sockets<span style="color:#f92672">[</span>1<span style="color:#f92672">],</span> SOL_SOCKET<span style="color:#f92672">,</span> SO_RCVBUF<span style="color:#f92672">,</span> <span style="color:#f92672">&amp;</span>bufferSize<span style="color:#f92672">,</span> sizeof<span style="color:#f92672">(</span>bufferSize<span style="color:#f92672">));</span>

    String8 serverChannelName <span style="color:#f92672">=</span> name<span style="color:#f92672">;</span>
    serverChannelName<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34; (server)&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">//创建InputChannel对象
</span><span style="color:#75715e"></span>    outServerChannel <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputChannel<span style="color:#f92672">(</span>serverChannelName<span style="color:#f92672">,</span> sockets<span style="color:#f92672">[</span>0<span style="color:#f92672">]);</span>

    String8 clientChannelName <span style="color:#f92672">=</span> name<span style="color:#f92672">;</span>
    clientChannelName<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34; (client)&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">//创建InputChannel对象
</span><span style="color:#75715e"></span>    outClientChannel <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputChannel<span style="color:#f92672">(</span>clientChannelName<span style="color:#f92672">,</span> sockets<span style="color:#f92672">[</span>1<span style="color:#f92672">]);</span>
    <span style="color:#66d9ef">return</span> OK<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>该方法主要功能:</p>
<ol>
<li>创建socket pair; (<code>非阻塞式</code>的socket)</li>
<li>设置两个socket的接收和发送的buffer<code>上限为32KB</code>;</li>
<li>创建client和server的Native层InputChannel对象;
<ul>
<li>sockets[0]所对应的InputChannel名称的后缀为<code>(server)</code>;</li>
<li>sockets[1]所对应的InputChannel名称的后缀为<code>(client)</code></li>
</ul>
</li>
</ol>
<p>创建InputChannel对象位于文件InputTransport.cpp，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">InputChannel:<span style="color:#f92672">:</span>InputChannel<span style="color:#f92672">(</span><span style="color:#66d9ef">const</span> String8<span style="color:#f92672">&amp;</span> name<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> fd<span style="color:#f92672">)</span> <span style="color:#f92672">:</span>
        mName<span style="color:#f92672">(</span>name<span style="color:#f92672">),</span> mFd<span style="color:#f92672">(</span>fd<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//将socket设置成非阻塞方式
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> fcntl<span style="color:#f92672">(</span>mFd<span style="color:#f92672">,</span> F_SETFL<span style="color:#f92672">,</span> O_NONBLOCK<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>frameworks/native/services/inputflinger/InputDispatcher.cpp</p>
<h4 id="registerinputchannel-2">registerInputChannel</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">status_t InputDispatcher<span style="color:#f92672">::</span>registerInputChannel<span style="color:#f92672">(</span><span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputChannel<span style="color:#f92672">&gt;&amp;</span> inputChannel<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>InputWindowHandle<span style="color:#f92672">&gt;&amp;</span> inputWindowHandle<span style="color:#f92672">,</span> bool monitor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">{</span> 
        AutoMutex <span style="color:#a6e22e">_l</span><span style="color:#f92672">(</span>mLock<span style="color:#f92672">);</span>
        <span style="color:#f92672">...</span>
        
        <span style="color:#75715e">//创建Connection[见小节2.8.4]
</span><span style="color:#75715e"></span>        sp<span style="color:#f92672">&lt;</span>Connection<span style="color:#f92672">&gt;</span> connection <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Connection<span style="color:#f92672">(</span>inputChannel<span style="color:#f92672">,</span> inputWindowHandle<span style="color:#f92672">,</span> monitor<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> inputChannel<span style="color:#f92672">-&gt;</span>getFd<span style="color:#f92672">();</span><span style="color:#75715e">//fd为socket fd
</span><span style="color:#75715e"></span>        mConnectionsByFd<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>fd<span style="color:#f92672">,</span> connection<span style="color:#f92672">);</span>
        <span style="color:#f92672">...</span>
        <span style="color:#75715e">//将该fd添加到Looper监听[见小节2.8.5]
</span><span style="color:#75715e"></span>        mLooper<span style="color:#f92672">-&gt;</span>addFd<span style="color:#f92672">(</span>fd<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> ALOOPER_EVENT_INPUT<span style="color:#f92672">,</span> handleReceiveCallback<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    mLooper<span style="color:#f92672">-&gt;</span>wake<span style="color:#f92672">();</span> <span style="color:#75715e">//connection改变, 则唤醒looper
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> OK<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>将新创建的connection保存到mConnectionsByFd成员变量，“InputDispatcher”线程的Looper添加对socket服务端的监听功能； 当该socket有消息时便会唤醒该线程工作。</p>
<p>ViewRootImpl的setView()过程:</p>
<ul>
<li>创建socket pair，作为InputChannel:
<ul>
<li>socket服务端保存到system_server中的WindowState的mInputChannel；</li>
<li>socket客户端通过binder传回到远程进程的UI主线程ViewRootImpl的mInputChannel；</li>
</ul>
</li>
<li>IMS.registerInputChannel()注册InputChannel，监听socket服务端：
<ul>
<li>Loop便是“InputDispatcher”线程的Looper;</li>
<li>回调方法handleReceiveCallback。</li>
</ul>
</li>
</ul>
<h3 id="socketchannel-app进程">Socket/Channel app进程</h3>
<p>[-&gt; android_view_InputEventReceiver.cpp]</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> NativeInputEventReceiver<span style="color:#f92672">::</span>setFdEvents(<span style="color:#66d9ef">int</span> events) {
  <span style="color:#66d9ef">if</span> (mFdEvents <span style="color:#f92672">!=</span> events) {
      mFdEvents <span style="color:#f92672">=</span> events;
      <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> mInputConsumer.getChannel()<span style="color:#f92672">-&gt;</span>getFd();<span style="color:#75715e">//channel提供fd
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (events) {
          <span style="color:#75715e">//将socket客户端的fd添加到主线程的消息池【见小节3.6.1】
</span><span style="color:#75715e"></span>          mMessageQueue<span style="color:#f92672">-&gt;</span>getLooper()<span style="color:#f92672">-&gt;</span>addFd(fd, <span style="color:#ae81ff">0</span>, events, <span style="color:#66d9ef">this</span>, NULL);<span style="color:#75715e">//fd可读时触发本类的handleEvent回调
</span><span style="color:#75715e"></span>      } <span style="color:#66d9ef">else</span> {
          mMessageQueue<span style="color:#f92672">-&gt;</span>getLooper()<span style="color:#f92672">-&gt;</span>removeFd(fd);
      }
  }
}  
</code></pre></div><p>此处的Looper便是UI主线程的Looper，将socket客户端的fd添加到UI线程的Looper来监听，回调方法为NativeInputEventReceiver。</p>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative.assets/input_ui.jpg" alt=""></p>
<p>首先，通过openInputChannelPair来创建socket pair，作为InputChannel:</p>
<ul>
<li>socket服务端保存到system_server中的WindowState的mInputChannel；</li>
<li>socket客户端通过binder传回到远程进程的UI主线程ViewRootImpl的mInputChannel(inputChannel是binder调用的out参数)；</li>
</ul>
<p>紧接着，完成了两个线程的epoll监听工作：</p>
<ul>
<li>[小节2.8]IMS.registerInputChannel(): “InputDispatcher”线程监听socket服务端，收到消息后回调InputDispatcher.handleReceiveCallback()；</li>
<li>[小节3.6]setFdEvents(): UI主线程监听socket客户端，收到消息后回调NativeInputEventReceiver.handleEvent().</li>
</ul>
<p>system/core/libutils/Looper.cpp</p>
<h2 id="loopercpp">Looper.cpp</h2>
<h3 id="pollinner">pollInner</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> Looper<span style="color:#f92672">::</span>pollInner(<span style="color:#66d9ef">int</span> timeoutMillis) {
    <span style="color:#75715e">// Invoke all response callbacks.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> mResponses.size(); i<span style="color:#f92672">++</span>) {
    
             <span style="color:#75715e">// Invoke the callback.  Note that the file descriptor may be closed by
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the callback (and potentially even reused) before the function returns so
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// we need to be a little careful when removing the file descriptor afterwards.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> callbackResult <span style="color:#f92672">=</span> response.request.callback<span style="color:#f92672">-&gt;</span>handleEvent(fd, events, data);
    }
}
</code></pre></div><p>frameworks/base/core/jni/android_view_InputEventReceiver.cpp</p>
<h2 id="nativeinputeventreceiver">NativeInputEventReceiver</h2>
<h3 id="handleevent">handleEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> NativeInputEventReceiver<span style="color:#f92672">::</span>handleEvent(<span style="color:#66d9ef">int</span> receiveFd, <span style="color:#66d9ef">int</span> events, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> data) {
    
        <span style="color:#66d9ef">if</span> (events <span style="color:#f92672">&amp;</span> ALOOPER_EVENT_INPUT) {
        JNIEnv<span style="color:#f92672">*</span> env <span style="color:#f92672">=</span> AndroidRuntime<span style="color:#f92672">::</span>getJNIEnv();
        status_t status <span style="color:#f92672">=</span> consumeEvents(env, false <span style="color:#75715e">/*consumeBatches*/</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL);
        mMessageQueue<span style="color:#f92672">-&gt;</span>raiseAndClearException(env, <span style="color:#e6db74">&#34;handleReceiveCallback&#34;</span>);
        <span style="color:#66d9ef">return</span> status <span style="color:#f92672">==</span> OK <span style="color:#f92672">||</span> status <span style="color:#f92672">==</span> NO_MEMORY <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
    }
}
</code></pre></div><h3 id="consumeevents">consumeEvents</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t NativeInputEventReceiver<span style="color:#f92672">::</span>consumeEvents(JNIEnv<span style="color:#f92672">*</span> env,
        <span style="color:#66d9ef">bool</span> consumeBatches, nsecs_t frameTime, <span style="color:#66d9ef">bool</span><span style="color:#f92672">*</span> outConsumedBatch) {
    
        <span style="color:#66d9ef">for</span> (;;) {
        <span style="color:#66d9ef">uint32_t</span> seq;
        InputEvent<span style="color:#f92672">*</span> inputEvent;
        <span style="color:#66d9ef">int32_t</span> displayId;
        status_t status <span style="color:#f92672">=</span> mInputConsumer.consume(<span style="color:#f92672">&amp;</span>mInputEventFactory,
                consumeBatches, frameTime, <span style="color:#f92672">&amp;</span>seq, <span style="color:#f92672">&amp;</span>inputEvent, <span style="color:#f92672">&amp;</span>displayId);
                    jobject inputEventObj;
            <span style="color:#66d9ef">switch</span> (inputEvent<span style="color:#f92672">-&gt;</span>getType()) {
            <span style="color:#66d9ef">case</span> AINPUT_EVENT_TYPE_KEY:
                <span style="color:#66d9ef">if</span> (kDebugDispatchCycle) {
                    ALOGD(<span style="color:#e6db74">&#34;channel &#39;%s&#39; ~ Received key event.&#34;</span>, getInputChannelName().c_str());
                }
                inputEventObj <span style="color:#f92672">=</span> android_view_KeyEvent_fromNative(env,
                        <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>KeyEvent<span style="color:#f92672">*&gt;</span>(inputEvent));
                <span style="color:#66d9ef">break</span>;

            <span style="color:#66d9ef">case</span> AINPUT_EVENT_TYPE_MOTION: {
                <span style="color:#66d9ef">if</span> (kDebugDispatchCycle) {
                    ALOGD(<span style="color:#e6db74">&#34;channel &#39;%s&#39; ~ Received motion event.&#34;</span>, getInputChannelName().c_str());
                }
                MotionEvent<span style="color:#f92672">*</span> motionEvent <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>MotionEvent<span style="color:#f92672">*&gt;</span>(inputEvent);
                <span style="color:#66d9ef">if</span> ((motionEvent<span style="color:#f92672">-&gt;</span>getAction() <span style="color:#f92672">&amp;</span> AMOTION_EVENT_ACTION_MOVE) <span style="color:#f92672">&amp;&amp;</span> outConsumedBatch) {
                    <span style="color:#f92672">*</span>outConsumedBatch <span style="color:#f92672">=</span> true;
                }
                inputEventObj <span style="color:#f92672">=</span> android_view_MotionEvent_obtainAsCopy(env, motionEvent);
                <span style="color:#66d9ef">break</span>;
            }

            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
                assert(false); <span style="color:#75715e">// InputConsumer should prevent this from ever happening
</span><span style="color:#75715e"></span>                inputEventObj <span style="color:#f92672">=</span> NULL;
            }
            
                <span style="color:#66d9ef">if</span> (inputEventObj) {
                env<span style="color:#f92672">-&gt;</span>CallVoidMethod(receiverObj.get(),
                        gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj,
                        displayId);
                }

</code></pre></div><h2 id="inputeventreceiver">InputEventReceiver</h2>
<h3 id="dispatchinputevent">dispatchInputEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">// Called from native code.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;unused&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchInputEvent</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> seq<span style="color:#f92672">,</span> InputEvent event<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> displayId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        mSeqMap<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>event<span style="color:#f92672">.</span><span style="color:#a6e22e">getSequenceNumber</span><span style="color:#f92672">(),</span> seq<span style="color:#f92672">);</span>
        onInputEvent<span style="color:#f92672">(</span>event<span style="color:#f92672">,</span> displayId<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="finishinputevent">finishInputEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">finishInputEvent</span><span style="color:#f92672">(</span>InputEvent event<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> handled<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
           nativeFinishInputEvent<span style="color:#f92672">(</span>mReceiverPtr<span style="color:#f92672">,</span> seq<span style="color:#f92672">,</span> handled<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><p>frameworks/base/core/jni/android_view_InputEventReceiver.cpp</p>
<h2 id="android_view_inputeventreceiver">android_view_InputEventReceiver</h2>
<h3 id="nativefinishinputevent">nativeFinishInputEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">nativeFinishInputEvent</span>(JNIEnv<span style="color:#f92672">*</span> env, jclass clazz, jlong receiverPtr,
        jint seq, jboolean handled) {
    sp<span style="color:#f92672">&lt;</span>NativeInputEventReceiver<span style="color:#f92672">&gt;</span> receiver <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>NativeInputEventReceiver<span style="color:#f92672">*&gt;</span>(receiverPtr);
    status_t status <span style="color:#f92672">=</span> receiver<span style="color:#f92672">-&gt;</span>finishInputEvent(seq, handled);
}
</code></pre></div><h3 id="finishinputevent-1">finishInputEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t NativeInputEventReceiver<span style="color:#f92672">::</span>finishInputEvent(<span style="color:#66d9ef">uint32_t</span> seq, <span style="color:#66d9ef">bool</span> handled) {
    status_t status <span style="color:#f92672">=</span> mInputConsumer.sendFinishedSignal(seq, handled);
}
</code></pre></div><p><a href="#sendfinishedsignal">sendfinishedsignal</a></p>
<h2 id="参考">参考</h2>
<p>&laquo;深入理解Android : 卷3 第五章 输入系统&raquo;</p>
<p><a href="http://gityuan.com/2016/12/31/input-ipc/">Input系统—事件处理全过程</a></p>
<p><a href="http://gityuan.com/2017/01/01/input-anr/">Input系统—ANR原理分析</a></p>


<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/" title="input"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/" title="zygote" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1611382862"></script>
    <script src="/js/perfect-scrollbar.min.js?1611382862"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1611382862"></script>
    <script src="/js/jquery.sticky.js?1611382862"></script>
    <script src="/js/featherlight.min.js?1611382862"></script>
    <script src="/js/highlight.pack.js?1611382862"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1611382862"></script>
    <script src="/js/learn.js?1611382862"></script>
    <script src="/js/hugo-learn.js?1611382862"></script>
    
        
            <script src="/mermaid/mermaid.js?1611382862"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

