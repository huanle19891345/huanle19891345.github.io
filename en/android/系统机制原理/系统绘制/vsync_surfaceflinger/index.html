<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="description" content="Documentation for Hugo Learn Theme">
<meta name="author" content="Mathieu Cornic">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Vsync_SurfaceFlinger :: 郑欢的学习总结</title>

    
    <link href="/css/nucleus.css?1611381690" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1611381690" rel="stylesheet">
    <link href="/css/hybrid.css?1611381690" rel="stylesheet">
    <link href="/css/featherlight.min.css?1611381690" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1611381690" rel="stylesheet">
    <link href="/css/auto-complete.css?1611381690" rel="stylesheet">
    <link href="/css/atom-one-dark.css?1611381690" rel="stylesheet">
    <link href="/css/theme.css?1611381690" rel="stylesheet">
    <link href="/css/hugo-theme.css?1611381690" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1611381690" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1611381690"></script>

    <script src="/js/auto_toc_scroll.js?1611381690"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/en'>
    <img src="/avatar.png" width="60px" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1611381690"></script>
<script type="text/javascript" src="/js/auto-complete.js?1611381690"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/huanle19891345.github.io\/\/en";
    
</script>
<script type="text/javascript" src="/js/search.js?1611381690"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/en/android/" title="android" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/">
          android
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/google/" title="google" class="dd-item
        
        
        
        ">
      <a href="/en/android/google/">
          google
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/google/supporttoandroidx/" title="supportToAndroidx" class="dd-item ">
        <a href="/en/android/google/supporttoandroidx/">
        supportToAndroidx
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/" title="系统机制原理" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/">
          系统机制原理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/" title="ashmem" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/">
          ashmem
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/" title="匿名共享内存Ashmem" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/">
        匿名共享内存Ashmem
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/" title="bitmap" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/">
          bitmap
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/" title="Bitmap" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/">
        Bitmap
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/" title="BitmapSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/">
        BitmapSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/" title="handler" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/">
          handler
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/" title="Looper" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/">
        Looper
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/" title="ThreadLocal" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/">
        ThreadLocal
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/" title="input" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/">
          input
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/" title="touchEventNative" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/">
        touchEventNative
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/" title="zygote" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/">
          zygote
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/" title="SystemServerSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/">
        SystemServerSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/" title="ZygoteSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/">
        ZygoteSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/" title="Zygote进程" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/">
        Zygote进程
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/" title="多进程" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">
          多进程
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/" title="binder" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/">
          binder
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/" title="BinderClient" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/">
        BinderClient
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/" title="BinderDeath" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/">
        BinderDeath
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/" title="BinderKernel" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/">
        BinderKernel
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/" title="BinderServer" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/">
        BinderServer
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/" title="BinderServiceManager" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/">
        BinderServiceManager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/" title="Binder原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/">
        Binder原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/" title="mmkv" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/">
          mmkv
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/" title="MMKV" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/">
        MMKV
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/" title="系统绘制" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/">
          系统绘制
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/" title="Graphics" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/">
        Graphics
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/" title="Vsync" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/">
        Vsync
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/" title="Vsync_SurfaceFlinger" class="dd-item active">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/">
        Vsync_SurfaceFlinger
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/" title="硬件加速绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/">
        硬件加速绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/" title="绘制原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/">
        绘制原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/" title="软件绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/">
        软件绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" title="跨平台" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">
          跨平台
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/" title="flutter" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/">
          flutter
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/" title="通信" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/">
          通信
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" title="Flutter消息机制" class="dd-item ">
        <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/">
        Flutter消息机制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/huanle19891345"><i class='fab fa-fw fa-github'></i> GitHub repo</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/showcase"><i class='fas fa-fw fa-camera'></i> Showcases</a>
              </li>
          
              <li>
                  <a class="padding" href="https://gohugo.io/"><i class='fas fa-fw fa-bookmark'></i> Hugo Documentation</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/credits"><i class='fas fa-fw fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/en/'>技术探索总结</a> > <a href='/en/android/'>android</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/'>系统机制原理</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/'>系统绘制</a> > Vsync_SurfaceFlinger
          
        
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#surfaceflinger类设计">SurfaceFlinger类设计</a></li>
    <li><a href="#initrc">init.rc</a></li>
    <li><a href="#surfaceflingerrc">surfaceflinger.rc</a></li>
    <li><a href="#main_surfaceflingercpp">main_surfaceflinger.cpp</a>
      <ul>
        <li><a href="#main">main</a></li>
      </ul>
    </li>
    <li><a href="#surfaceflinger">SurfaceFlinger</a>
      <ul>
        <li><a href="#surfaceflinger-1">SurfaceFlinger</a></li>
        <li><a href="#onfirstref">onFirstRef</a></li>
        <li><a href="#init">init</a></li>
        <li><a href="#onvsyncreceived">onVsyncReceived</a></li>
        <li><a href="#disablehardwarevsync">disableHardwareVsync</a></li>
        <li><a href="#run">run</a></li>
        <li><a href="#waitforevent">waitForEvent</a></li>
        <li><a href="#onmessagereceived">onMessageReceived</a></li>
        <li><a href="#handlemessagerefresh">handleMessageRefresh</a></li>
        <li><a href="#createdisplayeventconnection">createDisplayEventConnection</a></li>
        <li><a href="#resyncwithratelimit">resyncWithRateLimit</a></li>
        <li><a href="#resynctohardwarevsync">resyncToHardwareVsync</a></li>
        <li><a href="#setvsyncenabled">setVsyncEnabled</a></li>
      </ul>
    </li>
    <li><a href="#vsyncsource">VsyncSource</a></li>
    <li><a href="#composercallbackbridge">ComposerCallbackBridge</a>
      <ul>
        <li><a href="#onvsync">onVsync</a></li>
      </ul>
    </li>
    <li><a href="#dispsyncsource">DispSyncSource</a>
      <ul>
        <li><a href="#ondispsyncevent">onDispSyncEvent</a></li>
      </ul>
    </li>
    <li><a href="#eventthread">EventThread</a>
      <ul>
        <li><a href="#eventthread-1">EventThread()</a></li>
        <li><a href="#threadmain">threadMain</a></li>
        <li><a href="#waitforeventlocked">waitForEventLocked</a></li>
        <li><a href="#onvsyncevent">onVSyncEvent</a></li>
        <li><a href="#connectionpostevent">Connection::postEvent</a></li>
        <li><a href="#createeventconnection">createEventConnection</a></li>
        <li><a href="#connectionstealreceivechannel">Connection::stealReceiveChannel</a></li>
        <li><a href="#connectionrequestnextvsync">Connection::requestNextVsync</a></li>
        <li><a href="#requestnextvsync">requestNextVsync</a></li>
      </ul>
    </li>
    <li><a href="#eventcontrolthread">EventControlThread</a>
      <ul>
        <li><a href="#setvsyncenabled-1">setVsyncEnabled</a></li>
        <li><a href="#threadmain-1">threadMain</a></li>
      </ul>
    </li>
    <li><a href="#displayeventreceiver">DisplayEventReceiver</a>
      <ul>
        <li><a href="#sendevents">sendEvents</a></li>
      </ul>
    </li>
    <li><a href="#bittube">BitTube</a>
      <ul>
        <li><a href="#bittube-1">BitTube()</a></li>
        <li><a href="#init-1">init</a></li>
        <li><a href="#sendobjects">sendObjects</a></li>
        <li><a href="#write">write</a></li>
        <li><a href="#recvobjects">recvObjects</a></li>
      </ul>
    </li>
    <li><a href="#dispsync">DispSync</a>
      <ul>
        <li><a href="#init-2">init</a></li>
        <li><a href="#addresyncsample">addResyncSample</a></li>
        <li><a href="#updatemodellocked">updateModelLocked</a></li>
      </ul>
    </li>
    <li><a href="#dispsyncthread">DispSyncThread</a>
      <ul>
        <li><a href="#threadloop">threadLoop</a></li>
        <li><a href="#gathercallbackinvocationslocked">gatherCallbackInvocationsLocked</a></li>
        <li><a href="#firecallbackinvocations">fireCallbackInvocations</a></li>
        <li><a href="#updatemodel">updateModel</a></li>
      </ul>
    </li>
    <li><a href="#messagequeue">MessageQueue</a>
      <ul>
        <li><a href="#init-3">init</a></li>
        <li><a href="#seteventthread">setEventThread</a></li>
        <li><a href="#waitmessage">waitMessage</a></li>
        <li><a href="#cb_eventreceiver">cb_eventReceiver</a></li>
        <li><a href="#eventreceiver">eventReceiver</a></li>
        <li><a href="#handlerdispatchinvalidate">Handler::dispatchInvalidate</a></li>
        <li><a href="#handlerhandlemessage">Handler::handleMessage</a></li>
      </ul>
    </li>
    <li><a href="#composercallback">ComposerCallback</a></li>
    <li><a href="#igraphicbufferproducercpp">IGraphicBufferProducer.cpp</a>
      <ul>
        <li><a href="#queuebuffer">queueBuffer</a></li>
        <li><a href="#ontransact">onTransact</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Vsync_SurfaceFlinger
            </h1>
          

        


<p><a href="https://juejin.im/post/6891980868798939150">Android-SurfaceFlinger启动与绘图原理</a></p>
<p>创建 HWComposer 对象(通过 HAL 层的 HWComposer 硬件模块 或 软件模拟产生 Vsync 信号)，<strong>现在的 Android 系统基本上都可以看成是通过硬件 HWComposer 产生 Vsync 信号，而不使用软件模拟，所以下面解析都只谈及硬件 HWComposer 的 Vsync 信号</strong>；</p>
<p>Choreographer 会通过上面创建的 APP 延时源 mEventThreadSource 对象及其对应的 EventThread 线程来监听同步模拟发出的 Vsync 信号，然后进行绘制(measure/layout/draw)操作。具体逻辑见 <a href="https://ljd1996.github.io/2020/09/07/Android-Choreographer%E5%8E%9F%E7%90%86/">Android-Choreographer原理</a>。</p>
<h2 id="surfaceflinger类设计">SurfaceFlinger类设计</h2>
<pre><code class="language-mermaid" data-lang="mermaid">graph TB
SurfaceFlinger--&gt;BnSurfaceComposer--&gt;BnInterface
BnSurfaceComposer--&gt;ISurfaceComposer
ISurfaceComposer--&gt;IInterface
BnInterface--&gt;BBinder--&gt;IBinder
</code></pre><p>system/core/rootdir/init.rc</p>
<h2 id="initrc">init.rc</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">on property:vold.decrypt<span style="color:#f92672">=</span>trigger_restart_framework
    stop surfaceflinger
    start surfaceflinger
    <span style="color:#75715e"># A/B update verifier that marks a successful boot.</span>
    exec_start update_verifier
    class_start main
    class_start late_start
</code></pre></div><p>frameworks/native/services/surfaceflinger/surfaceflinger.rc</p>
<h2 id="surfaceflingerrc">surfaceflinger.rc</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">service surfaceflinger /system/bin/surfaceflinger
    class core animation
    user system
    group graphics drmrpc readproc
    onrestart restart zygote
    writepid /dev/stune/foreground/tasks
    socket pdx/system/vr/display/client     stream <span style="color:#ae81ff">0666</span> system graphics u:object_r:pdx_display_client_endpoint_socket:s0
    socket pdx/system/vr/display/manager    stream <span style="color:#ae81ff">0666</span> system graphics u:object_r:pdx_display_manager_endpoint_socket:s0
    socket pdx/system/vr/display/vsync      stream <span style="color:#ae81ff">0666</span> system graphics u:object_r:pdx_display_vsync_endpoint_socket:s0
</code></pre></div><p>frameworks/native/services/surfaceflinger/main_surfaceflinger.cpp</p>
<h2 id="main_surfaceflingercpp">main_surfaceflinger.cpp</h2>
<h3 id="main">main</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span>) {
  
    <span style="color:#75715e">// When SF is launched in its own process, limit the number of
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// binder threads to 4.
</span><span style="color:#75715e"></span>    ProcessState<span style="color:#f92672">::</span>self()<span style="color:#f92672">-&gt;</span>setThreadPoolMaxThreadCount(<span style="color:#ae81ff">4</span>);
    <span style="color:#75715e">// start the thread pool
</span><span style="color:#75715e"></span>    sp<span style="color:#f92672">&lt;</span>ProcessState<span style="color:#f92672">&gt;</span> ps(ProcessState<span style="color:#f92672">::</span>self());
    ps<span style="color:#f92672">-&gt;</span>startThreadPool();
  
    <span style="color:#75715e">// instantiate surfaceflinger
</span><span style="color:#75715e"></span>    sp<span style="color:#f92672">&lt;</span>SurfaceFlinger<span style="color:#f92672">&gt;</span> flinger <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SurfaceFlinger();
    setpriority(PRIO_PROCESS, <span style="color:#ae81ff">0</span>, PRIORITY_URGENT_DISPLAY);
    set_sched_policy(<span style="color:#ae81ff">0</span>, SP_FOREGROUND);
  
    <span style="color:#75715e">// initialize before clients can connect
</span><span style="color:#75715e"></span>    flinger<span style="color:#f92672">-&gt;</span>init();
  
    <span style="color:#75715e">// publish surface flinger
</span><span style="color:#75715e"></span>    sp<span style="color:#f92672">&lt;</span>IServiceManager<span style="color:#f92672">&gt;</span> sm(defaultServiceManager());
    sm<span style="color:#f92672">-&gt;</span>addService(String16(SurfaceFlinger<span style="color:#f92672">::</span>getServiceName()), flinger, false,
                   IServiceManager<span style="color:#f92672">::</span>DUMP_FLAG_PRIORITY_CRITICAL);
  
    <span style="color:#75715e">// run surface flinger in this thread
</span><span style="color:#75715e"></span>    flinger<span style="color:#f92672">-&gt;</span>run();
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>frameworks/native/services/surfaceflinger/SurfaceFlinger.h</p>
<h2 id="surfaceflinger">SurfaceFlinger</h2>
<h3 id="surfaceflinger-1">SurfaceFlinger</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h">class SurfaceFlinger : public BnSurfaceComposer,
                       public PriorityDumper,
                       private IBinder<span style="color:#f92672">::</span>DeathRecipient,
                       private HWC2<span style="color:#f92672">::</span>ComposerCallback
{
    <span style="color:#75715e">// these are thread safe
</span><span style="color:#75715e"></span>    mutable std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">&gt;</span> mEventQueue{std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>impl<span style="color:#f92672">::</span>MessageQueue<span style="color:#f92672">&gt;</span>()};     
                         
    VSyncModulator mVsyncModulator;    

    DispSync mPrimaryDispSync;

    using CreateBufferQueueFunction <span style="color:#f92672">=</span>
            std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>(sp<span style="color:#f92672">&lt;</span>IGraphicBufferProducer<span style="color:#f92672">&gt;*</span> <span style="color:#75715e">/* outProducer */</span>,
                               sp<span style="color:#f92672">&lt;</span>IGraphicBufferConsumer<span style="color:#f92672">&gt;*</span> <span style="color:#75715e">/* outConsumer */</span>,
                               <span style="color:#66d9ef">bool</span> <span style="color:#75715e">/* consumerIsSurfaceFlinger */</span>)<span style="color:#f92672">&gt;</span>;
    CreateBufferQueueFunction mCreateBufferQueue;
                           
    using CreateNativeWindowSurfaceFunction <span style="color:#f92672">=</span>
            std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>NativeWindowSurface<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>IGraphicBufferProducer<span style="color:#f92672">&gt;&amp;</span>)<span style="color:#f92672">&gt;</span>;
    CreateNativeWindowSurfaceFunction mCreateNativeWindowSurface;
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">SurfaceFlinger<span style="color:#f92672">::</span>SurfaceFlinger(SurfaceFlinger<span style="color:#f92672">::</span>SkipInitializationTag)
      <span style="color:#f92672">:</span> BnSurfaceComposer(),
        Display(false),
        ......
        mMainThreadId(std<span style="color:#f92672">::</span>this_thread<span style="color:#f92672">::</span>get_id()),
        mCreateBufferQueue(<span style="color:#f92672">&amp;</span>BufferQueue<span style="color:#f92672">::</span>createBufferQueue),
        mCreateNativeWindowSurface(<span style="color:#f92672">&amp;</span>impl<span style="color:#f92672">::</span>NativeWindowSurface<span style="color:#f92672">::</span>create) {}
</code></pre></div><h3 id="onfirstref">onFirstRef</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>onFirstRef()
{
    mEventQueue<span style="color:#f92672">-&gt;</span>init(<span style="color:#66d9ef">this</span>);
}
</code></pre></div><h3 id="init">init</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>init() {
   <span style="color:#75715e">// start the EventThread
</span><span style="color:#75715e"></span>    mEventThreadSource <span style="color:#f92672">=</span>
            std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>DispSyncSource<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>mPrimaryDispSync, SurfaceFlinger<span style="color:#f92672">::</span>vsyncPhaseOffsetNs,
                                             true, <span style="color:#e6db74">&#34;app&#34;</span>);
    mEventThread <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>impl<span style="color:#f92672">::</span>EventThread<span style="color:#f92672">&gt;</span>(mEventThreadSource.get(),
                                                       [<span style="color:#66d9ef">this</span>]() { resyncWithRateLimit(); },
                                                       impl<span style="color:#f92672">::</span>EventThread<span style="color:#f92672">::</span>InterceptVSyncsCallback(),
                                                       <span style="color:#e6db74">&#34;appEventThread&#34;</span>);
    mSfEventThreadSource <span style="color:#f92672">=</span>
            std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>DispSyncSource<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>mPrimaryDispSync,
                                             SurfaceFlinger<span style="color:#f92672">::</span>sfVsyncPhaseOffsetNs, true, <span style="color:#e6db74">&#34;sf&#34;</span>);

    mSFEventThread <span style="color:#f92672">=</span>
            std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>impl<span style="color:#f92672">::</span>EventThread<span style="color:#f92672">&gt;</span>(mSfEventThreadSource.get(),
                                                [<span style="color:#66d9ef">this</span>]() { resyncWithRateLimit(); },
                                                [<span style="color:#66d9ef">this</span>](nsecs_t timestamp) {
                                                    mInterceptor<span style="color:#f92672">-&gt;</span>saveVSyncEvent(timestamp);
    mEventQueue<span style="color:#f92672">-&gt;</span>setEventThread(mSFEventThread.get());
    mVsyncModulator.setEventThread(mSFEventThread.get());
                                                    
    <span style="color:#75715e">// Get a RenderEngine for the given display / config (can&#39;t fail)
</span><span style="color:#75715e"></span>    getBE().mRenderEngine <span style="color:#f92672">=</span>
            RE<span style="color:#f92672">::</span>impl<span style="color:#f92672">::</span>RenderEngine<span style="color:#f92672">::</span>create(HAL_PIXEL_FORMAT_RGBA_8888,
                                           hasWideColorDisplay
                                                   <span style="color:#f92672">?</span> RE<span style="color:#f92672">::</span>RenderEngine<span style="color:#f92672">::</span>WIDE_COLOR_SUPPORT
                                                   : <span style="color:#ae81ff">0</span>);

    getBE().mHwc.reset(
            <span style="color:#66d9ef">new</span> HWComposer(std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>Hwc2<span style="color:#f92672">::</span>impl<span style="color:#f92672">::</span>Composer<span style="color:#f92672">&gt;</span>(getBE().mHwcServiceName)));
    getBE().mHwc<span style="color:#f92672">-&gt;</span>registerCallback(<span style="color:#66d9ef">this</span>, getBE().mComposerSequenceId);
                                                    
    mEventControlThread <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>impl<span style="color:#f92672">::</span>EventControlThread<span style="color:#f92672">&gt;</span>(
            [<span style="color:#66d9ef">this</span>](<span style="color:#66d9ef">bool</span> enabled) { setVsyncEnabled(HWC_DISPLAY_PRIMARY, enabled); });
                                                    
     <span style="color:#75715e">// set initial conditions (e.g. unblank default device)
</span><span style="color:#75715e"></span>    initializeDisplays();
}
</code></pre></div><h3 id="onvsyncreceived">onVsyncReceived</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>onVsyncReceived(<span style="color:#66d9ef">int32_t</span> sequenceId,
        hwc2_display_t displayId, <span style="color:#66d9ef">int64_t</span> timestamp) {
    Mutex<span style="color:#f92672">::</span>Autolock lock(mStateLock);
    <span style="color:#75715e">// Ignore any vsyncs from a previous hardware composer.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (sequenceId <span style="color:#f92672">!=</span> getBE().mComposerSequenceId) {
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">int32_t</span> type;
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>getBE().mHwc<span style="color:#f92672">-&gt;</span>onVsync(displayId, timestamp, <span style="color:#f92672">&amp;</span>type)) {
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">bool</span> needsHwVsync <span style="color:#f92672">=</span> false;

    { <span style="color:#75715e">// Scope for the lock
</span><span style="color:#75715e"></span>        Mutex<span style="color:#f92672">::</span>Autolock _l(mHWVsyncLock);
        <span style="color:#66d9ef">if</span> (type <span style="color:#f92672">==</span> DisplayDevice<span style="color:#f92672">::</span>DISPLAY_PRIMARY <span style="color:#f92672">&amp;&amp;</span> mPrimaryHWVsyncEnabled) {
            needsHwVsync <span style="color:#f92672">=</span> mPrimaryDispSync.addResyncSample(timestamp);
        }
    }

    <span style="color:#66d9ef">if</span> (needsHwVsync) {
        enableHardwareVsync();
    } <span style="color:#66d9ef">else</span> {
        disableHardwareVsync(false);
    }
}
</code></pre></div><h3 id="disablehardwarevsync">disableHardwareVsync</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>disableHardwareVsync(<span style="color:#66d9ef">bool</span> makeUnavailable) {
    Mutex<span style="color:#f92672">::</span>Autolock _l(mHWVsyncLock);
    <span style="color:#66d9ef">if</span> (mPrimaryHWVsyncEnabled) {
        <span style="color:#75715e">//eventControl(HWC_DISPLAY_PRIMARY, SurfaceFlinger::EVENT_VSYNC, false);
</span><span style="color:#75715e"></span>        mEventControlThread<span style="color:#f92672">-&gt;</span>setVsyncEnabled(false);
        mPrimaryDispSync.endResync();
        mPrimaryHWVsyncEnabled <span style="color:#f92672">=</span> false;
    }
    <span style="color:#66d9ef">if</span> (makeUnavailable) {
        mHWVsyncAvailable <span style="color:#f92672">=</span> false;
    }
}
</code></pre></div><h3 id="run">run</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>run() {
    <span style="color:#66d9ef">do</span> {
        waitForEvent();
    } <span style="color:#66d9ef">while</span> (true);
}
</code></pre></div><h3 id="waitforevent">waitForEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>waitForEvent() {
    mEventQueue<span style="color:#f92672">-&gt;</span>waitMessage();
}
</code></pre></div><h3 id="onmessagereceived">onMessageReceived</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>onMessageReceived(<span style="color:#66d9ef">int32_t</span> what) {
    <span style="color:#66d9ef">switch</span> (what) {
        <span style="color:#66d9ef">case</span> MessageQueue<span style="color:#f92672">::</span>INVALIDATE: {
            <span style="color:#66d9ef">bool</span> refreshNeeded <span style="color:#f92672">=</span> handleMessageTransaction();
            refreshNeeded <span style="color:#f92672">|=</span> handleMessageInvalidate();
            refreshNeeded <span style="color:#f92672">|=</span> mRepaintEverything;
            <span style="color:#66d9ef">if</span> (refreshNeeded) {
                <span style="color:#75715e">// Signal a refresh if a transaction modified the window state,
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// a new buffer was latched, or if HWC has requested a full
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// repaint
</span><span style="color:#75715e"></span>                signalRefresh();<span style="color:#75715e">//call handleMessageRefresh()
</span><span style="color:#75715e"></span>            }
            <span style="color:#66d9ef">break</span>;
        }
        <span style="color:#66d9ef">case</span> MessageQueue<span style="color:#f92672">::</span>REFRESH: {
            handleMessageRefresh();
            <span style="color:#66d9ef">break</span>;
        }
    }
}
</code></pre></div><h3 id="handlemessagerefresh">handleMessageRefresh</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>handleMessageRefresh() {
    ATRACE_CALL();

    mRefreshPending <span style="color:#f92672">=</span> false;

    nsecs_t refreshStartTime <span style="color:#f92672">=</span> systemTime(SYSTEM_TIME_MONOTONIC);

    preComposition(refreshStartTime);
    rebuildLayerStacks();
    setUpHWComposer();
    doDebugFlashRegions();
    doTracing(<span style="color:#e6db74">&#34;handleRefresh&#34;</span>);
    logLayerStats();
    doComposition();
    postComposition(refreshStartTime);

    mPreviousPresentFence <span style="color:#f92672">=</span> getBE().mHwc<span style="color:#f92672">-&gt;</span>getPresentFence(HWC_DISPLAY_PRIMARY);

    mHadClientComposition <span style="color:#f92672">=</span> false;
    <span style="color:#66d9ef">for</span> (size_t displayId <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; displayId <span style="color:#f92672">&lt;</span> mDisplays.size(); <span style="color:#f92672">++</span>displayId) {
        <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>DisplayDevice<span style="color:#f92672">&gt;&amp;</span> displayDevice <span style="color:#f92672">=</span> mDisplays[displayId];
        mHadClientComposition <span style="color:#f92672">=</span> mHadClientComposition <span style="color:#f92672">||</span>
                getBE().mHwc<span style="color:#f92672">-&gt;</span>hasClientComposition(displayDevice<span style="color:#f92672">-&gt;</span>getHwcDisplayId());
    }
    mVsyncModulator.onRefreshed(mHadClientComposition);

    mLayersWithQueuedFrames.clear();
}
</code></pre></div><h3 id="createdisplayeventconnection">createDisplayEventConnection</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#f92672">&lt;</span>IDisplayEventConnection<span style="color:#f92672">&gt;</span> SurfaceFlinger<span style="color:#f92672">::</span>createDisplayEventConnection(
        ISurfaceComposer<span style="color:#f92672">::</span>VsyncSource vsyncSource) {
    <span style="color:#66d9ef">if</span> (vsyncSource <span style="color:#f92672">==</span> eVsyncSourceSurfaceFlinger) {
        <span style="color:#66d9ef">return</span> mSFEventThread<span style="color:#f92672">-&gt;</span>createEventConnection();
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">return</span> mEventThread<span style="color:#f92672">-&gt;</span>createEventConnection();
    }
}
</code></pre></div><h3 id="resyncwithratelimit">resyncWithRateLimit</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>resyncWithRateLimit() {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">constexpr</span> nsecs_t kIgnoreDelay <span style="color:#f92672">=</span> ms2ns(<span style="color:#ae81ff">500</span>);

    <span style="color:#75715e">// No explicit locking is needed here since EventThread holds a lock while calling this method
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> nsecs_t sLastResyncAttempted <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">const</span> nsecs_t now <span style="color:#f92672">=</span> systemTime();
    <span style="color:#66d9ef">if</span> (now <span style="color:#f92672">-</span> sLastResyncAttempted <span style="color:#f92672">&gt;</span> kIgnoreDelay) {
        resyncToHardwareVsync(false);
    }
    sLastResyncAttempted <span style="color:#f92672">=</span> now;
}
</code></pre></div><h3 id="resynctohardwarevsync">resyncToHardwareVsync</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>resyncToHardwareVsync(<span style="color:#66d9ef">bool</span> makeAvailable) {
    Mutex<span style="color:#f92672">::</span>Autolock _l(mHWVsyncLock);

    <span style="color:#66d9ef">if</span> (makeAvailable) {
        mHWVsyncAvailable <span style="color:#f92672">=</span> true;
    } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#f92672">!</span>mHWVsyncAvailable) {
        <span style="color:#75715e">// Hardware vsync is not currently available, so abort the resync
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// attempt for now
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> activeConfig <span style="color:#f92672">=</span> getBE().mHwc<span style="color:#f92672">-&gt;</span>getActiveConfig(HWC_DISPLAY_PRIMARY);
    <span style="color:#66d9ef">const</span> nsecs_t period <span style="color:#f92672">=</span> activeConfig<span style="color:#f92672">-&gt;</span>getVsyncPeriod();

    mPrimaryDispSync.reset();
    mPrimaryDispSync.setPeriod(period);

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mPrimaryHWVsyncEnabled) {
        mPrimaryDispSync.beginResync();
        <span style="color:#75715e">//eventControl(HWC_DISPLAY_PRIMARY, SurfaceFlinger::EVENT_VSYNC, true);
</span><span style="color:#75715e"></span>        mEventControlThread<span style="color:#f92672">-&gt;</span>setVsyncEnabled(true);
        mPrimaryHWVsyncEnabled <span style="color:#f92672">=</span> true;
    }
}
</code></pre></div><h3 id="setvsyncenabled">setVsyncEnabled</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> SurfaceFlinger<span style="color:#f92672">::</span>setVsyncEnabled(<span style="color:#66d9ef">int</span> disp, <span style="color:#66d9ef">int</span> enabled) {
    getHwComposer().setVsyncEnabled(disp,
            enabled <span style="color:#f92672">?</span> HWC2<span style="color:#f92672">::</span>Vsync<span style="color:#f92672">::</span>Enable : HWC2<span style="color:#f92672">::</span>Vsync<span style="color:#f92672">::</span>Disable);
}
</code></pre></div><p>frameworks/native/libs/gui/include/gui/ISurfaceComposer.h</p>
<h2 id="vsyncsource">VsyncSource</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h">    <span style="color:#66d9ef">enum</span> VsyncSource {
        eVsyncSourceApp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
        eVsyncSourceSurfaceFlinger <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    };
</code></pre></div><h2 id="composercallbackbridge">ComposerCallbackBridge</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h"><span style="color:#f92672">:</span>IComposerCallback
ComposerCallback<span style="color:#f92672">*</span> mCallback;
</code></pre></div><h3 id="onvsync">onVsync</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Return<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span> onVsync(Hwc2<span style="color:#f92672">::</span>Display display, <span style="color:#66d9ef">int64_t</span> timestamp) <span style="color:#66d9ef">override</span>
{
mCallback<span style="color:#f92672">-&gt;</span>onVsyncReceived(mSequenceId, display, timestamp);
<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Void</span>();
}
</code></pre></div><p>frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp</p>
<h2 id="dispsyncsource">DispSyncSource</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    DispSync<span style="color:#f92672">*</span> mDispSync;

    Mutex mCallbackMutex; <span style="color:#75715e">// Protects the following
</span><span style="color:#75715e"></span>    VSyncSource<span style="color:#f92672">::</span>Callback<span style="color:#f92672">*</span> mCallback <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</code></pre></div><h3 id="ondispsyncevent">onDispSyncEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onDispSyncEvent</span>(nsecs_t when) {
        VSyncSource<span style="color:#f92672">::</span>Callback<span style="color:#f92672">*</span> callback;
        {
            Mutex<span style="color:#f92672">::</span>Autolock lock(mCallbackMutex);
            callback <span style="color:#f92672">=</span> mCallback;

            <span style="color:#66d9ef">if</span> (mTraceVsync) {
                mValue <span style="color:#f92672">=</span> (mValue <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span>;
                ATRACE_INT(mVsyncEventLabel.string(), mValue);
            }
        }

        <span style="color:#66d9ef">if</span> (callback <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
            callback<span style="color:#f92672">-&gt;</span>onVSyncEvent(when);
        }
    }
</code></pre></div><p>frameworks/native/services/surfaceflinger/EventThread.cpp</p>
<h2 id="eventthread">EventThread</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h">class EventThread : public android<span style="color:#f92672">::</span>EventThread, private VSyncSource<span style="color:#f92672">::</span>Callback {
    class Connection : public BnDisplayEventConnection {
    public:
        explicit Connection(EventThread<span style="color:#f92672">*</span> eventThread);
        virtual <span style="color:#f92672">~</span>Connection();

        virtual status_t <span style="color:#a6e22e">postEvent</span>(<span style="color:#66d9ef">const</span> DisplayEventReceiver<span style="color:#f92672">::</span>Event<span style="color:#f92672">&amp;</span> event);

        <span style="color:#75715e">// count &gt;= 1 : continuous event. count is the vsync rate
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// count == 0 : one-shot event that has not fired
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// count ==-1 : one-shot event that fired this round / disabled
</span><span style="color:#75715e"></span>        int32_t count;

    private:
        virtual <span style="color:#66d9ef">void</span> onFirstRef();
        status_t <span style="color:#a6e22e">stealReceiveChannel</span>(gui<span style="color:#f92672">::</span>BitTube<span style="color:#f92672">*</span> outChannel) override;
        status_t <span style="color:#a6e22e">setVsyncRate</span>(uint32_t count) override;
        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestNextVsync</span>() override; <span style="color:#75715e">// asynchronous
</span><span style="color:#75715e"></span>        EventThread<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> mEventThread;
        gui<span style="color:#f92672">::</span>BitTube mChannel;
    };
</code></pre></div><h3 id="eventthread-1">EventThread()</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">EventThread<span style="color:#f92672">::</span>EventThread(VSyncSource<span style="color:#f92672">*</span> src, ResyncWithRateLimitCallback resyncWithRateLimitCallback,
                         InterceptVSyncsCallback interceptVSyncsCallback, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> threadName)
      <span style="color:#f92672">:</span> mVSyncSource(src),
        mResyncWithRateLimitCallback(resyncWithRateLimitCallback),
        mInterceptVSyncsCallback(interceptVSyncsCallback) {
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> event : mVSyncEvent) {
        event.header.type <span style="color:#f92672">=</span> DisplayEventReceiver<span style="color:#f92672">::</span>DISPLAY_EVENT_VSYNC;
        event.header.id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        event.header.timestamp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        event.vsync.count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    mThread <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span>(<span style="color:#f92672">&amp;</span>EventThread<span style="color:#f92672">::</span>threadMain, <span style="color:#66d9ef">this</span>);

    pthread_setname_np(mThread.native_handle(), threadName);

    pid_t tid <span style="color:#f92672">=</span> pthread_gettid_np(mThread.native_handle());

    <span style="color:#75715e">// Use SCHED_FIFO to minimize jitter
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">int</span> EVENT_THREAD_PRIORITY <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sched_param</span> param <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
    param.sched_priority <span style="color:#f92672">=</span> EVENT_THREAD_PRIORITY;
    <span style="color:#66d9ef">if</span> (pthread_setschedparam(mThread.native_handle(), SCHED_FIFO, <span style="color:#f92672">&amp;</span>param) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
        ALOGE(<span style="color:#e6db74">&#34;Couldn&#39;t set SCHED_FIFO for EventThread&#34;</span>);
    }

    set_sched_policy(tid, SP_FOREGROUND);
}
</code></pre></div><h3 id="threadmain">threadMain</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> EventThread<span style="color:#f92672">::</span>threadMain() NO_THREAD_SAFETY_ANALYSIS {
    std<span style="color:#f92672">::</span>unique_lock<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock(mMutex);
    <span style="color:#66d9ef">while</span> (mKeepRunning) {
        DisplayEventReceiver<span style="color:#f92672">::</span>Event event;
        Vector<span style="color:#f92672">&lt;</span>sp<span style="color:#f92672">&lt;</span>EventThread<span style="color:#f92672">::</span>Connection<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;</span> signalConnections;
        signalConnections <span style="color:#f92672">=</span> waitForEventLocked(<span style="color:#f92672">&amp;</span>lock, <span style="color:#f92672">&amp;</span>event);

        <span style="color:#75715e">// dispatch events to listeners...
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> size_t count <span style="color:#f92672">=</span> signalConnections.size();
        <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">++</span>) {
            <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>Connection<span style="color:#f92672">&gt;&amp;</span> conn(signalConnections[i]);
            <span style="color:#75715e">// now see if we still need to report this event
</span><span style="color:#75715e"></span>            status_t err <span style="color:#f92672">=</span> conn<span style="color:#f92672">-&gt;</span>postEvent(event);
        }
    }
}
</code></pre></div><h3 id="waitforeventlocked">waitForEventLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// This will return when (1) a vsync event has been received, and (2) there was
</span><span style="color:#75715e">// at least one connection interested in receiving it when we started waiting.
</span><span style="color:#75715e"></span>Vector<span style="color:#f92672">&lt;</span>sp<span style="color:#f92672">&lt;</span>EventThread<span style="color:#f92672">::</span>Connection<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;</span> EventThread<span style="color:#f92672">::</span>waitForEventLocked(
        std<span style="color:#f92672">::</span>unique_lock<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;*</span> lock, DisplayEventReceiver<span style="color:#f92672">::</span>Event<span style="color:#f92672">*</span> event) {
    
   ......
          <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>timestamp <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>eventPending) {
            <span style="color:#75715e">// wait for something to happen
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (waitForVSync) {
                <span style="color:#75715e">// This is where we spend most of our time, waiting
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// for vsync events and new client registrations.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">//
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// If the screen is off, we can&#39;t use h/w vsync, so we
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// use a 16ms timeout instead.  It doesn&#39;t need to be
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// precise, we just need to keep feeding our clients.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">//
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// We don&#39;t want to stall if there&#39;s a driver bug, so we
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// use a (long) timeout when waiting for h/w vsync, and
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// generate fake events when necessary.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">bool</span> softwareSync <span style="color:#f92672">=</span> mUseSoftwareVSync;
                <span style="color:#66d9ef">auto</span> timeout <span style="color:#f92672">=</span> softwareSync <span style="color:#f92672">?</span> <span style="color:#ae81ff">16</span>ms : <span style="color:#ae81ff">1000</span>ms;
                <span style="color:#66d9ef">if</span> (mCondition.wait_for(<span style="color:#f92672">*</span>lock, timeout) <span style="color:#f92672">==</span> std<span style="color:#f92672">::</span>cv_status<span style="color:#f92672">::</span>timeout) {
                    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>softwareSync) {
                        ALOGW(<span style="color:#e6db74">&#34;Timed out waiting for hw vsync; faking it&#34;</span>);
                    }
                    <span style="color:#75715e">// FIXME: how do we decide which display id the fake
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">// vsync came from ?
</span><span style="color:#75715e"></span>                    mVSyncEvent[<span style="color:#ae81ff">0</span>].header.type <span style="color:#f92672">=</span> DisplayEventReceiver<span style="color:#f92672">::</span>DISPLAY_EVENT_VSYNC;
                    mVSyncEvent[<span style="color:#ae81ff">0</span>].header.id <span style="color:#f92672">=</span> DisplayDevice<span style="color:#f92672">::</span>DISPLAY_PRIMARY;
                    mVSyncEvent[<span style="color:#ae81ff">0</span>].header.timestamp <span style="color:#f92672">=</span> systemTime(SYSTEM_TIME_MONOTONIC);
                    mVSyncEvent[<span style="color:#ae81ff">0</span>].vsync.count<span style="color:#f92672">++</span>;
                }
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#75715e">// Nobody is interested in vsync, so we just want to sleep.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// h/w vsync should be disabled, so this will wait until we
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// get a new connection, or an existing connection becomes
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// interested in receiving vsync again.
</span><span style="color:#75715e"></span>                mCondition.wait(<span style="color:#f92672">*</span>lock);
            }
              
    <span style="color:#75715e">// here we&#39;re guaranteed to have a timestamp and some connections to signal
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// (The connections might have dropped out of mDisplayEventConnections
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// while we were asleep, but we&#39;ll still have strong references to them.)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> signalConnections;
}
</code></pre></div><h3 id="onvsyncevent">onVSyncEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> EventThread<span style="color:#f92672">::</span>onVSyncEvent(nsecs_t timestamp) {
    std<span style="color:#f92672">::</span>lock_guard<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock(mMutex);
    mVSyncEvent[<span style="color:#ae81ff">0</span>].header.type <span style="color:#f92672">=</span> DisplayEventReceiver<span style="color:#f92672">::</span>DISPLAY_EVENT_VSYNC;
    mVSyncEvent[<span style="color:#ae81ff">0</span>].header.id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    mVSyncEvent[<span style="color:#ae81ff">0</span>].header.timestamp <span style="color:#f92672">=</span> timestamp;
    mVSyncEvent[<span style="color:#ae81ff">0</span>].vsync.count<span style="color:#f92672">++</span>;
    mCondition.notify_all();<span style="color:#75715e">//唤醒EventThread线程
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="connectionpostevent">Connection::postEvent</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t EventThread<span style="color:#f92672">::</span>Connection<span style="color:#f92672">::</span>postEvent(<span style="color:#66d9ef">const</span> DisplayEventReceiver<span style="color:#f92672">::</span>Event<span style="color:#f92672">&amp;</span> event) {
    ssize_t size <span style="color:#f92672">=</span> DisplayEventReceiver<span style="color:#f92672">::</span>sendEvents(<span style="color:#f92672">&amp;</span>mChannel, <span style="color:#f92672">&amp;</span>event, <span style="color:#ae81ff">1</span>);
    <span style="color:#66d9ef">return</span> size <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> status_t(size) <span style="color:#f92672">:</span> status_t(NO_ERROR);
}
</code></pre></div><h3 id="createeventconnection">createEventConnection</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#f92672">&lt;</span>BnDisplayEventConnection<span style="color:#f92672">&gt;</span> EventThread<span style="color:#f92672">::</span>createEventConnection() <span style="color:#66d9ef">const</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Connection</span>(<span style="color:#66d9ef">const_cast</span><span style="color:#f92672">&lt;</span>EventThread<span style="color:#f92672">*&gt;</span>(<span style="color:#66d9ef">this</span>));
}
</code></pre></div><h3 id="connectionstealreceivechannel">Connection::stealReceiveChannel</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    <span style="color:#75715e">/*
</span><span style="color:#75715e">     * stealReceiveChannel() returns a BitTube to receive events from. Only the receive file
</span><span style="color:#75715e">     * descriptor of outChannel will be initialized, and this effectively &#34;steals&#34; the receive
</span><span style="color:#75715e">     * channel from the remote end (such that the remote end can only use its send channel).
</span><span style="color:#75715e">     */</span>
status_t EventThread<span style="color:#f92672">::</span>Connection<span style="color:#f92672">::</span>stealReceiveChannel(gui<span style="color:#f92672">::</span>BitTube<span style="color:#f92672">*</span> outChannel) {
    outChannel<span style="color:#f92672">-&gt;</span>setReceiveFd(mChannel.moveReceiveFd());
    <span style="color:#66d9ef">return</span> NO_ERROR;
}
</code></pre></div><h3 id="connectionrequestnextvsync">Connection::requestNextVsync</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> EventThread<span style="color:#f92672">::</span>Connection<span style="color:#f92672">::</span>requestNextVsync() {
    mEventThread<span style="color:#f92672">-&gt;</span>requestNextVsync(<span style="color:#66d9ef">this</span>);
}
</code></pre></div><h3 id="requestnextvsync">requestNextVsync</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> EventThread<span style="color:#f92672">::</span>requestNextVsync(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>EventThread<span style="color:#f92672">::</span>Connection<span style="color:#f92672">&gt;&amp;</span> connection) {
    std<span style="color:#f92672">::</span>lock_guard<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock(mMutex);

    <span style="color:#66d9ef">if</span> (mResyncWithRateLimitCallback) {
        mResyncWithRateLimitCallback();<span style="color:#75715e">//callback resyncWithRateLimit in SurfaceFlinger
</span><span style="color:#75715e"></span>    }

    <span style="color:#66d9ef">if</span> (connection<span style="color:#f92672">-&gt;</span>count <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
        connection<span style="color:#f92672">-&gt;</span>count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        mCondition.notify_all();
    }
}
</code></pre></div><p>frameworks/native/services/surfaceflinger/EventControlThread.cpp</p>
<h2 id="eventcontrolthread">EventControlThread</h2>
<h3 id="setvsyncenabled-1">setVsyncEnabled</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> EventControlThread<span style="color:#f92672">::</span>setVsyncEnabled(<span style="color:#66d9ef">bool</span> enabled) {
    std<span style="color:#f92672">::</span>lock_guard<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock(mMutex);
    mVsyncEnabled <span style="color:#f92672">=</span> enabled;
    mCondition.notify_all();
}
</code></pre></div><h3 id="threadmain-1">threadMain</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Unfortunately std::unique_lock gives warnings with -Wthread-safety
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> EventControlThread<span style="color:#f92672">::</span>threadMain() NO_THREAD_SAFETY_ANALYSIS {
    <span style="color:#66d9ef">auto</span> keepRunning <span style="color:#f92672">=</span> true;
    <span style="color:#66d9ef">auto</span> currentVsyncEnabled <span style="color:#f92672">=</span> false;

    <span style="color:#66d9ef">while</span> (keepRunning) {
        mSetVSyncEnabled(currentVsyncEnabled);

        std<span style="color:#f92672">::</span>unique_lock<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock(mMutex);
        mCondition.wait(lock, [<span style="color:#66d9ef">this</span>, currentVsyncEnabled, keepRunning]() NO_THREAD_SAFETY_ANALYSIS {
            <span style="color:#66d9ef">return</span> currentVsyncEnabled <span style="color:#f92672">!=</span> mVsyncEnabled <span style="color:#f92672">||</span> keepRunning <span style="color:#f92672">!=</span> mKeepRunning;
        });
        currentVsyncEnabled <span style="color:#f92672">=</span> mVsyncEnabled;
        keepRunning <span style="color:#f92672">=</span> mKeepRunning;
    }
}
</code></pre></div><p>frameworks/native/libs/gui/DisplayEventReceiver.cpp</p>
<h2 id="displayeventreceiver">DisplayEventReceiver</h2>
<h3 id="sendevents">sendEvents</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">
ssize_t DisplayEventReceiver<span style="color:#f92672">::</span>sendEvents(gui<span style="color:#f92672">::</span>BitTube<span style="color:#f92672">*</span> dataChannel,
        Event <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> events, size_t count)
{
    <span style="color:#66d9ef">return</span> gui<span style="color:#f92672">::</span>BitTube<span style="color:#f92672">::</span>sendObjects(dataChannel, events, count);
}
</code></pre></div><p>frameworks/native/libs/gui/BitTube.cpp</p>
<h2 id="bittube">BitTube</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Socket buffer size.  The default is typically about 128KB, which is much larger than we really
</span><span style="color:#75715e">// need. So we make it smaller.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> size_t DEFAULT_SOCKET_BUFFER_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>;
</code></pre></div><h3 id="bittube-1">BitTube()</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">BitTube<span style="color:#f92672">::</span>BitTube(size_t bufsize) {
    init(bufsize, bufsize);
}
</code></pre></div><h3 id="init-1">init</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> BitTube<span style="color:#f92672">::</span>init(size_t rcvbuf, size_t sndbuf) {
    <span style="color:#66d9ef">int</span> sockets[<span style="color:#ae81ff">2</span>];
    <span style="color:#66d9ef">if</span> (socketpair(AF_UNIX, SOCK_SEQPACKET, <span style="color:#ae81ff">0</span>, sockets) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        size_t size <span style="color:#f92672">=</span> DEFAULT_SOCKET_BUFFER_SIZE;
        setsockopt(sockets[<span style="color:#ae81ff">0</span>], SOL_SOCKET, SO_RCVBUF, <span style="color:#f92672">&amp;</span>rcvbuf, <span style="color:#66d9ef">sizeof</span>(rcvbuf));
        setsockopt(sockets[<span style="color:#ae81ff">1</span>], SOL_SOCKET, SO_SNDBUF, <span style="color:#f92672">&amp;</span>sndbuf, <span style="color:#66d9ef">sizeof</span>(sndbuf));
        <span style="color:#75715e">// since we don&#39;t use the &#34;return channel&#34;, we keep it small...
</span><span style="color:#75715e"></span>        setsockopt(sockets[<span style="color:#ae81ff">0</span>], SOL_SOCKET, SO_SNDBUF, <span style="color:#f92672">&amp;</span>size, <span style="color:#66d9ef">sizeof</span>(size));
        setsockopt(sockets[<span style="color:#ae81ff">1</span>], SOL_SOCKET, SO_RCVBUF, <span style="color:#f92672">&amp;</span>size, <span style="color:#66d9ef">sizeof</span>(size));
        fcntl(sockets[<span style="color:#ae81ff">0</span>], F_SETFL, O_NONBLOCK);
        fcntl(sockets[<span style="color:#ae81ff">1</span>], F_SETFL, O_NONBLOCK);
        mReceiveFd.reset(sockets[<span style="color:#ae81ff">0</span>]);
        mSendFd.reset(sockets[<span style="color:#ae81ff">1</span>]);
    } <span style="color:#66d9ef">else</span> {
        mReceiveFd.reset();
        ALOGE(<span style="color:#e6db74">&#34;BitTube: pipe creation failed (%s)&#34;</span>, strerror(errno));
    }
}
</code></pre></div><h3 id="sendobjects">sendObjects</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">ssize_t BitTube<span style="color:#f92672">::</span>sendObjects(BitTube<span style="color:#f92672">*</span> tube, <span style="color:#66d9ef">void</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> events, size_t count, size_t objSize) {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> vaddr <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*&gt;</span>(events);
    ssize_t size <span style="color:#f92672">=</span> tube<span style="color:#f92672">-&gt;</span>write(vaddr, count <span style="color:#f92672">*</span> objSize);

    <span style="color:#75715e">// ALOGE_IF(size&lt;0, &#34;error %d sending %d events&#34;, size, count);
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> size <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> size : size <span style="color:#f92672">/</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>ssize_t<span style="color:#f92672">&gt;</span>(objSize);
}
</code></pre></div><h3 id="write">write</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">ssize_t BitTube<span style="color:#f92672">::</span>write(<span style="color:#66d9ef">void</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span> vaddr, size_t size) {
    ssize_t err, len;
    <span style="color:#66d9ef">do</span> {
        len <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>send(mSendFd, vaddr, size, MSG_DONTWAIT <span style="color:#f92672">|</span> MSG_NOSIGNAL);
        <span style="color:#75715e">// cannot return less than size, since we&#39;re using SOCK_SEQPACKET
</span><span style="color:#75715e"></span>        err <span style="color:#f92672">=</span> len <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> errno : <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">while</span> (err <span style="color:#f92672">==</span> EINTR);
    <span style="color:#66d9ef">return</span> err <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> len : <span style="color:#f92672">-</span>err;
}
</code></pre></div><h3 id="recvobjects">recvObjects</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">ssize_t BitTube<span style="color:#f92672">::</span>recvObjects(BitTube<span style="color:#f92672">*</span> tube, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> events, size_t count, size_t objSize) {
    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> vaddr <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">*&gt;</span>(events);
    ssize_t size <span style="color:#f92672">=</span> tube<span style="color:#f92672">-&gt;</span>read(vaddr, count <span style="color:#f92672">*</span> objSize);

    <span style="color:#75715e">// ALOGE_IF(size&lt;0, &#34;error %d receiving %d events&#34;, size, count);
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> size <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> size : size <span style="color:#f92672">/</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>ssize_t<span style="color:#f92672">&gt;</span>(objSize);
}
</code></pre></div><p>rameworks/native/services/surfaceflinger/DispSync.cpp</p>
<h2 id="dispsync">DispSync</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h">    <span style="color:#75715e">// mThread is the thread from which all the callbacks are called.
</span><span style="color:#75715e"></span>    sp<span style="color:#f92672">&lt;</span>DispSyncThread<span style="color:#f92672">&gt;</span> mThread;
</code></pre></div><h3 id="init-2">init</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> DispSync<span style="color:#f92672">::</span>init(<span style="color:#66d9ef">bool</span> hasSyncFramework, <span style="color:#66d9ef">int64_t</span> dispSyncPresentTimeOffset) {
    mThread<span style="color:#f92672">-&gt;</span>run(<span style="color:#e6db74">&#34;DispSync&#34;</span>, PRIORITY_URGENT_DISPLAY <span style="color:#f92672">+</span> PRIORITY_MORE_FAVORABLE);

    reset();
    beginResync();
}
</code></pre></div><h3 id="addresyncsample">addResyncSample</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">bool</span> DispSync<span style="color:#f92672">::</span>addResyncSample(nsecs_t timestamp) {
       updateModelLocked();
}
</code></pre></div><h3 id="updatemodellocked">updateModelLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> DispSync<span style="color:#f92672">::</span>updateModelLocked() {
      mThread<span style="color:#f92672">-&gt;</span>updateModel(mPeriod, mPhase, mReferenceTime);
}
</code></pre></div><p>frameworks/native/services/surfaceflinger/DispSync.cpp</p>
<h2 id="dispsyncthread">DispSyncThread</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DispSyncThread</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Thread {
    Vector<span style="color:#f92672">&lt;</span>EventListener<span style="color:#f92672">&gt;</span> mEventListeners;
}
</code></pre></div><h3 id="threadloop">threadLoop</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">threadLoop</span>() {
        status_t err;
        nsecs_t now <span style="color:#f92672">=</span> systemTime(SYSTEM_TIME_MONOTONIC);

        <span style="color:#66d9ef">while</span> (true) {
                targetTime <span style="color:#f92672">=</span> computeNextEventTimeLocked(now);

                <span style="color:#66d9ef">bool</span> isWakeup <span style="color:#f92672">=</span> false;

                <span style="color:#66d9ef">if</span> (now <span style="color:#f92672">&lt;</span> targetTime) {
                    <span style="color:#66d9ef">if</span> (kTraceDetailedInfo) ATRACE_NAME(<span style="color:#e6db74">&#34;DispSync waiting&#34;</span>);

                    <span style="color:#66d9ef">if</span> (targetTime <span style="color:#f92672">==</span> INT64_MAX) {
                        ALOGV(<span style="color:#e6db74">&#34;[%s] Waiting forever&#34;</span>, mName);
                        err <span style="color:#f92672">=</span> mCond.wait(mMutex);
                    } <span style="color:#66d9ef">else</span> {
                        ALOGV(<span style="color:#e6db74">&#34;[%s] Waiting until %&#34;</span> PRId64, mName, ns2us(targetTime));
                        err <span style="color:#f92672">=</span> mCond.waitRelative(mMutex, targetTime <span style="color:#f92672">-</span> now);
                    }
                }
            
               callbackInvocations <span style="color:#f92672">=</span> gatherCallbackInvocationsLocked(now);
               <span style="color:#66d9ef">if</span> (callbackInvocations.size() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
                    fireCallbackInvocations(callbackInvocations);
               }
        }
    }
</code></pre></div><h3 id="gathercallbackinvocationslocked">gatherCallbackInvocationsLocked</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    Vector<span style="color:#f92672">&lt;</span>CallbackInvocation<span style="color:#f92672">&gt;</span> gatherCallbackInvocationsLocked(nsecs_t now) {
        Vector<span style="color:#f92672">&lt;</span>CallbackInvocation<span style="color:#f92672">&gt;</span> callbackInvocations;
        nsecs_t onePeriodAgo <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> mPeriod;

        <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> mEventListeners.size(); i<span style="color:#f92672">++</span>) {
            nsecs_t t <span style="color:#f92672">=</span> computeListenerNextEventTimeLocked(mEventListeners[i], onePeriodAgo);
            <span style="color:#66d9ef">if</span> (t <span style="color:#f92672">&lt;</span> now) {
                CallbackInvocation ci;
                ci.mCallback <span style="color:#f92672">=</span> mEventListeners[i].mCallback;
                ci.mEventTime <span style="color:#f92672">=</span> t;
                callbackInvocations.push(ci);
                mEventListeners.editItemAt(i).mLastEventTime <span style="color:#f92672">=</span> t;
            }
        }
        <span style="color:#66d9ef">return</span> callbackInvocations;
    }

</code></pre></div><h3 id="firecallbackinvocations">fireCallbackInvocations</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fireCallbackInvocations</span>(<span style="color:#66d9ef">const</span> Vector<span style="color:#f92672">&lt;</span>CallbackInvocation<span style="color:#f92672">&gt;&amp;</span> callbacks) {
        <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> callbacks.size(); i<span style="color:#f92672">++</span>) {
            callbacks[i].mCallback<span style="color:#f92672">-&gt;</span>onDispSyncEvent(callbacks[i].mEventTime);
        }
    }
</code></pre></div><h3 id="updatemodel">updateModel</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateModel</span>(nsecs_t period, nsecs_t phase, nsecs_t referenceTime) {
        Mutex<span style="color:#f92672">::</span>Autolock lock(mMutex);
        mPeriod <span style="color:#f92672">=</span> period;
        mPhase <span style="color:#f92672">=</span> phase;
        mReferenceTime <span style="color:#f92672">=</span> referenceTime;

        mCond.signal();
    }
</code></pre></div><p>frameworks/native/services/surfaceflinger/MessageQueue.h</p>
<h2 id="messagequeue">MessageQueue</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h">namespace impl {

class MessageQueue final : public android<span style="color:#f92672">::</span>MessageQueue {
    class Handler : public MessageHandler {
        <span style="color:#66d9ef">enum</span> { eventMaskInvalidate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>, eventMaskRefresh <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2</span>, eventMaskTransaction <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4</span> };
        MessageQueue<span style="color:#f92672">&amp;</span> mQueue;
        int32_t mEventMask;

    public:
        explicit Handler(MessageQueue<span style="color:#f92672">&amp;</span> queue) <span style="color:#f92672">:</span> mQueue(queue), mEventMask(<span style="color:#ae81ff">0</span>) {}
        virtual <span style="color:#66d9ef">void</span> handleMessage(<span style="color:#66d9ef">const</span> Message<span style="color:#f92672">&amp;</span> message);
        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchRefresh</span>();
        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchInvalidate</span>();
    };

    friend class Handler;

    sp<span style="color:#f92672">&lt;</span>SurfaceFlinger<span style="color:#f92672">&gt;</span> mFlinger;
    sp<span style="color:#f92672">&lt;</span>Looper<span style="color:#f92672">&gt;</span> mLooper;
    android<span style="color:#f92672">::</span>EventThread<span style="color:#f92672">*</span> mEventThread;
    sp<span style="color:#f92672">&lt;</span>IDisplayEventConnection<span style="color:#f92672">&gt;</span> mEvents;
    gui<span style="color:#f92672">::</span>BitTube mEventTube;
    sp<span style="color:#f92672">&lt;</span>Handler<span style="color:#f92672">&gt;</span> mHandler;
}
</code></pre></div><h3 id="init-3">init</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> MessageQueue<span style="color:#f92672">::</span>init(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>SurfaceFlinger<span style="color:#f92672">&gt;&amp;</span> flinger) {
    mFlinger <span style="color:#f92672">=</span> flinger;
    mLooper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Looper(true);<span style="color:#75715e">//system/core/include/utils/Looper.h
</span><span style="color:#75715e"></span>    mHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Handler(<span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>);
}
</code></pre></div><h3 id="seteventthread">setEventThread</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> MessageQueue<span style="color:#f92672">::</span>setEventThread(android<span style="color:#f92672">::</span>EventThread<span style="color:#f92672">*</span> eventThread) {
    <span style="color:#66d9ef">if</span> (mEventThread <span style="color:#f92672">==</span> eventThread) {
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#66d9ef">if</span> (mEventTube.getFd() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) {
        mLooper<span style="color:#f92672">-&gt;</span>removeFd(mEventTube.getFd());
    }

    mEventThread <span style="color:#f92672">=</span> eventThread;
    mEvents <span style="color:#f92672">=</span> eventThread<span style="color:#f92672">-&gt;</span>createEventConnection();
    mEvents<span style="color:#f92672">-&gt;</span>stealReceiveChannel(<span style="color:#f92672">&amp;</span>mEventTube);
    mLooper<span style="color:#f92672">-&gt;</span>addFd(mEventTube.getFd(), <span style="color:#ae81ff">0</span>, Looper<span style="color:#f92672">::</span>EVENT_INPUT, MessageQueue<span style="color:#f92672">::</span>cb_eventReceiver,
                   <span style="color:#66d9ef">this</span>);
}
</code></pre></div><h3 id="waitmessage">waitMessage</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> MessageQueue<span style="color:#f92672">::</span>waitMessage() {
    <span style="color:#66d9ef">do</span> {
        IPCThreadState<span style="color:#f92672">::</span>self()<span style="color:#f92672">-&gt;</span>flushCommands();
        <span style="color:#66d9ef">int32_t</span> ret <span style="color:#f92672">=</span> mLooper<span style="color:#f92672">-&gt;</span>pollOnce(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
        <span style="color:#66d9ef">switch</span> (ret) {
            <span style="color:#66d9ef">case</span> Looper<span style="color:#f92672">::</span>POLL_WAKE:
            <span style="color:#66d9ef">case</span> Looper<span style="color:#f92672">::</span>POLL_CALLBACK:
                <span style="color:#66d9ef">continue</span>;
            <span style="color:#66d9ef">case</span> Looper<span style="color:#f92672">::</span>POLL_ERROR:
                ALOGE(<span style="color:#e6db74">&#34;Looper::POLL_ERROR&#34;</span>);
                <span style="color:#66d9ef">continue</span>;
            <span style="color:#66d9ef">case</span> Looper<span style="color:#f92672">::</span>POLL_TIMEOUT:
                <span style="color:#75715e">// timeout (should not happen)
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">continue</span>;
            <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
                <span style="color:#75715e">// should not happen
</span><span style="color:#75715e"></span>                ALOGE(<span style="color:#e6db74">&#34;Looper::pollOnce() returned unknown status %d&#34;</span>, ret);
                <span style="color:#66d9ef">continue</span>;
        }
    } <span style="color:#66d9ef">while</span> (true);
}
</code></pre></div><h3 id="cb_eventreceiver">cb_eventReceiver</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> MessageQueue<span style="color:#f92672">::</span>cb_eventReceiver(<span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">int</span> events, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> data) {
    MessageQueue<span style="color:#f92672">*</span> queue <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>MessageQueue<span style="color:#f92672">*&gt;</span>(data);
    <span style="color:#66d9ef">return</span> queue<span style="color:#f92672">-&gt;</span>eventReceiver(fd, events);
}
</code></pre></div><h3 id="eventreceiver">eventReceiver</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> MessageQueue<span style="color:#f92672">::</span>eventReceiver(<span style="color:#66d9ef">int</span> <span style="color:#75715e">/*fd*/</span>, <span style="color:#66d9ef">int</span> <span style="color:#75715e">/*events*/</span>) {
    ssize_t n;
    DisplayEventReceiver<span style="color:#f92672">::</span>Event buffer[<span style="color:#ae81ff">8</span>];
    <span style="color:#66d9ef">while</span> ((n <span style="color:#f92672">=</span> DisplayEventReceiver<span style="color:#f92672">::</span>getEvents(<span style="color:#f92672">&amp;</span>mEventTube, buffer, <span style="color:#ae81ff">8</span>)) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> n; i<span style="color:#f92672">++</span>) {
            <span style="color:#66d9ef">if</span> (buffer[i].header.type <span style="color:#f92672">==</span> DisplayEventReceiver<span style="color:#f92672">::</span>DISPLAY_EVENT_VSYNC) {
                mHandler<span style="color:#f92672">-&gt;</span>dispatchInvalidate();
                <span style="color:#66d9ef">break</span>;
            }
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}
</code></pre></div><h3 id="handlerdispatchinvalidate">Handler::dispatchInvalidate</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> MessageQueue<span style="color:#f92672">::</span>Handler<span style="color:#f92672">::</span>dispatchInvalidate() {
    <span style="color:#66d9ef">if</span> ((android_atomic_or(eventMaskInvalidate, <span style="color:#f92672">&amp;</span>mEventMask) <span style="color:#f92672">&amp;</span> eventMaskInvalidate) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        mQueue.mLooper<span style="color:#f92672">-&gt;</span>sendMessage(<span style="color:#66d9ef">this</span>, Message(MessageQueue<span style="color:#f92672">::</span>INVALIDATE));
    }
}
</code></pre></div><h3 id="handlerhandlemessage">Handler::handleMessage</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> MessageQueue<span style="color:#f92672">::</span>Handler<span style="color:#f92672">::</span>handleMessage(<span style="color:#66d9ef">const</span> Message<span style="color:#f92672">&amp;</span> message) {
    <span style="color:#66d9ef">switch</span> (message.what) {
        <span style="color:#66d9ef">case</span> INVALIDATE:
            android_atomic_and(<span style="color:#f92672">~</span>eventMaskInvalidate, <span style="color:#f92672">&amp;</span>mEventMask);
            mQueue.mFlinger<span style="color:#f92672">-&gt;</span>onMessageReceived(message.what);
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> REFRESH:
            android_atomic_and(<span style="color:#f92672">~</span>eventMaskRefresh, <span style="color:#f92672">&amp;</span>mEventMask);
            mQueue.mFlinger<span style="color:#f92672">-&gt;</span>onMessageReceived(message.what);
            <span style="color:#66d9ef">break</span>;
    }
}
</code></pre></div><p>frameworks/native/services/surfaceflinger/DisplayHardware/HWC2.h</p>
<h2 id="composercallback">ComposerCallback</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h"><span style="color:#75715e">// Implement this interface to receive hardware composer events.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// These callback functions will generally be called on a hwbinder thread, but
</span><span style="color:#75715e">// when first registering the callback the onHotplugReceived() function will
</span><span style="color:#75715e">// immediately be called on the thread calling registerCallback().
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// All calls receive a sequenceId, which will be the value that was supplied to
</span><span style="color:#75715e">// HWC2::Device::registerCallback(). It&#39;s used to help differentiate callbacks
</span><span style="color:#75715e">// from different hardware composer instances.
</span><span style="color:#75715e"></span>class ComposerCallback {
 public:
    virtual <span style="color:#66d9ef">void</span> onHotplugReceived(int32_t sequenceId, hwc2_display_t display,
                                   Connection connection) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    virtual <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onRefreshReceived</span>(int32_t sequenceId,
                                   hwc2_display_t display) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    virtual <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onVsyncReceived</span>(int32_t sequenceId, hwc2_display_t display,
                                 int64_t timestamp) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    virtual <span style="color:#f92672">~</span>ComposerCallback() <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;
};
</code></pre></div><hr>
<p>frameworks/native/libs/gui/IGraphicBufferProducer.cpp</p>
<h2 id="igraphicbufferproducercpp">IGraphicBufferProducer.cpp</h2>
<h3 id="queuebuffer">queueBuffer</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">virtual</span> status_t <span style="color:#a6e22e">queueBuffer</span>(<span style="color:#66d9ef">int</span> buf,
        <span style="color:#66d9ef">const</span> QueueBufferInput<span style="color:#f92672">&amp;</span> input, QueueBufferOutput<span style="color:#f92672">*</span> output) {
    Parcel data, reply;

    data.writeInterfaceToken(IGraphicBufferProducer<span style="color:#f92672">::</span>getInterfaceDescriptor());
    data.writeInt32(buf);
    data.write(input);

    status_t result <span style="color:#f92672">=</span> remote()<span style="color:#f92672">-&gt;</span>transact(QUEUE_BUFFER, data, <span style="color:#f92672">&amp;</span>reply);

    <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><h3 id="ontransact">onTransact</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t BnGraphicBufferProducer<span style="color:#f92672">::</span>onTransact(
    <span style="color:#66d9ef">uint32_t</span> code, <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data, Parcel<span style="color:#f92672">*</span> reply, <span style="color:#66d9ef">uint32_t</span> flags)
{
    <span style="color:#66d9ef">switch</span>(code) {    
            <span style="color:#66d9ef">case</span> QUEUE_BUFFER: {
            CHECK_INTERFACE(IGraphicBufferProducer, data, reply);

            <span style="color:#66d9ef">int</span> buf <span style="color:#f92672">=</span> data.readInt32();
            QueueBufferInput <span style="color:#a6e22e">input</span>(data);
            QueueBufferOutput output;
            status_t result <span style="color:#f92672">=</span> queueBuffer(buf, input, <span style="color:#f92672">&amp;</span>output);
            reply<span style="color:#f92672">-&gt;</span>write(output);
            reply<span style="color:#f92672">-&gt;</span>writeInt32(result);

            <span style="color:#66d9ef">return</span> NO_ERROR;
        }
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">79</span>      status_t MonitoredProducer<span style="color:#f92672">::</span>queueBuffer(<span style="color:#66d9ef">int</span> slot, <span style="color:#66d9ef">const</span> QueueBufferInput<span style="color:#f92672">&amp;</span> input,                                             
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">80</span>              QueueBufferOutput<span style="color:#f92672">*</span> output) {                                                                                         
  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">81</span>          <span style="color:#66d9ef">return</span> mProducer<span style="color:#f92672">-&gt;</span>queueBuffer(slot, input, output);                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">82</span>      }                                                                                                                            
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">83</span> 
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">750</span>     status_t BufferQueueProducer<span style="color:#f92672">::</span>queueBuffer(<span style="color:#66d9ef">int</span> slot,                                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">751</span>             <span style="color:#66d9ef">const</span> QueueBufferInput <span style="color:#f92672">&amp;</span>input, QueueBufferOutput <span style="color:#f92672">*</span>output) {  
    
      <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">977</span>                 frameAvailableListener<span style="color:#f92672">-&gt;</span>onFrameAvailable(item);                                                                  

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">46</span>      <span style="color:#66d9ef">void</span> BufferQueue<span style="color:#f92672">::</span>ProxyConsumerListener<span style="color:#f92672">::</span>onFrameAvailable(                                                                   
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">47</span>              <span style="color:#66d9ef">const</span> BufferItem<span style="color:#f92672">&amp;</span> item) {                                                                                            
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">48</span>          sp<span style="color:#f92672">&lt;</span>ConsumerListener<span style="color:#f92672">&gt;</span> listener(mConsumerListener.promote());                                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">49</span>          <span style="color:#66d9ef">if</span> (listener <span style="color:#f92672">!=</span> NULL) {                                                                                                  
  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">50</span>              listener<span style="color:#f92672">-&gt;</span>onFrameAvailable(item);                                                                                    
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">51</span>          }                                                                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">52</span>      } 
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">104</span>     <span style="color:#66d9ef">void</span> ConsumerBase<span style="color:#f92672">::</span>onFrameAvailable(<span style="color:#66d9ef">const</span> BufferItem<span style="color:#f92672">&amp;</span> item) {                                                                
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">105</span>         CB_LOGV(<span style="color:#e6db74">&#34;onFrameAvailable&#34;</span>);                                                                                             
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">106</span>                                                                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">107</span>         sp<span style="color:#f92672">&lt;</span>FrameAvailableListener<span style="color:#f92672">&gt;</span> listener;                                                                                     
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">108</span>         { <span style="color:#75715e">// scope for the lock                                                                                                  
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">109</span>             Mutex<span style="color:#f92672">::</span>Autolock lock(mFrameAvailableMutex);                                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">110</span>             listener <span style="color:#f92672">=</span> mFrameAvailableListener.promote();                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">111</span>         }                                                                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">112</span>                                                                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">113</span>         <span style="color:#66d9ef">if</span> (listener <span style="color:#f92672">!=</span> NULL) {                                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">114</span>             CB_LOGV(<span style="color:#e6db74">&#34;actually calling onFrameAvailable&#34;</span>);                                                                        
  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">115</span>             listener<span style="color:#f92672">-&gt;</span>onFrameAvailable(item);                                                                                    
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">116</span>         }                                                                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">117</span>     } 
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">723</span>     <span style="color:#75715e">// ---------------------------------------------------------------------------                                               
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">724</span>     <span style="color:#75715e">// Interface implementation for SurfaceFlingerConsumer::ContentsChangedListener                                              
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">725</span>     <span style="color:#75715e">// ---------------------------------------------------------------------------                                               
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">726</span>                                                                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">727</span>     <span style="color:#66d9ef">void</span> BufferLayer<span style="color:#f92672">::</span>onFrameAvailable(<span style="color:#66d9ef">const</span> BufferItem<span style="color:#f92672">&amp;</span> item) {                                                                 
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">728</span>         <span style="color:#75715e">// Add this buffer from our internal queue tracker                                                                       
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">729</span>         { <span style="color:#75715e">// Autolock scope                                                                                                      
</span><span style="color:#75715e"></span>B<span style="color:#f92672">+&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">730</span>             Mutex<span style="color:#f92672">::</span>Autolock lock(mQueueItemLock); 
</code></pre></div>

<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/" title="Vsync"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/" title="硬件加速绘制" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1611381690"></script>
    <script src="/js/perfect-scrollbar.min.js?1611381690"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1611381690"></script>
    <script src="/js/jquery.sticky.js?1611381690"></script>
    <script src="/js/featherlight.min.js?1611381690"></script>
    <script src="/js/highlight.pack.js?1611381690"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1611381690"></script>
    <script src="/js/learn.js?1611381690"></script>
    <script src="/js/hugo-learn.js?1611381690"></script>
    
        
            <script src="/mermaid/mermaid.js?1611381690"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

