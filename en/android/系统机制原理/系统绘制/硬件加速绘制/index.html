<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="description" content="Documentation for Hugo Learn Theme">
<meta name="author" content="Mathieu Cornic">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>硬件加速绘制 :: 郑欢的学习总结</title>

    
    <link href="/css/nucleus.css?1611382862" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1611382862" rel="stylesheet">
    <link href="/css/hybrid.css?1611382862" rel="stylesheet">
    <link href="/css/featherlight.min.css?1611382862" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1611382862" rel="stylesheet">
    <link href="/css/auto-complete.css?1611382862" rel="stylesheet">
    <link href="/css/atom-one-dark.css?1611382862" rel="stylesheet">
    <link href="/css/theme.css?1611382862" rel="stylesheet">
    <link href="/css/hugo-theme.css?1611382862" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1611382862" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1611382862"></script>

    <script src="/js/auto_toc_scroll.js?1611382862"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/en'>
    <img src="/avatar.png" width="60px" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1611382862"></script>
<script type="text/javascript" src="/js/auto-complete.js?1611382862"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/huanle19891345.github.io\/\/en";
    
</script>
<script type="text/javascript" src="/js/search.js?1611382862"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/en/android/" title="android" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/">
          android
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/google/" title="google" class="dd-item
        
        
        
        ">
      <a href="/en/android/google/">
          google
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/google/supporttoandroidx/" title="supportToAndroidx" class="dd-item ">
        <a href="/en/android/google/supporttoandroidx/">
        supportToAndroidx
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/" title="系统机制原理" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/">
          系统机制原理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/" title="ashmem" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/">
          ashmem
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/" title="匿名共享内存Ashmem" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/">
        匿名共享内存Ashmem
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/" title="bitmap" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/">
          bitmap
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/" title="Bitmap" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/">
        Bitmap
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/" title="BitmapSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/">
        BitmapSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/" title="handler" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/">
          handler
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/" title="Looper" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/">
        Looper
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/" title="ThreadLocal" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/">
        ThreadLocal
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/" title="input" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/">
          input
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/" title="touchEventNative" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/">
        touchEventNative
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/" title="zygote" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/">
          zygote
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/" title="SystemServerSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/">
        SystemServerSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/" title="ZygoteSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/">
        ZygoteSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/" title="Zygote进程" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/">
        Zygote进程
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/" title="多进程" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">
          多进程
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/" title="binder" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/">
          binder
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/" title="BinderClient" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/">
        BinderClient
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/" title="BinderDeath" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/">
        BinderDeath
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/" title="BinderKernel" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/">
        BinderKernel
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/" title="BinderServer" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/">
        BinderServer
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/" title="BinderServiceManager" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/">
        BinderServiceManager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/" title="Binder原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/">
        Binder原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/" title="mmkv" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/">
          mmkv
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/" title="MMKV" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/">
        MMKV
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/" title="系统绘制" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/">
          系统绘制
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/" title="Graphics" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/">
        Graphics
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/" title="Vsync" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/">
        Vsync
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/" title="Vsync_SurfaceFlinger" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/">
        Vsync_SurfaceFlinger
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/" title="硬件加速绘制" class="dd-item active">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/">
        硬件加速绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/" title="绘制原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/">
        绘制原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/" title="软件绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/">
        软件绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" title="跨平台" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">
          跨平台
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/" title="flutter" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/">
          flutter
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/" title="通信" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/">
          通信
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" title="Flutter消息机制" class="dd-item ">
        <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/">
        Flutter消息机制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/huanle19891345"><i class='fab fa-fw fa-github'></i> GitHub repo</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/showcase"><i class='fas fa-fw fa-camera'></i> Showcases</a>
              </li>
          
              <li>
                  <a class="padding" href="https://gohugo.io/"><i class='fas fa-fw fa-bookmark'></i> Hugo Documentation</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/credits"><i class='fas fa-fw fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/en/'>技术探索总结</a> > <a href='/en/android/'>android</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/'>系统机制原理</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/'>系统绘制</a> > 硬件加速绘制
          
        
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#硬件加速绘制">硬件加速绘制</a>
      <ul>
        <li><a href="#软硬件加速的区别">软硬件加速的区别</a></li>
        <li><a href="#软件绘制跟硬件加速的分歧点">软件绘制跟硬件加速的分歧点</a></li>
        <li><a href="#hardwarerenderer硬件加速绘制模型">HardwareRenderer硬件加速绘制模型</a></li>
        <li><a href="#利用hardwarerenderer构建drawop集">利用HardwareRenderer构建DrawOp集</a>
          <ul>
            <li><a href="#threadedrendererdraw">ThreadedRenderer::draw</a>
              <ul>
                <li><a href="#updaterootdisplaylist">updateRootDisplayList</a>
                  <ul>
                    <li><a href="#viewjava递归构建drawop">View.java递归构建DrawOp</a></li>
                    <li><a href="#viewgroupdispatchdraw">ViewGroup::dispatchDraw</a></li>
                    <li><a href="#viewdraw">View::draw</a></li>
                    <li><a href="#drawline">drawLine</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#renderthread渲染ui到graphic-buffer">RenderThread渲染UI到Graphic Buffer</a>
          <ul>
            <li><a href="#syncanddrawframe">syncAndDrawFrame</a></li>
            <li><a href="#renderproxysyncanddrawframe">RenderProxy::syncAndDrawFrame</a></li>
            <li><a href="#drawframetaskdrawframe">DrawFrameTask::drawFrame</a></li>
            <li><a href="#drawframetaskpostandwait">DrawFrameTask::postAndWait</a></li>
            <li><a href="#drawframetaskrun">DrawFrameTask::run</a></li>
            <li><a href="#canvascontextdraw">CanvasContext::draw</a></li>
          </ul>
        </li>
        <li><a href="#绘制内存的由来">绘制内存的由来</a></li>
        <li><a href="#surface与渲染线程上下文绑定">Surface与渲染线程（上下文）绑定</a></li>
        <li><a href="#合并操作和绘制">合并操作和绘制</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              硬件加速绘制
            </h1>
          

        


<h2 id="硬件加速绘制">硬件加速绘制</h2>
<p><a href="https://www.jianshu.com/p/03663b35ffa2">Android硬件加速过程分析</a></p>
<p><a href="https://www.jianshu.com/p/40f660e17a73">理解Android硬件加速原理的小白文</a></p>
<p><a href="https://www.jianshu.com/p/0dbe2325122f">Android硬件加速原理与实现</a></p>
<p>总结：</p>
<ul>
<li>CPU更擅长复杂逻辑控制，而GPU得益于大量ALU和并行结构设计，更擅长数学运算。</li>
<li>页面由各种基础元素（DisplayList）构成，渲染时需要进行大量浮点运算。</li>
<li>硬件加速条件下，CPU用于控制复杂绘制逻辑，构建或更新DisplayList；GPU用于完成图形计算，渲染DisplayList。</li>
<li>硬件加速条件下，刷新界面尤其是播放动画时，CPU只重建或更新必要的DisplayList，进一步提高渲染效率。</li>
</ul>
<hr>
<h3 id="软硬件加速的区别">软硬件加速的区别</h3>
<p>软硬件加速的区别主要是==图形的绘制究竟是GPU来处理还是CPU，如果是GPU==，就认为是硬件加速绘制，反之，软件绘制。</p>
<p>不仅仅限定在绘制方面，绘制之前，在如何构建绘制区域上，硬件加速也做出了很大优化，因此硬件加速特性可以从下面两部分来分析：</p>
<ol>
<li>==前期策略：如何构建需要绘制的区域==</li>
<li>==后期绘制：单独渲染线程，依赖GPU进行绘制==</li>
</ol>
<p>无论是软件绘制还是硬件加速，==绘制内存的分配都是类似的，都是需要请求SurfaceFlinger服务分配一块内存==，只不过硬件加速有可能从FrameBuffer硬件缓冲区直接分配内存（SurfaceFlinger一直这么干的），==两者的绘制都是在APP端，绘制完成之后同样需要通知SurfaceFlinger进行合成，在这个流程上没有任何区别==，真正的区别在于在APP端如何完成UI数据绘制</p>
<p>软件绘制同硬件加速的区别主要是在绘制上，内存分配、图层合成等整体流程是一样的，只不过硬件加速相比软件绘制算法更加合理，同时采用单独的渲染线程，减轻了主线程的负担。</p>
<h3 id="软件绘制跟硬件加速的分歧点">软件绘制跟硬件加速的分歧点</h3>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/jpg-20200910111050100.jpeg" alt="image"></p>
<p>ViewRootImpl.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> fullRedrawNeeded<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> mIsAnimating <span style="color:#f92672">||</span> accessibilityFocusDirty<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//关键点1 是否开启硬件加速
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHardwareRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHardwareRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
             <span style="color:#f92672">...</span>
            dirty<span style="color:#f92672">.</span><span style="color:#a6e22e">setEmpty</span><span style="color:#f92672">();</span>
            mBlockResizeBuffer <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#75715e">//关键点2 硬件加速绘制
</span><span style="color:#75715e"></span>            mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHardwareRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>mView<span style="color:#f92672">,</span> mAttachInfo<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
          <span style="color:#f92672">...</span>
           <span style="color:#75715e">//关键点3 软件绘制
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>drawSoftware<span style="color:#f92672">(</span>surface<span style="color:#f92672">,</span> mAttachInfo<span style="color:#f92672">,</span> xOffset<span style="color:#f92672">,</span> yOffset<span style="color:#f92672">,</span> scalingRequired<span style="color:#f92672">,</span> dirty<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">...</span>
</code></pre></div><p>其实到这里软件绘制跟硬件加速的分歧点已经找到了，就是ViewRootImpl在draw的时候，如果需要硬件加速就利用 HardwareRenderer进行draw，否则走软件绘制流程，drawSoftware其实很简单，利用Surface.lockCanvas，向SurfaceFlinger申请一块匿名共享内存<a href="https://www.jianshu.com/p/2fb8cc9e63cb">内存分配</a>，同时获取一个普通的SkiaCanvas，用于调用Skia库，进行图形绘制，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">drawSoftware</span><span style="color:#f92672">(</span>Surface surface<span style="color:#f92672">,</span> AttachInfo attachInfo<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> xoff<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> yoff<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">boolean</span> scalingRequired<span style="color:#f92672">,</span> Rect dirty<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> Canvas canvas<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//关键点1
</span><span style="color:#75715e"></span>            canvas <span style="color:#f92672">=</span> mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">lockCanvas</span><span style="color:#f92672">(</span>dirty<span style="color:#f92672">);</span>
            <span style="color:#f92672">..</span>
            <span style="color:#75715e">//关键点2 绘制
</span><span style="color:#75715e"></span>                 mView<span style="color:#f92672">.</span><span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
             <span style="color:#f92672">..</span>
             <span style="color:#75715e">//关键点3 通知SurfaceFlinger进行图层合成
</span><span style="color:#75715e"></span>                surface<span style="color:#f92672">.</span><span style="color:#a6e22e">unlockCanvasAndPost</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>   <span style="color:#f92672">...</span>         
           <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>  <span style="color:#f92672">}</span>
</code></pre></div><p>默认情况下Skia的绘制没有采用GPU渲染的方式（虽然Skia也能用GPU渲染），也就说默认drawSoftware工作完全由CPU来完成，不会牵扯到GPU的操作，但是8.0之后，Google逐渐加重了Skia，开始让Skia接手OpenGL，间接统一调用，将来还可能是Skia同Vulkan的结合，不过这里不是重点。重点看下HardwareRenderer所进行的硬件加速绘制。</p>
<h3 id="hardwarerenderer硬件加速绘制模型">HardwareRenderer硬件加速绘制模型</h3>
<p>开头说过，硬件加速绘制包括两个阶段：==构建阶段+绘制阶段==，所谓构建就是递归遍历所有视图，将需要的操作缓存下来，之后再交给单独的Render线程利用OpenGL渲染。在Android硬件加速框架中，==View视图被抽象成RenderNode节点==，==View中的绘制都会被抽象成一个个DrawOp（DisplayListOp）==，比如View中drawLine，构建中就会被抽象成一个DrawLintOp，drawBitmap操作会被抽象成DrawBitmapOp，==每个子View的绘制被抽象成DrawRenderNodeOp，每个DrawOp有对应的OpenGL绘制命令，同时内部也握着绘图所需要的数据==。如下所示：</p>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/jpg.jpeg" alt="image"></p>
<p>如此以来，==每个View不仅仅握有自己DrawOp List，同时还拿着子View的绘制入口，如此递归==，便能够统计到所有的绘制Op，很多分析都称==为Display List==，源码中也是这么来命名类的，不过这里其实更像是一个树，而不仅仅是List，示意如下：</p>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/image-20200910111000106.png" alt="image-20200910111000106"></p>
<p>构建完成后，就可以==将这个绘图Op树交给Render线程进行绘制==，这里是同软件绘制很不同的地方，软件绘制时，View一般都在主线程中完成绘制，而硬件加速，除非特殊要求，一般都是在单独线程中完成绘制，如此以来就分担了主线程很多压力，提高了UI线程的响应速度。</p>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/image-20200910110836342.png" alt="image-20200910110836342"></p>
<p><a href="https://www.jianshu.com/p/dd800800145b">Android硬件加速（二）-RenderThread与OpenGL GPU渲染</a></p>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/image-20200910110728186.png" alt="image-20200910110728186"></p>
<h3 id="利用hardwarerenderer构建drawop集">利用HardwareRenderer构建DrawOp集</h3>
<p>HardwareRenderer是整个硬件加速绘制的入口，实现是一个ThreadedRenderer对象，从名字能看出，ThreadedRenderer应该跟一个Render线程息息相关，不过ThreadedRenderer是在UI线程中创建的，那么与UI线程也必定相关，其主要作用：</p>
<ol>
<li>==在UI线程中完成DrawOp集构建==</li>
<li>==负责跟渲染线程通信==</li>
</ol>
<p>可见ThreadedRenderer的作用是很重要的，简单看一下实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ThreadedRenderer<span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> translucent<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">...</span>
    <span style="color:#75715e">//新建native node
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">long</span> rootNodePtr <span style="color:#f92672">=</span> nCreateRootRenderNode<span style="color:#f92672">();</span>
    mRootNode <span style="color:#f92672">=</span> RenderNode<span style="color:#f92672">.</span><span style="color:#a6e22e">adopt</span><span style="color:#f92672">(</span>rootNodePtr<span style="color:#f92672">);</span>
    mRootNode<span style="color:#f92672">.</span><span style="color:#a6e22e">setClipToBounds</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">//新建NativeProxy
</span><span style="color:#75715e"></span>    mNativeProxy <span style="color:#f92672">=</span> nCreateProxy<span style="color:#f92672">(</span>translucent<span style="color:#f92672">,</span> rootNodePtr<span style="color:#f92672">);</span>
    ProcessInitializer<span style="color:#f92672">.</span><span style="color:#a6e22e">sInstance</span><span style="color:#f92672">.</span><span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> mNativeProxy<span style="color:#f92672">);</span>
    loadSystemProperties<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>从上面代码看出，ThreadedRenderer中有一个==RootNode==用来标识整个DrawOp树的根节点，有个这个根节点就可以访问所有的绘制Op，同时还有个==RenderProxy对象，这个对象就是用来跟渲染线程进行通信的句柄==，看一下其构造函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">RenderProxy<span style="color:#f92672">::</span>RenderProxy(<span style="color:#66d9ef">bool</span> translucent, RenderNode<span style="color:#f92672">*</span> rootRenderNode, IContextFactory<span style="color:#f92672">*</span> contextFactory)
        <span style="color:#f92672">:</span> mRenderThread(RenderThread<span style="color:#f92672">::</span>getInstance())
        , mContext(<span style="color:#66d9ef">nullptr</span>) {
    SETUP_TASK(createContext);
    args<span style="color:#f92672">-&gt;</span>translucent <span style="color:#f92672">=</span> translucent;
    args<span style="color:#f92672">-&gt;</span>rootRenderNode <span style="color:#f92672">=</span> rootRenderNode;
    args<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>mRenderThread;
    args<span style="color:#f92672">-&gt;</span>contextFactory <span style="color:#f92672">=</span> contextFactory;
    mContext <span style="color:#f92672">=</span> (CanvasContext<span style="color:#f92672">*</span>) postAndWait(task);
    mDrawFrameTask.setContext(<span style="color:#f92672">&amp;</span>mRenderThread, mContext);  
   }
</code></pre></div><p>从RenderThread::getInstance()可以看出，==RenderThread是一个单例线程==，也就是说，每个进程最多只有一个硬件渲染线程，这样就不会存在多线程并发访问冲突问题。下面就接着看ThreadedRenderer的draw函数，如何构建渲染Op树：</p>
<h4 id="threadedrendererdraw">ThreadedRenderer::draw</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>View view<span style="color:#f92672">,</span> AttachInfo attachInfo<span style="color:#f92672">,</span> HardwareDrawCallbacks callbacks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mIgnoreDirtyState</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">final</span> Choreographer choreographer <span style="color:#f92672">=</span> attachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewRootImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mChoreographer</span><span style="color:#f92672">;</span>
    choreographer<span style="color:#f92672">.</span><span style="color:#a6e22e">mFrameInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">markDrawStart</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">//关键点1：构建View的DrawOp树
</span><span style="color:#75715e"></span>    updateRootDisplayList<span style="color:#f92672">(</span>view<span style="color:#f92672">,</span> callbacks<span style="color:#f92672">);</span>

    <span style="color:#75715e">//关键点2：通知RenderThread线程绘制
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> syncResult <span style="color:#f92672">=</span> nSyncAndDrawFrame<span style="color:#f92672">(</span>mNativeProxy<span style="color:#f92672">,</span> frameInfo<span style="color:#f92672">,</span> frameInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">...</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>关键点1 updateRootDisplayList，构建RootDisplayList，其实就是构建View的DrawOp树，==updateRootDisplayList会进而调用根View的updateDisplayListIfDirty，让其递归子View的updateDisplayListIfDirty，从而完成DrawOp树的创==建，简述一下流程：</p>
<h5 id="updaterootdisplaylist">updateRootDisplayList</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateRootDisplayList</span><span style="color:#f92672">(</span>View view<span style="color:#f92672">,</span> HardwareDrawCallbacks callbacks<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    updateViewTreeDisplayList<span style="color:#f92672">(</span>view<span style="color:#f92672">);</span>
   <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mRootNodeNeedsUpdate <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mRootNode<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//获取DisplayListCanvas, 利用View的RenderNode获取一个DisplayListCanvas
</span><span style="color:#75715e"></span>        DisplayListCanvas canvas <span style="color:#f92672">=</span> mRootNode<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>mSurfaceWidth<span style="color:#f92672">,</span> mSurfaceHeight<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//利用canvas缓存Op, 利用DisplayListCanvas构建并缓存所有的DrawOp
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> saveCount <span style="color:#f92672">=</span> canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">();</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">translate</span><span style="color:#f92672">(</span>mInsetLeft<span style="color:#f92672">,</span> mInsetTop<span style="color:#f92672">);</span>
            callbacks<span style="color:#f92672">.</span><span style="color:#a6e22e">onHardwarePreDraw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>

            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">insertReorderBarrier</span><span style="color:#f92672">();</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawRenderNode</span><span style="color:#f92672">(</span>view<span style="color:#f92672">.</span><span style="color:#a6e22e">updateDisplayListIfDirty</span><span style="color:#f92672">());</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">insertInorderBarrier</span><span style="color:#f92672">();</span>

            callbacks<span style="color:#f92672">.</span><span style="color:#a6e22e">onHardwarePostDraw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
            canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">restoreToCount</span><span style="color:#f92672">(</span>saveCount<span style="color:#f92672">);</span>
            mRootNodeNeedsUpdate <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//将所有Op填充到RootRenderNode, 将DisplayListCanvas缓存的DrawOp填充到RenderNode
</span><span style="color:#75715e"></span>            mRootNode<span style="color:#f92672">.</span><span style="color:#a6e22e">end</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/png-20201029094947750.png" alt="image"></p>
<h6 id="viewjava递归构建drawop">View.java递归构建DrawOp</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#a6e22e">@NonNull</span>
    <span style="color:#66d9ef">public</span> RenderNode <span style="color:#a6e22e">updateDisplayListIfDirty</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> RenderNode renderNode <span style="color:#f92672">=</span> mRenderNode<span style="color:#f92672">;</span>
        <span style="color:#f92672">...</span>
            <span style="color:#75715e">// start 获取一个 DisplayListCanvas 用于绘制 硬件加速 
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">final</span> DisplayListCanvas canvas <span style="color:#f92672">=</span> renderNode<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span>width<span style="color:#f92672">,</span> height<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">// 是否是textureView
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">final</span> HardwareLayer layer <span style="color:#f92672">=</span> getHardwareLayer<span style="color:#f92672">();</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>layer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> layer<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                    canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawHardwareLayer</span><span style="color:#f92672">(</span>layer<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> mLayerPaint<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>layerType <span style="color:#f92672">==</span> LAYER_TYPE_SOFTWARE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">// 是否强制软件绘制
</span><span style="color:#75715e"></span>                    buildDrawingCache<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    Bitmap cache <span style="color:#f92672">=</span> getDrawingCache<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cache <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">drawBitmap</span><span style="color:#f92672">(</span>cache<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> mLayerPaint<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                      <span style="color:#75715e">// 如果仅仅是ViewGroup，并且自身不用绘制，直接递归子View
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>mPrivateFlags <span style="color:#f92672">&amp;</span> PFLAG_SKIP_DRAW<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> PFLAG_SKIP_DRAW<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                        dispatchDraw<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                        <span style="color:#75715e">//调用自己draw，如果是ViewGroup会递归子View
</span><span style="color:#75715e"></span>                        draw<span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">//缓存构建Op
</span><span style="color:#75715e"></span>                renderNode<span style="color:#f92672">.</span><span style="color:#a6e22e">end</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">);</span>
                setDisplayListProperties<span style="color:#f92672">(</span>renderNode<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>  
        <span style="color:#66d9ef">return</span> renderNode<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h6 id="viewgroupdispatchdraw">ViewGroup::dispatchDraw</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatchDraw</span><span style="color:#f92672">(</span>Canvas canvas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> usingRenderNodeProperties <span style="color:#f92672">=</span> canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">isRecordingFor</span><span style="color:#f92672">(</span>mRenderNode<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childrenCount <span style="color:#f92672">=</span> mChildrenCount<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">final</span> View<span style="color:#f92672">[]</span> children <span style="color:#f92672">=</span> mChildren<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> mGroupFlags<span style="color:#f92672">;</span>
        
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> childrenCount<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> childIndex <span style="color:#f92672">=</span> getAndVerifyPreorderedIndex<span style="color:#f92672">(</span>childrenCount<span style="color:#f92672">,</span> i<span style="color:#f92672">,</span> customOrder<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">final</span> View child <span style="color:#f92672">=</span> getAndVerifyPreorderedView<span style="color:#f92672">(</span>preorderedList<span style="color:#f92672">,</span> children<span style="color:#f92672">,</span> childIndex<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>child<span style="color:#f92672">.</span><span style="color:#a6e22e">mViewFlags</span> <span style="color:#f92672">&amp;</span> VISIBILITY_MASK<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> VISIBLE <span style="color:#f92672">||</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">getAnimation</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                more <span style="color:#f92672">|=</span> drawChild<span style="color:#f92672">(</span>canvas<span style="color:#f92672">,</span> child<span style="color:#f92672">,</span> drawingTime<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">drawChild</span><span style="color:#f92672">(</span>Canvas canvas<span style="color:#f92672">,</span> View child<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> drawingTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> child<span style="color:#f92672">.</span><span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>canvas<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> drawingTime<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h6 id="viewdraw">View::draw</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">draw</span><span style="color:#f92672">(</span>Canvas canvas<span style="color:#f92672">,</span> ViewGroup parent<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> drawingTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">boolean</span> drawingWithRenderNode <span style="color:#f92672">=</span> mAttachInfo <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
                <span style="color:#f92672">&amp;&amp;</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHardwareAccelerated</span>
                <span style="color:#f92672">&amp;&amp;</span> hardwareAcceleratedCanvas<span style="color:#f92672">;</span>
       <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>drawingWithRenderNode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            renderNode <span style="color:#f92672">=</span> updateDisplayListIfDirty<span style="color:#f92672">();</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h6 id="drawline">drawLine</h6>
<p>假如在View onDraw中，有个drawLine，这里就会调用DisplayListCanvas的drawLine函数，DisplayListCanvas及RenderNode类图大概如下
<img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/png-20201029095216873.png" alt="image"></p>
<p>DisplayListCanvas的drawLine函数最终会进入DisplayListCanvas.cpp的drawLine，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> DisplayListCanvas<span style="color:#f92672">::</span>drawLines(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">float</span><span style="color:#f92672">*</span> points, <span style="color:#66d9ef">int</span> count, <span style="color:#66d9ef">const</span> SkPaint<span style="color:#f92672">&amp;</span> paint) {
    points <span style="color:#f92672">=</span> refBuffer<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span>(points, count);

    addDrawOp(<span style="color:#66d9ef">new</span> (alloc()) DrawLinesOp(points, count, refPaint(<span style="color:#f92672">&amp;</span>paint)));
}
</code></pre></div><p>可以看到，这里构建了一个DrawLinesOp，并添加到DisplayListCanvas的缓存列表中去，如此递归便可以完成DrawOp树的构建，在构建后利用RenderNode的end函数，将DisplayListCanvas中的数据缓存到RenderNode中去：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">end</span><span style="color:#f92672">(</span>DisplayListCanvas canvas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">onPostDraw</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">long</span> renderNodeData <span style="color:#f92672">=</span> canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">finishRecording</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">//将DrawOp缓存到RenderNode中去
</span><span style="color:#75715e"></span>    nSetDisplayListData<span style="color:#f92672">(</span>mNativeRenderNode<span style="color:#f92672">,</span> renderNodeData<span style="color:#f92672">);</span>
    <span style="color:#75715e">// canvas 回收掉]
</span><span style="color:#75715e"></span>    canvas<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
    mValid <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="renderthread渲染ui到graphic-buffer">RenderThread渲染UI到Graphic Buffer</h3>
<p>DrawOp树构建完毕后，UI线程利用RenderProxy向RenderThread线程发送一个DrawFrameTask任务请求，RenderThread被唤醒，开始渲染，大致流程如下：</p>
<ul>
<li>首先进行DrawOp的==合并==</li>
<li>接着绘制特殊的Layer</li>
<li>最后==绘制其余所有的DrawOpList==</li>
<li>调用swapBuffers将前面已经绘制好的图形缓冲区提交给Surface Flinger合成和显示。</li>
</ul>
<h4 id="syncanddrawframe">syncAndDrawFrame</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">android_view_ThreadedRenderer_syncAndDrawFrame</span>(JNIEnv<span style="color:#f92672">*</span> env, jobject clazz,
        jlong proxyPtr, jlongArray frameInfo, jint frameInfoSize) {
    RenderProxy<span style="color:#f92672">*</span> proxy <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>RenderProxy<span style="color:#f92672">*&gt;</span>(proxyPtr);
    env<span style="color:#f92672">-&gt;</span>GetLongArrayRegion(frameInfo, <span style="color:#ae81ff">0</span>, frameInfoSize, proxy<span style="color:#f92672">-&gt;</span>frameInfo());
    <span style="color:#66d9ef">return</span> proxy<span style="color:#f92672">-&gt;</span>syncAndDrawFrame();
}
</code></pre></div><h4 id="renderproxysyncanddrawframe">RenderProxy::syncAndDrawFrame</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> RenderProxy<span style="color:#f92672">::</span>syncAndDrawFrame() {
    <span style="color:#66d9ef">return</span> mDrawFrameTask.drawFrame();
}
</code></pre></div><h4 id="drawframetaskdrawframe">DrawFrameTask::drawFrame</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> DrawFrameTask<span style="color:#f92672">::</span>drawFrame() {
    postAndWait();
    <span style="color:#66d9ef">return</span> mSyncResult;
}
</code></pre></div><h4 id="drawframetaskpostandwait">DrawFrameTask::postAndWait</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> DrawFrameTask<span style="color:#f92672">::</span>postAndWait() {
    AutoMutex <span style="color:#a6e22e">_lock</span>(mLock);
    mRenderThread<span style="color:#f92672">-&gt;</span>queue().post([<span style="color:#66d9ef">this</span>]() { run(); });
    mSignal.wait(mLock);
}
</code></pre></div><h4 id="drawframetaskrun">DrawFrameTask::run</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> DrawFrameTask<span style="color:#f92672">::</span>run() {
    canUnblockUiThread <span style="color:#f92672">=</span> syncFrameState(info);
  
    <span style="color:#75715e">// Grab a copy of everything we need
</span><span style="color:#75715e"></span>    CanvasContext<span style="color:#f92672">*</span> context <span style="color:#f92672">=</span> mContext;
  
    <span style="color:#75715e">// From this point on anything in &#34;this&#34; is *UNSAFE TO ACCESS*
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (canUnblockUiThread) {
        unblockUiThread();
    }
  
    <span style="color:#66d9ef">if</span> (CC_LIKELY(canDrawThisFrame)) {
        context<span style="color:#f92672">-&gt;</span>draw();
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// wait on fences so tasks don&#39;t overlap next frame
</span><span style="color:#75715e"></span>        context<span style="color:#f92672">-&gt;</span>waitOnFences();
    }

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>canUnblockUiThread) {
        unblockUiThread();
    }
}
</code></pre></div><h4 id="canvascontextdraw">CanvasContext::draw</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> CanvasContext<span style="color:#f92672">::</span>draw() {
    mCurrentFrameInfo<span style="color:#f92672">-&gt;</span>markIssueDrawCommandsStart();
  
    Frame frame <span style="color:#f92672">=</span> mRenderPipeline<span style="color:#f92672">-&gt;</span>getFrame();

    SkRect windowDirty <span style="color:#f92672">=</span> computeDirtyRect(frame, <span style="color:#f92672">&amp;</span>dirty);

    <span style="color:#66d9ef">bool</span> drew <span style="color:#f92672">=</span> mRenderPipeline<span style="color:#f92672">-&gt;</span>draw(frame, windowDirty, dirty, mLightGeometry, <span style="color:#f92672">&amp;</span>mLayerUpdateQueue,
                                      mContentDrawBounds, mOpaque, mWideColorGamut, mLightInfo,
                                      mRenderNodes, <span style="color:#f92672">&amp;</span>(profiler()));
  
    <span style="color:#66d9ef">bool</span> didSwap <span style="color:#f92672">=</span>
            mRenderPipeline<span style="color:#f92672">-&gt;</span>swapBuffers(frame, drew, windowDirty, mCurrentFrameInfo, <span style="color:#f92672">&amp;</span>requireSwap);
}
</code></pre></div><h3 id="绘制内存的由来">绘制内存的由来</h3>
<p>DrawOp树的构建只是在普通的==用户内存==中，而部分数据对于SurfaceFlinger都是不可见的，之后又绘制到==共享内存==中的数据才会被SurfaceFlinger合成，之前分析过软件绘制的共享内存是来自匿名共享内存，那么硬件加速的共享内存来自何处呢？到这里可能要倒回去看看ViewRootImpl</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">performTraversals</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">...</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHardwareRenderer</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                hwInitialized <span style="color:#f92672">=</span> mAttachInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">mHardwareRenderer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initialize</span><span style="color:#f92672">(</span>mSurface<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hwInitialized <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>host<span style="color:#f92672">.</span><span style="color:#a6e22e">mPrivateFlags</span>
                        <span style="color:#f92672">&amp;</span> View<span style="color:#f92672">.</span><span style="color:#a6e22e">PFLAG_REQUEST_TRANSPARENT_REGIONS</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    mSurface<span style="color:#f92672">.</span><span style="color:#a6e22e">allocateBuffers</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>OutOfResourcesException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                handleOutOfResourcesException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">....</span>
      
<span style="color:#75715e">/**
</span><span style="color:#75715e"> * Allocate buffers ahead of time to avoid allocation delays during rendering
</span><span style="color:#75715e"> * @hide
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">allocateBuffers</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mLock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        checkNotReleasedLocked<span style="color:#f92672">();</span>
        nativeAllocateBuffers<span style="color:#f92672">(</span>mNativeObject<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>对于硬件加速的场景，请求SurfaceFlinger内存分配的时机会稍微提前，而不是像软件绘制，由Surface的lockCanvas发起，主要目的是：预先分配slot位置，避免在渲染的时候再申请，一是避免分配失败，浪费了CPU之前的准备工作，二是也可以将渲染线程个工作简化，减少延时。不过，还是会存在另一个问题，一个APP进程，==同一时刻会有多个Surface绘图界面，但是渲染线程只有一个，那么究竟渲染那个呢==？这个时候就需要将Surface与渲染线程（上下文）绑定。</p>
<h3 id="surface与渲染线程上下文绑定">Surface与渲染线程（上下文）绑定</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cc" data-lang="cc"><span style="color:#66d9ef">static</span> jboolean <span style="color:#a6e22e">android_view_ThreadedRenderer_initialize</span>(JNIEnv<span style="color:#f92672">*</span> env, jobject clazz,
        jlong proxyPtr, jobject jsurface) {
    RenderProxy<span style="color:#f92672">*</span> proxy <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>RenderProxy<span style="color:#f92672">*&gt;</span>(proxyPtr);
    sp<span style="color:#f92672">&lt;</span>ANativeWindow<span style="color:#f92672">&gt;</span> window <span style="color:#f92672">=</span> android_view_Surface_getNativeWindow(env, jsurface);
    <span style="color:#66d9ef">return</span> proxy<span style="color:#f92672">-&gt;</span>initialize(window);
}
</code></pre></div><p>首先通过android_view_Surface_getNativeWindowSurface获取Surface，在Native层,Surface对应一个ANativeWindow,接着，通过RenderProxy类的成员函数initialize将前面获得的ANativeWindow绑定到RenderThread</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cc" data-lang="cc"><span style="color:#66d9ef">bool</span> RenderProxy<span style="color:#f92672">::</span>initialize(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>ANativeWindow<span style="color:#f92672">&gt;&amp;</span> window) {
    SETUP_TASK(initialize);
    args<span style="color:#f92672">-&gt;</span>context <span style="color:#f92672">=</span> mContext;
    args<span style="color:#f92672">-&gt;</span>window <span style="color:#f92672">=</span> window.get();
    <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">bool</span>) postAndWait(task);
}
</code></pre></div><p>仍旧是向渲染线程发送消息，让其绑定当前Window，其实就是调用CanvasContext的initialize函数，让绘图上下文绑定绘图内存：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cc" data-lang="cc"><span style="color:#66d9ef">bool</span> CanvasContext<span style="color:#f92672">::</span>initialize(ANativeWindow<span style="color:#f92672">*</span> window) {
    setSurface(window);
    <span style="color:#66d9ef">if</span> (mCanvas) <span style="color:#66d9ef">return</span> false;
    mCanvas <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> OpenGLRenderer(mRenderThread.renderState());
    mCanvas<span style="color:#f92672">-&gt;</span>initProperties();
    <span style="color:#66d9ef">return</span> true;
}
</code></pre></div><p>CanvasContext通过setSurface将当前要渲染的Surface绑定到到RenderThread中，大概流程是通过eglApi获得一个EGLSurface，EGLSurface封装了一个绘图表面，进而，==通过eglApi将EGLSurface设定为当前渲染窗口==，并将绘图内存等信息进行同步，==之后通过RenderThread绘制的时候才能知道是在哪个窗口上进行绘制==。之后，再创建一个OpenGLRenderer对象，后面执行OpenGL相关操作的时候，其实就是通过OpenGLRenderer来进行的。</p>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/image-20200910110350423.png" alt="image-20200910110350423"></p>
<h3 id="合并操作和绘制">合并操作和绘制</h3>
<p>真正调用OpenGL绘制之前还有一些合并操作，这是Android硬件加速做的优化，回过头继续走draw流程，其实就是走OpenGLRenderer的drawRenderNode进行递归处理：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cc" data-lang="cc"><span style="color:#66d9ef">void</span> OpenGLRenderer<span style="color:#f92672">::</span>drawRenderNode(RenderNode<span style="color:#f92672">*</span> renderNode, Rect<span style="color:#f92672">&amp;</span> dirty, <span style="color:#66d9ef">int32_t</span> replayFlags) {
       ... 
        <span style="color:#f92672">&lt;!--</span><span style="color:#960050;background-color:#1e0010">构建</span>deferredList<span style="color:#f92672">--&gt;</span>
        DeferredDisplayList deferredList(mState.currentClipRect(), avoidOverdraw);
        DeferStateStruct <span style="color:#a6e22e">deferStruct</span>(deferredList, <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>, replayFlags);
        <span style="color:#f92672">&lt;!--</span><span style="color:#960050;background-color:#1e0010">合并及分组</span><span style="color:#f92672">--&gt;</span>
        renderNode<span style="color:#f92672">-&gt;</span>defer(deferStruct, <span style="color:#ae81ff">0</span>);
        <span style="color:#f92672">&lt;!--</span><span style="color:#960050;background-color:#1e0010">绘制</span>layer<span style="color:#f92672">--&gt;</span>
        flushLayers();
        startFrame();
      <span style="color:#f92672">&lt;!--</span><span style="color:#960050;background-color:#1e0010">绘制</span> DrawOp树<span style="color:#f92672">--&gt;</span>
        deferredList.flush(<span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>, dirty);
        ...
    }
</code></pre></div><p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6.assets/png-20201029100042440.png" alt="image"></p>
<p>先看下renderNode-&gt;defer(deferStruct, 0)，合并操作，DrawOp树并不是直接被绘制的，而是首先通过DeferredDisplayList进行一个合并优化，这个是Android硬件加速中采用的一种优化手段，不仅可以减少不必要的绘制，还可以将相似的绘制集中处理，提高绘制速度。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cc" data-lang="cc"><span style="color:#66d9ef">void</span> RenderNode<span style="color:#f92672">::</span>defer(DeferStateStruct<span style="color:#f92672">&amp;</span> deferStruct, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> level) {  
    DeferOperationHandler <span style="color:#a6e22e">handler</span>(deferStruct, level);  
    issueOperations<span style="color:#f92672">&lt;</span>DeferOperationHandler<span style="color:#f92672">&gt;</span>(deferStruct.mRenderer, handler);  
}
</code></pre></div><p>RenderNode::defer其实内含递归操作，比如，如果当前RenderNode代表DecorView，它就会递归所有的子View进行合并优化处理</p>
<p>合并及优化的流程及算法，其实主要就是根据DrawOp树构建DeferedDisplayList。在合并过程中，DrawOp被分为两种：需要合的与不需要合并的，并分别缓存在不同的列表中，</p>
<ol>
<li>无法合并的按照类型分别存放在Batch*mBatchLookup[kOpBatch_Count]中</li>
<li>可以合并的按照类型及MergeID存储到TinyHashMap&lt;mergeid_t, DrawBatch*&gt;mMergingBatches[kOpBatch_Count]中</li>
</ol>
<p>合并之后，DeferredDisplayList Vector&lt;Batch * &gt; mBatches 包含全部整合后的绘制命令，之后渲染即可，需要注意的是这里的合并并不是多个变一个，只是做了一个集合，主要是方便使用各资源纹理等，比如绘制文字的时候，需要根据文字的纹理进行渲染，而这个时候就需要查询文字的纹理坐标系，合并到一起方便统一处理，一次渲染，减少资源加载的浪费。</p>
<p>它的主要特点是==在另一个Render线程使用OpenGL进行绘制==，这个是它最重要的特点。而mBatches中所有的DrawOp都会通过OpenGL被绘制到GraphicBuffer中，最后通过swapBuffers通知SurfaceFlinger合成。</p>
<hr>


<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/" title="Vsync_SurfaceFlinger"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/" title="绘制原理" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1611382862"></script>
    <script src="/js/perfect-scrollbar.min.js?1611382862"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1611382862"></script>
    <script src="/js/jquery.sticky.js?1611382862"></script>
    <script src="/js/featherlight.min.js?1611382862"></script>
    <script src="/js/highlight.pack.js?1611382862"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1611382862"></script>
    <script src="/js/learn.js?1611382862"></script>
    <script src="/js/hugo-learn.js?1611382862"></script>
    
        
            <script src="/mermaid/mermaid.js?1611382862"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

