<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="description" content="Documentation for Hugo Learn Theme">
<meta name="author" content="Mathieu Cornic">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>BinderDeath :: 郑欢的学习总结</title>

    
    <link href="/css/nucleus.css?1611661807" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1611661807" rel="stylesheet">
    <link href="/css/hybrid.css?1611661807" rel="stylesheet">
    <link href="/css/featherlight.min.css?1611661807" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1611661807" rel="stylesheet">
    <link href="/css/auto-complete.css?1611661807" rel="stylesheet">
    <link href="/css/atom-one-dark.css?1611661807" rel="stylesheet">
    <link href="/css/theme.css?1611661807" rel="stylesheet">
    <link href="/css/hugo-theme.css?1611661807" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1611661807" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1611661807"></script>

    <script src="/js/auto_toc_scroll.js?1611661807"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/en'>
    <img src="/avatar.png" width="60px" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1611661807"></script>
<script type="text/javascript" src="/js/auto-complete.js?1611661807"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/huanle19891345.github.io\/\/en";
    
</script>
<script type="text/javascript" src="/js/search.js?1611661807"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/en/android/" title="android" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/">
          android
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/google/" title="google" class="dd-item
        
        
        
        ">
      <a href="/en/android/google/">
          google
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/google/supporttoandroidx/" title="supportToAndroidx" class="dd-item ">
        <a href="/en/android/google/supporttoandroidx/">
        supportToAndroidx
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/" title="系统机制原理" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/">
          系统机制原理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/" title="ashmem" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/">
          ashmem
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/" title="匿名共享内存Ashmem" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/">
        匿名共享内存Ashmem
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/" title="bitmap" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/">
          bitmap
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/" title="Bitmap" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/">
        Bitmap
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/" title="BitmapSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/">
        BitmapSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/" title="handler" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/">
          handler
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/" title="Looper" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/">
        Looper
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/" title="ThreadLocal" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/">
        ThreadLocal
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/" title="input" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/">
          input
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/" title="touchEventNative" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/">
        touchEventNative
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/kernel/" title="kernel" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/kernel/">
          kernel
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/kernel/kernel/" title="kernel" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/kernel/kernel/">
        kernel
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/sharedpreferences/" title="sharedpreferences" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/sharedpreferences/">
          sharedpreferences
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/sharedpreferences/sharedpreferences/" title="SharedPreferences" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/sharedpreferences/sharedpreferences/">
        SharedPreferences
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/" title="zygote" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/">
          zygote
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/" title="SystemServerSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/">
        SystemServerSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/" title="ZygoteSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/">
        ZygoteSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/" title="Zygote进程" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/">
        Zygote进程
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/" title="多进程" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">
          多进程
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/" title="binder" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/">
          binder
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/" title="BinderClient" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/">
        BinderClient
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/" title="BinderDeath" class="dd-item active">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/">
        BinderDeath
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/" title="BinderKernel" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/">
        BinderKernel
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/" title="BinderServer" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/">
        BinderServer
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/" title="BinderServiceManager" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/">
        BinderServiceManager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/" title="Binder原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/">
        Binder原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/" title="mmkv" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/">
          mmkv
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/" title="MMKV" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/">
        MMKV
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E9%80%80%E5%87%BA/" title="应用启动退出" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E9%80%80%E5%87%BA/">
          应用启动退出
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E9%80%80%E5%87%BA/%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8/" title="应用启动" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E9%80%80%E5%87%BA/%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8/">
        应用启动
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/" title="系统绘制" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/">
          系统绘制
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/" title="Graphics" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/">
        Graphics
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/" title="Vsync" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/">
        Vsync
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/" title="Vsync_SurfaceFlinger" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/">
        Vsync_SurfaceFlinger
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/" title="硬件加速绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/">
        硬件加速绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/" title="绘制原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/">
        绘制原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/" title="软件绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/">
        软件绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" title="跨平台" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">
          跨平台
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/" title="flutter" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/">
          flutter
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/" title="通信" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/">
          通信
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" title="Flutter消息机制" class="dd-item ">
        <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/">
        Flutter消息机制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/huanle19891345"><i class='fab fa-fw fa-github'></i> GitHub repo</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/showcase"><i class='fas fa-fw fa-camera'></i> Showcases</a>
              </li>
          
              <li>
                  <a class="padding" href="https://gohugo.io/"><i class='fas fa-fw fa-bookmark'></i> Hugo Documentation</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/credits"><i class='fas fa-fw fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/en/'>技术探索总结</a> > <a href='/en/android/'>android</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/'>系统机制原理</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/'>多进程</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/'>binder</a> > BinderDeath
          
        
          
        
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#原理总结">原理总结</a></li>
    <li><a href="#linktodeath">linkToDeath</a>
      <ul>
        <li><a href="#android_os_binderproxy_linktodeath">android_os_BinderProxy_linkToDeath</a></li>
        <li><a href="#linktodeath-1">linkToDeath</a></li>
        <li><a href="#requestdeathnotification">requestDeathNotification</a></li>
        <li><a href="#flushcommands">flushCommands</a></li>
        <li><a href="#binder_ioctl_write_read">binder_ioctl_write_read</a></li>
        <li><a href="#binder_thread_write">binder_thread_write</a></li>
      </ul>
    </li>
    <li><a href="#触发死亡通知">触发死亡通知</a>
      <ul>
        <li><a href="#binder_fops">binder_fops</a></li>
        <li><a href="#binder_release">binder_release</a></li>
        <li><a href="#binder_defer_work">binder_defer_work</a></li>
        <li><a href="#queue_work">queue_work</a></li>
        <li><a href="#binder_deferred_func">binder_deferred_func</a></li>
        <li><a href="#binder_deferred_release">binder_deferred_release</a></li>
      </ul>
    </li>
    <li><a href="#处理死亡通知">处理死亡通知</a>
      <ul>
        <li><a href="#binder_thread_read">binder_thread_read</a></li>
        <li><a href="#getandexecutecommand">getAndExecuteCommand</a></li>
        <li><a href="#executecommand">executeCommand</a></li>
        <li><a href="#sendobituary">sendObituary</a></li>
        <li><a href="#reportonedeath">reportOneDeath</a></li>
      </ul>
    </li>
    <li><a href="#结论">结论</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              BinderDeath
            </h1>
          

        


<h2 id="原理总结">原理总结</h2>
<p><a href="http://gityuan.com/2016/10/03/binder_linktodeath/">Binder死亡通知机制之linkToDeath</a></p>
<p>UnlinkToDeath流程类似，参考上文，不做记录</p>
<p>死亡通知是为了让Bp端(客户端进程)进能知晓Bn端(服务端进程)的生死情况，当Bn端进程死亡后能通知到Bp端。</p>
<ul>
<li>定义：AppDeathRecipient是继承IBinder::DeathRecipient类，主要需要实现其binderDied()来进行死亡通告。</li>
<li>注册：binder-&gt;linkToDeath(AppDeathRecipient)是为了将AppDeathRecipient死亡通知注册到Binder上。</li>
</ul>
<p>Bp端只需要覆写binderDied()方法，实现一些后尾清除类的工作，则在Bn端死掉后，会回调binderDied()进行相应处理。</p>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath.assets/linktodeath.jpg" alt=""></p>
<h2 id="linktodeath">linkToDeath</h2>
<h3 id="android_os_binderproxy_linktodeath">android_os_BinderProxy_linkToDeath</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">android_os_BinderProxy_linkToDeath</span>(JNIEnv<span style="color:#f92672">*</span> env, jobject obj,
        jobject recipient, jint flags)
{
      <span style="color:#75715e">//获取BinderProxy.mObject成员变量值, 即BpBinder对象
</span><span style="color:#75715e"></span>    IBinder<span style="color:#f92672">*</span> target <span style="color:#f92672">=</span> (IBinder<span style="color:#f92672">*</span>)env<span style="color:#f92672">-&gt;</span>GetLongField(obj, gBinderProxyOffsets.mObject);
  
    sp<span style="color:#f92672">&lt;</span>JavaDeathRecipient<span style="color:#f92672">&gt;</span> jdr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JavaDeathRecipient(env, recipient, list);
        <span style="color:#75715e">//建立死亡通知[见小节2.2]
</span><span style="color:#75715e"></span>    status_t err <span style="color:#f92672">=</span> target<span style="color:#f92672">-&gt;</span>linkToDeath(jdr, NULL, flags);
}
</code></pre></div><ul>
<li>获取DeathRecipientList: 其成员变量mList记录该BinderProxy的JavaDeathRecipient列表信息；
<ul>
<li>一个BpBinder可以注册多个死亡回调</li>
</ul>
</li>
<li>创建JavaDeathRecipient: 继承于IBinder::DeathRecipient</li>
</ul>
<h3 id="linktodeath-1">linkToDeath</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t BpBinder<span style="color:#f92672">::</span>linkToDeath(
    <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>DeathRecipient<span style="color:#f92672">&gt;&amp;</span> recipient, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> cookie, <span style="color:#66d9ef">uint32_t</span> flags)
{
      IPCThreadState<span style="color:#f92672">*</span> self <span style="color:#f92672">=</span> IPCThreadState<span style="color:#f92672">::</span>self();
      self<span style="color:#f92672">-&gt;</span>requestDeathNotification(mHandle, <span style="color:#66d9ef">this</span>);
      self<span style="color:#f92672">-&gt;</span>flushCommands();
}
</code></pre></div><h3 id="requestdeathnotification">requestDeathNotification</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#f92672">::</span>requestDeathNotification(<span style="color:#66d9ef">int32_t</span> handle, BpBinder<span style="color:#f92672">*</span> proxy)
{
    mOut.writeInt32(BC_REQUEST_DEATH_NOTIFICATION);
    mOut.writeInt32((<span style="color:#66d9ef">int32_t</span>)handle);
    mOut.writePointer((uintptr_t)proxy);
    <span style="color:#66d9ef">return</span> NO_ERROR;
}
</code></pre></div><h3 id="flushcommands">flushCommands</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> IPCThreadState<span style="color:#f92672">::</span>flushCommands()
{
    <span style="color:#66d9ef">if</span> (mProcess<span style="color:#f92672">-&gt;</span>mDriverFD <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
        <span style="color:#66d9ef">return</span>;
    talkWithDriver(false);
}
</code></pre></div><h3 id="binder_ioctl_write_read">binder_ioctl_write_read</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">binder_ioctl_write_read</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span>filp,
                <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> cmd, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> arg,
                <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_thread</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">thread</span>)
{
    <span style="color:#66d9ef">int</span> ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span> <span style="color:#f92672">*</span>proc <span style="color:#f92672">=</span> filp<span style="color:#f92672">-&gt;</span>private_data;
    <span style="color:#66d9ef">void</span> __user <span style="color:#f92672">*</span>ubuf <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> __user <span style="color:#f92672">*</span>)arg;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_write_read</span> bwr;

    <span style="color:#66d9ef">if</span> (copy_from_user(<span style="color:#f92672">&amp;</span>bwr, ubuf, <span style="color:#66d9ef">sizeof</span>(bwr))) { <span style="color:#75715e">//把用户空间数据ubuf拷贝到bwr
</span><span style="color:#75715e"></span>        ret <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>EFAULT;
        <span style="color:#66d9ef">goto</span> out;
    }
    <span style="color:#66d9ef">if</span> (bwr.write_size <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) { <span style="color:#75715e">//此时写缓存有数据【见小节3.2】
</span><span style="color:#75715e"></span>        ret <span style="color:#f92672">=</span> binder_thread_write(proc, <span style="color:#66d9ef">thread</span>,
                  bwr.write_buffer, bwr.write_size, <span style="color:#f92672">&amp;</span>bwr.write_consumed);
         ...
    }

    <span style="color:#66d9ef">if</span> (bwr.read_size <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) { <span style="color:#75715e">//此时读缓存没有数据
</span><span style="color:#75715e"></span>      ...
    }

    <span style="color:#66d9ef">if</span> (copy_to_user(ubuf, <span style="color:#f92672">&amp;</span>bwr, <span style="color:#66d9ef">sizeof</span>(bwr))) { <span style="color:#75715e">//将内核数据bwr拷贝到用户空间ubuf
</span><span style="color:#75715e"></span>        ret <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>EFAULT;
        <span style="color:#66d9ef">goto</span> out;
    }
out:
    <span style="color:#66d9ef">return</span> ret;
}
</code></pre></div><h3 id="binder_thread_write">binder_thread_write</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">binder_thread_write</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span> <span style="color:#f92672">*</span>proc,
      <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_thread</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">thread</span>,
      binder_uintptr_t binder_buffer, size_t size,
      binder_size_t <span style="color:#f92672">*</span>consumed)
{
  <span style="color:#66d9ef">uint32_t</span> cmd;
  <span style="color:#75715e">//proc, thread都是指当前发起端进程的信息
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (ptr <span style="color:#f92672">&lt;</span> end <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">thread</span><span style="color:#f92672">-&gt;</span>return_error <span style="color:#f92672">==</span> BR_OK) {
    get_user(cmd, (<span style="color:#66d9ef">uint32_t</span> __user <span style="color:#f92672">*</span>)ptr); <span style="color:#75715e">//获取BC_REQUEST_DEATH_NOTIFICATION
</span><span style="color:#75715e"></span>    ptr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint32_t</span>);
    <span style="color:#66d9ef">switch</span> (cmd) {
        <span style="color:#66d9ef">case</span> BC_REQUEST_DEATH_NOTIFICATION:{ <span style="color:#75715e">//注册死亡通知
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">uint32_t</span> target;
            <span style="color:#66d9ef">void</span> __user <span style="color:#f92672">*</span>cookie;
            <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_ref</span> <span style="color:#f92672">*</span>ref;
            <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_ref_death</span> <span style="color:#f92672">*</span>death;

            get_user(target, (<span style="color:#66d9ef">uint32_t</span> __user <span style="color:#f92672">*</span>)ptr); <span style="color:#75715e">//获取target
</span><span style="color:#75715e"></span>            ptr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint32_t</span>);
            get_user(cookie, (<span style="color:#66d9ef">void</span> __user <span style="color:#f92672">*</span> __user <span style="color:#f92672">*</span>)ptr); <span style="color:#75715e">//获取BpBinder
</span><span style="color:#75715e"></span>            ptr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>);

            ref <span style="color:#f92672">=</span> binder_get_ref(proc, target); <span style="color:#75715e">//拿到目标服务的binder_ref
</span><span style="color:#75715e"></span>
            <span style="color:#66d9ef">if</span> (cmd <span style="color:#f92672">==</span> BC_REQUEST_DEATH_NOTIFICATION) {
                <span style="color:#75715e">//native Bp可注册多个，但Kernel只允许注册一个死亡通知
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (ref<span style="color:#f92672">-&gt;</span>death) {
                    <span style="color:#66d9ef">break</span>; 
                }
                death <span style="color:#f92672">=</span> kzalloc(<span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>death), GFP_KERNEL);

                INIT_LIST_HEAD(<span style="color:#f92672">&amp;</span>death<span style="color:#f92672">-&gt;</span>work.entry);
                death<span style="color:#f92672">-&gt;</span>cookie <span style="color:#f92672">=</span> cookie; <span style="color:#75715e">//BpBinder指针
</span><span style="color:#75715e"></span>                ref<span style="color:#f92672">-&gt;</span>death <span style="color:#f92672">=</span> death;
                <span style="color:#75715e">//当目标binder服务所在进程已死,则直接发送死亡通知。这是非常规情况
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (ref<span style="color:#f92672">-&gt;</span>node<span style="color:#f92672">-&gt;</span>proc <span style="color:#f92672">==</span> NULL) { 
                    ref<span style="color:#f92672">-&gt;</span>death<span style="color:#f92672">-&gt;</span>work.type <span style="color:#f92672">=</span> BINDER_WORK_DEAD_BINDER;
                    <span style="color:#75715e">//当前线程为binder线程,则直接添加到当前线程的todo队列. 
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">thread</span><span style="color:#f92672">-&gt;</span>looper <span style="color:#f92672">&amp;</span> (BINDER_LOOPER_STATE_REGISTERED <span style="color:#f92672">|</span> BINDER_LOOPER_STATE_ENTERED)) {
                        list_add_tail(<span style="color:#f92672">&amp;</span>ref<span style="color:#f92672">-&gt;</span>death<span style="color:#f92672">-&gt;</span>work.entry, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">thread</span><span style="color:#f92672">-&gt;</span>todo);
                    } <span style="color:#66d9ef">else</span> {
                        list_add_tail(<span style="color:#f92672">&amp;</span>ref<span style="color:#f92672">-&gt;</span>death<span style="color:#f92672">-&gt;</span>work.entry, <span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>todo);
                        wake_up_interruptible(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>wait);
                    }
                }
            } <span style="color:#66d9ef">else</span> {
                ...
            }
</code></pre></div><p>在处理BC_REQUEST_DEATH_NOTIFICATION过程，正好遇到对端目标binder服务所在进程已死的情况， 向todo队列增加BINDER_WORK_DEAD_BINDER事务，直接发送死亡通知，但这属于非常规情况。</p>
<p>更常见的场景是binder服务所在进程死亡后,会调用binder_release方法, 然后调用binder_node_release.这个过程便会发出死亡通知的回调.</p>
<h2 id="触发死亡通知">触发死亡通知</h2>
<p>当Binder服务所在进程死亡后，会释放进程相关的资源，Binder也是一种资源。 binder_open打开binder驱动/dev/binder，这是字符设备，获取文件描述符。在进程结束的时候会有一个关闭文件系统的过程中会调用驱动close方法，该方法相对应的是release()方法。当binder的fd被释放后，此处调用相应的方法是binder_release().</p>
<p>但并不是每个close系统调用都会触发调用release()方法. 只有真正释放设备数据结构才调用release(),内核维持一个文件结构被使用多少次的计数，即便是应用程序没有明显地关闭它打开的文件也适用: 内核在进程exit()时会释放所有内存和关闭相应的文件资源, 通过使用close系统调用最终也会release binder.</p>
<p>[-&gt; binder.c]</p>
<h3 id="binder_fops">binder_fops</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">file_operations</span> binder_fops <span style="color:#f92672">=</span> {
  .owner <span style="color:#f92672">=</span> THIS_MODULE,
  .poll <span style="color:#f92672">=</span> binder_poll,
  .unlocked_ioctl <span style="color:#f92672">=</span> binder_ioctl,
  .compat_ioctl <span style="color:#f92672">=</span> binder_ioctl,
  .mmap <span style="color:#f92672">=</span> binder_mmap,
  .open <span style="color:#f92672">=</span> binder_open,
  .flush <span style="color:#f92672">=</span> binder_flush,
  .release <span style="color:#f92672">=</span> binder_release, <span style="color:#75715e">//对应于release的方法
</span><span style="color:#75715e"></span>};
</code></pre></div><h3 id="binder_release">binder_release</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">binder_release</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">inode</span> <span style="color:#f92672">*</span>nodp, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span>filp)
{
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span> <span style="color:#f92672">*</span>proc <span style="color:#f92672">=</span> filp<span style="color:#f92672">-&gt;</span>private_data;
  debugfs_remove(proc<span style="color:#f92672">-&gt;</span>debugfs_entry);
  binder_defer_work(proc, BINDER_DEFERRED_RELEASE);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h3 id="binder_defer_work">binder_defer_work</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">binder_defer_work</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span> <span style="color:#f92672">*</span>proc, <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">binder_deferred_state</span> defer) {
  mutex_lock(<span style="color:#f92672">&amp;</span>binder_deferred_lock); <span style="color:#75715e">//获取锁
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//添加BINDER_DEFERRED_RELEASE
</span><span style="color:#75715e"></span>  proc<span style="color:#f92672">-&gt;</span>deferred_work <span style="color:#f92672">|=</span> defer; 
  <span style="color:#66d9ef">if</span> (hlist_unhashed(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>deferred_work_node)) {
    hlist_add_head(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>deferred_work_node, <span style="color:#f92672">&amp;</span>binder_deferred_list);
    <span style="color:#75715e">//向工作队列添加binder_deferred_work [见小节4.4]
</span><span style="color:#75715e"></span>    queue_work(binder_deferred_workqueue, <span style="color:#f92672">&amp;</span>binder_deferred_work);
  }
  mutex_unlock(<span style="color:#f92672">&amp;</span>binder_deferred_lock); <span style="color:#75715e">//释放锁
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="queue_work">queue_work</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">//全局工作队列
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">workqueue_struct</span> <span style="color:#f92672">*</span>binder_deferred_workqueue;

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> __init <span style="color:#a6e22e">binder_init</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#66d9ef">int</span> ret;
  <span style="color:#75715e">//创建了名叫“binder”的工作队列
</span><span style="color:#75715e"></span>  binder_deferred_workqueue <span style="color:#f92672">=</span> create_singlethread_workqueue(<span style="color:#e6db74">&#34;binder&#34;</span>);
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>binder_deferred_workqueue)
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
  ...
}

device_initcall(binder_init);
</code></pre></div><p>关于binder_deferred_work的定义：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#a6e22e">DECLARE_WORK</span>(binder_deferred_work, binder_deferred_func);
</code></pre></div><p>在Binder设备驱动初始化的过程执行binder_init()方法中，调用 create_singlethread_workqueue(“binder”)，创建了名叫“binder”的工作队列(workqueue)。 workqueue是kernel提供的一种实现简单而有效的内核线程机制，可延迟执行任务。</p>
<p>此处binder_deferred_work的func为binder_deferred_func，接下来看该方法。</p>
<h3 id="binder_deferred_func">binder_deferred_func</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">binder_deferred_func</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">work_struct</span> <span style="color:#f92672">*</span>work)
{
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span> <span style="color:#f92672">*</span>proc;
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">files_struct</span> <span style="color:#f92672">*</span>files;

  <span style="color:#66d9ef">int</span> defer;
  <span style="color:#66d9ef">do</span> {
    mutex_lock(<span style="color:#f92672">&amp;</span>binder_main_lock); <span style="color:#75715e">//获取binder_main_lock
</span><span style="color:#75715e"></span>    mutex_lock(<span style="color:#f92672">&amp;</span>binder_deferred_lock);
    preempt_disable(); <span style="color:#75715e">//禁止CPU抢占
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>hlist_empty(<span style="color:#f92672">&amp;</span>binder_deferred_list)) {
      proc <span style="color:#f92672">=</span> hlist_entry(binder_deferred_list.first,
          <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span>, deferred_work_node);
      hlist_del_init(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>deferred_work_node);
      defer <span style="color:#f92672">=</span> proc<span style="color:#f92672">-&gt;</span>deferred_work;
      proc<span style="color:#f92672">-&gt;</span>deferred_work <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    } <span style="color:#66d9ef">else</span> {
      proc <span style="color:#f92672">=</span> NULL;
      defer <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
    mutex_unlock(<span style="color:#f92672">&amp;</span>binder_deferred_lock);

    files <span style="color:#f92672">=</span> NULL;
    <span style="color:#66d9ef">if</span> (defer <span style="color:#f92672">&amp;</span> BINDER_DEFERRED_PUT_FILES) {
      files <span style="color:#f92672">=</span> proc<span style="color:#f92672">-&gt;</span>files;
      <span style="color:#66d9ef">if</span> (files)
        proc<span style="color:#f92672">-&gt;</span>files <span style="color:#f92672">=</span> NULL;
    }

    <span style="color:#66d9ef">if</span> (defer <span style="color:#f92672">&amp;</span> BINDER_DEFERRED_FLUSH)
      binder_deferred_flush(proc);

    <span style="color:#66d9ef">if</span> (defer <span style="color:#f92672">&amp;</span> BINDER_DEFERRED_RELEASE)
      binder_deferred_release(proc); <span style="color:#75715e">//[见小节4.6]
</span><span style="color:#75715e"></span>
    mutex_unlock(<span style="color:#f92672">&amp;</span>binder_main_lock); <span style="color:#75715e">//释放锁
</span><span style="color:#75715e"></span>    preempt_enable_no_resched(); 
    <span style="color:#66d9ef">if</span> (files)
      put_files_struct(files);
  } <span style="color:#66d9ef">while</span> (proc);
}
</code></pre></div><h3 id="binder_deferred_release">binder_deferred_release</h3>
<p>此处proc是来自Bn端的binder_proc</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">binder_deferred_release</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span> <span style="color:#f92672">*</span>proc)
{
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_transaction</span> <span style="color:#f92672">*</span>t;
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">rb_node</span> <span style="color:#f92672">*</span>n;
  <span style="color:#66d9ef">int</span> threads, nodes, incoming_refs, outgoing_refs, buffers,
    active_transactions, page_count;

  hlist_del(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>proc_node); <span style="color:#75715e">//删除proc_node节点
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">if</span> (binder_context_mgr_node <span style="color:#f92672">&amp;&amp;</span> binder_context_mgr_node<span style="color:#f92672">-&gt;</span>proc <span style="color:#f92672">==</span> proc) {
    binder_context_mgr_node <span style="color:#f92672">=</span> NULL;
  }

  <span style="color:#75715e">//释放binder_thread[见小节4.6.1]
</span><span style="color:#75715e"></span>  threads <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  active_transactions <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">while</span> ((n <span style="color:#f92672">=</span> rb_first(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>threads))) {
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_thread</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">thread</span>;
    <span style="color:#66d9ef">thread</span> <span style="color:#f92672">=</span> rb_entry(n, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_thread</span>, rb_node);
    threads<span style="color:#f92672">++</span>;
    active_transactions <span style="color:#f92672">+=</span> binder_free_thread(proc, <span style="color:#66d9ef">thread</span>);
  }

  <span style="color:#75715e">//释放binder_node [见小节4.6.2]
</span><span style="color:#75715e"></span>  nodes <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  incoming_refs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">while</span> ((n <span style="color:#f92672">=</span> rb_first(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>nodes))) {
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_node</span> <span style="color:#f92672">*</span>node;
    node <span style="color:#f92672">=</span> rb_entry(n, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_node</span>, rb_node);
    nodes<span style="color:#f92672">++</span>;
    rb_erase(<span style="color:#f92672">&amp;</span>node<span style="color:#f92672">-&gt;</span>rb_node, <span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>nodes);
    incoming_refs <span style="color:#f92672">=</span> binder_node_release(node, incoming_refs);<span style="color:#75715e">//key
</span><span style="color:#75715e"></span>  }

  <span style="color:#75715e">//释放binder_ref [见小节4.6.3]
</span><span style="color:#75715e"></span>  outgoing_refs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">while</span> ((n <span style="color:#f92672">=</span> rb_first(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>refs_by_desc))) {
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_ref</span> <span style="color:#f92672">*</span>ref;

    ref <span style="color:#f92672">=</span> rb_entry(n, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_ref</span>, rb_node_desc);
    outgoing_refs<span style="color:#f92672">++</span>;
    binder_delete_ref(ref);
  }
  
  <span style="color:#75715e">//释放binder_work [见小节4.6.4]
</span><span style="color:#75715e"></span>  binder_release_work(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>todo);
  binder_release_work(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>delivered_death);

  buffers <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">while</span> ((n <span style="color:#f92672">=</span> rb_first(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>allocated_buffers))) {
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_buffer</span> <span style="color:#f92672">*</span>buffer;
    buffer <span style="color:#f92672">=</span> rb_entry(n, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_buffer</span>, rb_node);

    t <span style="color:#f92672">=</span> buffer<span style="color:#f92672">-&gt;</span>transaction;
    <span style="color:#66d9ef">if</span> (t) {
      t<span style="color:#f92672">-&gt;</span>buffer <span style="color:#f92672">=</span> NULL;
      buffer<span style="color:#f92672">-&gt;</span>transaction <span style="color:#f92672">=</span> NULL;
    }
    <span style="color:#75715e">//释放binder_buf [见小节4.6.5]
</span><span style="color:#75715e"></span>    binder_free_buf(proc, buffer);
    buffers<span style="color:#f92672">++</span>;
  }

  binder_stats_deleted(BINDER_STAT_PROC);

  page_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> (proc<span style="color:#f92672">-&gt;</span>pages) {
    <span style="color:#66d9ef">int</span> i;

    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> proc<span style="color:#f92672">-&gt;</span>buffer_size <span style="color:#f92672">/</span> PAGE_SIZE; i<span style="color:#f92672">++</span>) {
      <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>page_addr;
      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>proc<span style="color:#f92672">-&gt;</span>pages[i])
        <span style="color:#66d9ef">continue</span>;

      page_addr <span style="color:#f92672">=</span> proc<span style="color:#f92672">-&gt;</span>buffer <span style="color:#f92672">+</span> i <span style="color:#f92672">*</span> PAGE_SIZE;
      unmap_kernel_range((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)page_addr, PAGE_SIZE);
      __free_page(proc<span style="color:#f92672">-&gt;</span>pages[i]);
      page_count<span style="color:#f92672">++</span>;
    }
    kfree(proc<span style="color:#f92672">-&gt;</span>pages);
    vfree(proc<span style="color:#f92672">-&gt;</span>buffer);
  }
  put_task_struct(proc<span style="color:#f92672">-&gt;</span>tsk);
  kfree(proc);
}
</code></pre></div><p>binder_deferred_release的主要工作有：</p>
<ol>
<li>binder_free_thread： proc-&gt;threads所有线程
<ul>
<li>binder_send_failed_reply(send_reply, BR_DEAD_REPLY)：将发起方线程的return_error值设置为BR_DEAD_REPLY，让其直接返回；</li>
</ul>
</li>
<li>binder_node_release: proc-&gt;nodes所有节点
<ul>
<li>binder_release_work(&amp;node-&gt;async_todo)</li>
<li>node-&gt;refs的所有死亡回调</li>
</ul>
</li>
<li>binder_delete_ref: proc-&gt;refs_by_desc所有引用
<ul>
<li>清除引用</li>
</ul>
</li>
<li>binder_release_work: proc-&gt;todo, proc-&gt;delivered_death
<ul>
<li>binder_send_failed_reply(t, BR_DEAD_REPLY)</li>
</ul>
</li>
<li>binder_free_buf: proc-&gt;allocated_buffers所有已分配buffer
<ul>
<li>释放已分配的buffer</li>
</ul>
</li>
<li>__free_page: proc-&gt;pages所有物理内存页</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">binder_node_release</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_node</span> <span style="color:#f92672">*</span>node, <span style="color:#66d9ef">int</span> refs)
{
  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_ref</span> <span style="color:#f92672">*</span>ref;
  <span style="color:#66d9ef">int</span> death <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

  list_del_init(<span style="color:#f92672">&amp;</span>node<span style="color:#f92672">-&gt;</span>work.entry);
  <span style="color:#75715e">//[见小节4.6.4]
</span><span style="color:#75715e"></span>  binder_release_work(<span style="color:#f92672">&amp;</span>node<span style="color:#f92672">-&gt;</span>async_todo);

  <span style="color:#66d9ef">if</span> (hlist_empty(<span style="color:#f92672">&amp;</span>node<span style="color:#f92672">-&gt;</span>refs)) {
    kfree(node); <span style="color:#75715e">//引用为空，则直接删除节点
</span><span style="color:#75715e"></span>    binder_stats_deleted(BINDER_STAT_NODE);
    <span style="color:#66d9ef">return</span> refs;
  }

  node<span style="color:#f92672">-&gt;</span>proc <span style="color:#f92672">=</span> NULL;
  node<span style="color:#f92672">-&gt;</span>local_strong_refs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  node<span style="color:#f92672">-&gt;</span>local_weak_refs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  hlist_add_head(<span style="color:#f92672">&amp;</span>node<span style="color:#f92672">-&gt;</span>dead_node, <span style="color:#f92672">&amp;</span>binder_dead_nodes);

  hlist_for_each_entry(ref, <span style="color:#f92672">&amp;</span>node<span style="color:#f92672">-&gt;</span>refs, node_entry) {
    refs<span style="color:#f92672">++</span>;
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ref<span style="color:#f92672">-&gt;</span>death)
      <span style="color:#66d9ef">continue</span>;
    death<span style="color:#f92672">++</span>;

    <span style="color:#66d9ef">if</span> (list_empty(<span style="color:#f92672">&amp;</span>ref<span style="color:#f92672">-&gt;</span>death<span style="color:#f92672">-&gt;</span>work.entry)) {
      <span style="color:#75715e">//添加BINDER_WORK_DEAD_BINDER事务到todo队列 [见小节5.1]
</span><span style="color:#75715e"></span>      ref<span style="color:#f92672">-&gt;</span>death<span style="color:#f92672">-&gt;</span>work.type <span style="color:#f92672">=</span> BINDER_WORK_DEAD_BINDER;
      list_add_tail(<span style="color:#f92672">&amp;</span>ref<span style="color:#f92672">-&gt;</span>death<span style="color:#f92672">-&gt;</span>work.entry, <span style="color:#f92672">&amp;</span>ref<span style="color:#f92672">-&gt;</span>proc<span style="color:#f92672">-&gt;</span>todo);
      wake_up_interruptible(<span style="color:#f92672">&amp;</span>ref<span style="color:#f92672">-&gt;</span>proc<span style="color:#f92672">-&gt;</span>wait);
    } 
  }
  <span style="color:#66d9ef">return</span> refs;
}
</code></pre></div><p>该方法会遍历该binder_node所有的binder_ref, 当存在binder死亡通知，则向相应的binder_ref 所在进程的todo队列添加BINDER_WORK_DEAD_BINDER事务并唤醒处于proc-&gt;wait的binder线程,执行binder_thread_read</p>
<h2 id="处理死亡通知">处理死亡通知</h2>
<h3 id="binder_thread_read">binder_thread_read</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">binder_thread_read</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_proc</span> <span style="color:#f92672">*</span>proc,
                  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_thread</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">thread</span>,
                  binder_uintptr_t binder_buffer, size_t size,
                  binder_size_t <span style="color:#f92672">*</span>consumed, <span style="color:#66d9ef">int</span> non_block)
    ...
    <span style="color:#75715e">//唤醒等待中的binder线程
</span><span style="color:#75715e"></span>    wait_event_freezable_exclusive(proc<span style="color:#f92672">-&gt;</span>wait, binder_has_proc_work(proc, <span style="color:#66d9ef">thread</span>));
    binder_lock(__func__); <span style="color:#75715e">//加锁
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (wait_for_proc_work)
        proc<span style="color:#f92672">-&gt;</span>ready_threads<span style="color:#f92672">--</span>; <span style="color:#75715e">//空闲的binder线程减1
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">thread</span><span style="color:#f92672">-&gt;</span>looper <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>BINDER_LOOPER_STATE_WAITING;

    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
        <span style="color:#66d9ef">uint32_t</span> cmd;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_transaction_data</span> tr;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_work</span> <span style="color:#f92672">*</span>w;
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_transaction</span> <span style="color:#f92672">*</span>t <span style="color:#f92672">=</span> NULL;

        <span style="color:#75715e">//从todo队列拿出前面放入的binder_work, 此时type为BINDER_WORK_DEAD_BINDER
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>list_empty(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">thread</span><span style="color:#f92672">-&gt;</span>todo)) {
            w <span style="color:#f92672">=</span> list_first_entry(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">thread</span><span style="color:#f92672">-&gt;</span>todo, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_work</span>,
                         entry);
        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#f92672">!</span>list_empty(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>todo) <span style="color:#f92672">&amp;&amp;</span> wait_for_proc_work) {
            w <span style="color:#f92672">=</span> list_first_entry(<span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>todo, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_work</span>,
                         entry);
        }

        <span style="color:#66d9ef">switch</span> (w<span style="color:#f92672">-&gt;</span>type) {
            <span style="color:#66d9ef">case</span> BINDER_WORK_DEAD_BINDER: {
              <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_ref_death</span> <span style="color:#f92672">*</span>death;
              <span style="color:#66d9ef">uint32_t</span> cmd;

              death <span style="color:#f92672">=</span> container_of(w, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">binder_ref_death</span>, work);
              <span style="color:#66d9ef">if</span> (w<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> BINDER_WORK_CLEAR_DEATH_NOTIFICATION)
                  ...
              <span style="color:#66d9ef">else</span>
                  cmd <span style="color:#f92672">=</span> BR_DEAD_BINDER; <span style="color:#75715e">//进入此分支
</span><span style="color:#75715e"></span>              put_user(cmd, (<span style="color:#66d9ef">uint32_t</span> __user <span style="color:#f92672">*</span>)ptr);<span style="color:#75715e">//拷贝到用户空间[见小节5.2]
</span><span style="color:#75715e"></span>              ptr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">uint32_t</span>);

              <span style="color:#75715e">//此处的cookie是前面传递的BpBinder
</span><span style="color:#75715e"></span>              put_user(death<span style="color:#f92672">-&gt;</span>cookie, (binder_uintptr_t __user <span style="color:#f92672">*</span>)ptr);
              ptr <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(binder_uintptr_t);

              <span style="color:#66d9ef">if</span> (w<span style="color:#f92672">-&gt;</span>type <span style="color:#f92672">==</span> BINDER_WORK_CLEAR_DEATH_NOTIFICATION) {
                  ...
              } <span style="color:#66d9ef">else</span>
                  <span style="color:#75715e">//把该work加入到delivered_death队列
</span><span style="color:#75715e"></span>                  list_move(<span style="color:#f92672">&amp;</span>w<span style="color:#f92672">-&gt;</span>entry, <span style="color:#f92672">&amp;</span>proc<span style="color:#f92672">-&gt;</span>delivered_death);
              <span style="color:#66d9ef">if</span> (cmd <span style="color:#f92672">==</span> BR_DEAD_BINDER)
                  <span style="color:#66d9ef">goto</span> done;
            } <span style="color:#66d9ef">break</span>;
        }
    }
    ...
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>将命令BR_DEAD_BINDER写到用户空间，此时用户空间执行过程：</p>
<h3 id="getandexecutecommand">getAndExecuteCommand</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#f92672">::</span>getAndExecuteCommand()
{
    status_t result;
    <span style="color:#66d9ef">int32_t</span> cmd;

    result <span style="color:#f92672">=</span> talkWithDriver(); <span style="color:#75715e">//该Binder Driver进行交互
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">&gt;=</span> NO_ERROR) {
        size_t IN <span style="color:#f92672">=</span> mIn.dataAvail();
        <span style="color:#66d9ef">if</span> (IN <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int32_t</span>)) <span style="color:#66d9ef">return</span> result;
        cmd <span style="color:#f92672">=</span> mIn.readInt32(); <span style="color:#75715e">//读取命令
</span><span style="color:#75715e"></span>
        pthread_mutex_lock(<span style="color:#f92672">&amp;</span>mProcess<span style="color:#f92672">-&gt;</span>mThreadCountLock);
        mProcess<span style="color:#f92672">-&gt;</span>mExecutingThreadsCount<span style="color:#f92672">++</span>;
        pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mProcess<span style="color:#f92672">-&gt;</span>mThreadCountLock);

        result <span style="color:#f92672">=</span> executeCommand(cmd); <span style="color:#75715e">//【见小节5.3】
</span><span style="color:#75715e"></span>
        pthread_mutex_lock(<span style="color:#f92672">&amp;</span>mProcess<span style="color:#f92672">-&gt;</span>mThreadCountLock);
        mProcess<span style="color:#f92672">-&gt;</span>mExecutingThreadsCount<span style="color:#f92672">--</span>;
        pthread_cond_broadcast(<span style="color:#f92672">&amp;</span>mProcess<span style="color:#f92672">-&gt;</span>mThreadCountDecrement);
        pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mProcess<span style="color:#f92672">-&gt;</span>mThreadCountLock);

        set_sched_policy(mMyThreadId, SP_FOREGROUND);
    }
    <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><h3 id="executecommand">executeCommand</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#f92672">::</span>executeCommand(<span style="color:#66d9ef">int32_t</span> cmd)
{
    BBinder<span style="color:#f92672">*</span> obj;
    RefBase<span style="color:#f92672">::</span>weakref_type<span style="color:#f92672">*</span> refs;
    status_t result <span style="color:#f92672">=</span> NO_ERROR;

    <span style="color:#66d9ef">switch</span> ((<span style="color:#66d9ef">uint32_t</span>)cmd) {
      <span style="color:#66d9ef">case</span> BR_DEAD_BINDER:
      {
          BpBinder <span style="color:#f92672">*</span>proxy <span style="color:#f92672">=</span> (BpBinder<span style="color:#f92672">*</span>)mIn.readPointer();
          proxy<span style="color:#f92672">-&gt;</span>sendObituary(); <span style="color:#75715e">//[见小节5.4]
</span><span style="color:#75715e"></span>          mOut.writeInt32(BC_DEAD_BINDER_DONE);
          mOut.writePointer((uintptr_t)proxy);
      } <span style="color:#66d9ef">break</span>;
      ...
    }
    ...
    <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><p>同一个bp端即便注册多次死亡通知，但只会发送一次死亡回调。</p>
<h3 id="sendobituary">sendObituary</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> BpBinder<span style="color:#f92672">::</span>sendObituary()
{
    mAlive <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">if</span> (mObitsSent) <span style="color:#66d9ef">return</span>;

    mLock.lock();
    Vector<span style="color:#f92672">&lt;</span>Obituary<span style="color:#f92672">&gt;*</span> obits <span style="color:#f92672">=</span> mObituaries;
    <span style="color:#66d9ef">if</span>(obits <span style="color:#f92672">!=</span> NULL) {
        IPCThreadState<span style="color:#f92672">*</span> self <span style="color:#f92672">=</span> IPCThreadState<span style="color:#f92672">::</span>self();
        <span style="color:#75715e">//清空死亡通知[见小节6.2]
</span><span style="color:#75715e"></span>        self<span style="color:#f92672">-&gt;</span>clearDeathNotification(mHandle, <span style="color:#66d9ef">this</span>);
        self<span style="color:#f92672">-&gt;</span>flushCommands();
        mObituaries <span style="color:#f92672">=</span> NULL;
    }
    mObitsSent <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    mLock.unlock();

    <span style="color:#66d9ef">if</span> (obits <span style="color:#f92672">!=</span> NULL) {
        <span style="color:#66d9ef">const</span> size_t N <span style="color:#f92672">=</span> obits<span style="color:#f92672">-&gt;</span>size();
        <span style="color:#66d9ef">for</span> (size_t i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>N; i<span style="color:#f92672">++</span>) {
            <span style="color:#75715e">//发送死亡通知 [见小节5.5]
</span><span style="color:#75715e"></span>            reportOneDeath(obits<span style="color:#f92672">-&gt;</span>itemAt(i));
        }
        <span style="color:#66d9ef">delete</span> obits;
    }
}
</code></pre></div><h3 id="reportonedeath">reportOneDeath</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> BpBinder<span style="color:#f92672">::</span>reportOneDeath(<span style="color:#66d9ef">const</span> Obituary<span style="color:#f92672">&amp;</span> obit)
{
    <span style="color:#75715e">//将弱引用提升到sp
</span><span style="color:#75715e"></span>    sp<span style="color:#f92672">&lt;</span>DeathRecipient<span style="color:#f92672">&gt;</span> recipient <span style="color:#f92672">=</span> obit.recipient.promote();
    <span style="color:#66d9ef">if</span> (recipient <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">return</span>;
    <span style="color:#75715e">//回调死亡通知的方法
</span><span style="color:#75715e"></span>    recipient<span style="color:#f92672">-&gt;</span>binderDied(<span style="color:#66d9ef">this</span>);
}
</code></pre></div><p>本文开头的实例传递的是AppDeathRecipient，那么回调如下方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AppDeathRecipient</span> implements IBinder.DeathRecipient {
    ...
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> binderDied() {
        synchronized(ActivityManagerService.<span style="color:#66d9ef">this</span>) {
            appDiedLocked(mApp, mPid, mAppThread, true);
        }
    }
}
</code></pre></div><h2 id="结论">结论</h2>
<p>对于Binder IPC进程都会打开/dev/binder文件，当进程异常退出时，Binder驱动会保证释放将要退出的进程中没有正常关闭的/dev/binder文件，实现机制是binder驱动通过调用/dev/binder文件所对应的release回调函数，执行清理工作，并且检查BBinder是否有注册死亡通知，当发现存在死亡通知时，那么就向其对应的BpBinder端发送死亡通知消息。</p>
<p>死亡回调DeathRecipient只有Bp才能正确使用，因为DeathRecipient用于监控Bn端挂掉的情况， 如果Bn建立跟自己的死亡通知，自己进程都挂了，也就无法通知。</p>
<p>每个BpBinder都有一个记录DeathRecipient列表的对象DeathRecipientList。</p>


<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/" title="BinderClient"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/" title="BinderKernel" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1611661807"></script>
    <script src="/js/perfect-scrollbar.min.js?1611661807"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1611661807"></script>
    <script src="/js/jquery.sticky.js?1611661807"></script>
    <script src="/js/featherlight.min.js?1611661807"></script>
    <script src="/js/highlight.pack.js?1611661807"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1611661807"></script>
    <script src="/js/learn.js?1611661807"></script>
    <script src="/js/hugo-learn.js?1611661807"></script>
    
        
            <script src="/mermaid/mermaid.js?1611661807"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

