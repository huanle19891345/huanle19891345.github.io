<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="description" content="Documentation for Hugo Learn Theme">
<meta name="author" content="Mathieu Cornic">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>BinderServer :: 郑欢的学习总结</title>

    
    <link href="/css/nucleus.css?1611382862" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1611382862" rel="stylesheet">
    <link href="/css/hybrid.css?1611382862" rel="stylesheet">
    <link href="/css/featherlight.min.css?1611382862" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1611382862" rel="stylesheet">
    <link href="/css/auto-complete.css?1611382862" rel="stylesheet">
    <link href="/css/atom-one-dark.css?1611382862" rel="stylesheet">
    <link href="/css/theme.css?1611382862" rel="stylesheet">
    <link href="/css/hugo-theme.css?1611382862" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1611382862" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1611382862"></script>

    <script src="/js/auto_toc_scroll.js?1611382862"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/en'>
    <img src="/avatar.png" width="60px" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1611382862"></script>
<script type="text/javascript" src="/js/auto-complete.js?1611382862"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/huanle19891345.github.io\/\/en";
    
</script>
<script type="text/javascript" src="/js/search.js?1611382862"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/en/android/" title="android" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/">
          android
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/google/" title="google" class="dd-item
        
        
        
        ">
      <a href="/en/android/google/">
          google
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/google/supporttoandroidx/" title="supportToAndroidx" class="dd-item ">
        <a href="/en/android/google/supporttoandroidx/">
        supportToAndroidx
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/" title="系统机制原理" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/">
          系统机制原理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/" title="ashmem" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/">
          ashmem
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/" title="匿名共享内存Ashmem" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/">
        匿名共享内存Ashmem
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/" title="bitmap" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/">
          bitmap
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/" title="Bitmap" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/">
        Bitmap
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/" title="BitmapSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/">
        BitmapSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/" title="handler" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/">
          handler
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/" title="Looper" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/">
        Looper
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/" title="ThreadLocal" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/">
        ThreadLocal
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/" title="input" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/">
          input
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/" title="touchEventNative" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/">
        touchEventNative
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/" title="zygote" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/">
          zygote
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/" title="SystemServerSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/">
        SystemServerSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/" title="ZygoteSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/">
        ZygoteSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/" title="Zygote进程" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/">
        Zygote进程
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/" title="多进程" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">
          多进程
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/" title="binder" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/">
          binder
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/" title="BinderClient" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/">
        BinderClient
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/" title="BinderDeath" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/">
        BinderDeath
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/" title="BinderKernel" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/">
        BinderKernel
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/" title="BinderServer" class="dd-item active">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/">
        BinderServer
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/" title="BinderServiceManager" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/">
        BinderServiceManager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/" title="Binder原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/">
        Binder原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/" title="mmkv" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/">
          mmkv
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/" title="MMKV" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/">
        MMKV
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/" title="系统绘制" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/">
          系统绘制
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/" title="Graphics" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/">
        Graphics
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/" title="Vsync" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/">
        Vsync
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/" title="Vsync_SurfaceFlinger" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/">
        Vsync_SurfaceFlinger
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/" title="硬件加速绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/">
        硬件加速绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/" title="绘制原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/">
        绘制原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/" title="软件绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/">
        软件绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" title="跨平台" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">
          跨平台
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/" title="flutter" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/">
          flutter
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/" title="通信" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/">
          通信
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" title="Flutter消息机制" class="dd-item ">
        <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/">
        Flutter消息机制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/huanle19891345"><i class='fab fa-fw fa-github'></i> GitHub repo</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/showcase"><i class='fas fa-fw fa-camera'></i> Showcases</a>
              </li>
          
              <li>
                  <a class="padding" href="https://gohugo.io/"><i class='fas fa-fw fa-bookmark'></i> Hugo Documentation</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/credits"><i class='fas fa-fw fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/en/'>技术探索总结</a> > <a href='/en/android/'>android</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/'>系统机制原理</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/'>多进程</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/'>binder</a> > BinderServer
          
        
          
        
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#binder-native-and-java-design">Binder Native And Java Design</a>
      <ul>
        <li><a href="#nativebbinder-associated-with-javabinder">NativeBBinder associated with JavaBinder</a></li>
      </ul>
    </li>
    <li><a href="#原理图">原理图</a></li>
    <li><a href="#addservice">addService</a>
      <ul>
        <li><a href="#servicemanager">ServiceManager</a>
          <ul>
            <li><a href="#getservice--asinterface">getService &amp;&amp; asInterface</a></li>
            <li><a href="#useserviceaddservice">useService(addService)</a>
              <ul>
                <li><a href="#writestrongbinder记录bbinder">writeStrongBinder记录BBinder</a>
                  <ul>
                    <li><a href="#c和javabinder对应">c和javaBinder对应</a></li>
                    <li><a href="#将bbinder设置为flat_binder_object的cookie">将BBinder设置为flat_binder_object的cookie</a></li>
                    <li><a href="#将flat_binder_object写入parcel">将flat_binder_object写入Parcel</a></li>
                  </ul>
                </li>
                <li><a href="#transactadd_service_transaction">transact(ADD_SERVICE_TRANSACTION&hellip;)</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#serverinit">serverInit</a>
      <ul>
        <li><a href="#processstateself">ProcessState::self</a></li>
        <li><a href="#open_driver--mmap">open_driver &amp;&amp; mmap</a></li>
        <li><a href="#startthreadpool">startThreadPool</a></li>
        <li><a href="#spawnpooledthread">spawnPooledThread</a></li>
        <li><a href="#poolthreadthreadloop">PoolThread::threadLoop</a></li>
        <li><a href="#ipcthreadstatejointhreadpool">IPCThreadState::joinThreadPool</a></li>
        <li><a href="#ipcthreadstategetandexecutecommand">IPCThreadState::getAndExecuteCommand</a></li>
        <li><a href="#ipcthreadstateexecutecommand">IPCThreadState::executeCommand</a></li>
        <li><a href="#binder_transaction_datacookie作为bbinder调用其transact">binder_transaction_data.cookie作为BBinder,调用其transact</a></li>
        <li><a href="#javabbinderontransact调用java层binder对应的exectransact方法">JavaBBinder::onTransact调用java层Binder对应的execTransact方法</a></li>
      </ul>
    </li>
    <li><a href="#其他关联知识点">其他关联知识点</a>
      <ul>
        <li><a href="#threadsrun">Threads::run</a></li>
        <li><a href="#androidcreaterawthreadetc">androidCreateRawThreadEtc</a></li>
        <li><a href="#_threadloop">_threadLoop</a></li>
        <li><a href="#ibinder">IBinder</a></li>
        <li><a href="#bbinder">BBinder</a></li>
        <li><a href="#iinterface">IInterface</a></li>
        <li><a href="#binderinternal_setmaxthreads">BinderInternal_setMaxThreads</a></li>
        <li><a href="#bpbindercreate">BpBinder::create</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              BinderServer
            </h1>
          

        


<h2 id="binder-native-and-java-design">Binder Native And Java Design</h2>
<pre><code class="language-mermaid" data-lang="mermaid">classDiagram
 class IBinder {
   +queryLocalInterface(descriptor)
   +linkToDeath(recipient, cookie, flags) status_t
   +unlinkToDeath(recipient, cookie, flags, outRecipient) status_t
   +transact(code, data, reply, flags) status_t
   +localBinder() BBinder
   +remoteBinder() BpBinder
 }
 class BpBinder {
 
 }
 class BBinder {
    +transact(code, data, reply, flags)
    #onTransact(code, data, reply, flags)
 }
 class BnInterface~INTERFACE~ {
     +queryLocalInterface(_descriptor) IInterface
     +getInterfaceDescriptor() descriptor
     #onAsBinder() IBinder
 }
 
 class BnGraphicBufferProducer {
    +onTransact() status_t
 }
 class IInterface {
    +asBinder(IInterface*) IBinder
 }
 class IGraphicBufferProducer {
    +ipcMethod()
 }
 class BufferQueueProducer {
    +ipcMethod()
 }
 class JavaBBinder {
    +onTransact()
 }
 
 IBinder &lt;|-- BpBinder
 IBinder &lt;|-- BBinder
 BBinder &lt;|-- BnInterface : native type server
 BBinder &lt;|-- JavaBBinder : java type server
 BnInterface &lt;|-- BnGraphicBufferProducer : BnInterface&lt;IGraphicBufferProducer&gt;
 IInterface &lt;|-- IGraphicBufferProducer
 BnGraphicBufferProducer &lt;|--  BufferQueueProducer
 IGraphicBufferProducer &lt;|.. BnInterface : INTERFACE
 
</code></pre><pre><code class="language-mermaid" data-lang="mermaid">classDiagram
 class IBinder {
   +queryLocalInterface(descriptor) IInterface
   +linkToDeath(recipient, flags)
   +unlinkToDeath(recipient, flags)
   +transact(code, data, reply, flags)
 }
 class BinderProxy {
   
 }
  class Binder {
    +attachInterface(iinterface, descriptor)
    +transact(code, data, reply, flags)
    #onTransact(code, data, reply, flags)
 }
 class Stub {
   +asInterface(iBinder) IConnectivityManager
   +asBinder() IBinder
   +onTransact(code, data, reply, flags)
 
 }
 class IInterface {
     +asBinder() IBinder
 }
 class IConnectivityManager {
     +ipcMethod()
 }
 class ConnectivityService {
     +ipcMethod()
 }
 class Proxy {
     - IBinder mRemote
     +ipcMethod()
 }
 
 IBinder &lt;|-- BinderProxy
 IBinder &lt;|-- Binder
 Binder &lt;|-- Stub
 IConnectivityManager &lt;|.. Stub
 IInterface &lt;|-- IConnectivityManager
 Stub &lt;|-- ConnectivityService
 IConnectivityManager &lt;|.. Proxy
 Stub --&gt; Proxy : asInterface返回
</code></pre><h3 id="nativebbinder-associated-with-javabinder">NativeBBinder associated with JavaBinder</h3>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver.assets/javabinderandnativebinder.png" alt=""></p>
<h2 id="原理图">原理图</h2>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver.assets/addservice.jpg" alt=""></p>
<p><img src="/img/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver.assets/media_player_service_ipc.png" alt=""></p>
<h2 id="addservice">addService</h2>
<p>frameworks/base/core/java/android/os/ServiceManager.java</p>
<h3 id="servicemanager">ServiceManager</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Place a new @a service called @a name into the service
</span><span style="color:#75715e"> * manager.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @param name the name of the new service
</span><span style="color:#75715e"> * @param service the service object
</span><span style="color:#75715e"> * @param allowIsolated set to true to allow isolated sandboxed processes
</span><span style="color:#75715e"> * @param dumpPriority supported dump priority levels as a bitmask
</span><span style="color:#75715e"> * to access this service
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> IBinder service<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> allowIsolated<span style="color:#f92672">,</span>
        <span style="color:#66d9ef">int</span> dumpPriority<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    getIServiceManager<span style="color:#f92672">().</span><span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> service<span style="color:#f92672">,</span> allowIsolated<span style="color:#f92672">,</span> dumpPriority<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="getservice--asinterface">getService &amp;&amp; asInterface</h4>
<p><a href="../binderclient#getiservicemanager">即getiservicemanager()过程参考binderclient</a></p>
<h4 id="useserviceaddservice">useService(addService)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServiceManagerProxy</span> <span style="color:#66d9ef">implements</span> IServiceManager <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ServiceManagerProxy</span><span style="color:#f92672">(</span>IBinder remote<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        mRemote <span style="color:#f92672">=</span> remote<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> IBinder <span style="color:#a6e22e">asBinder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> mRemote<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addService</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> IBinder service<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> allowIsolated<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> dumpPriority<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">throws</span> RemoteException <span style="color:#f92672">{</span>
        Parcel data <span style="color:#f92672">=</span> Parcel<span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
        Parcel reply <span style="color:#f92672">=</span> Parcel<span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInterfaceToken</span><span style="color:#f92672">(</span>IServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">descriptor</span><span style="color:#f92672">);</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeString</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeStrongBinder</span><span style="color:#f92672">(</span>service<span style="color:#f92672">);</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>allowIsolated <span style="color:#f92672">?</span> 1 <span style="color:#f92672">:</span> 0<span style="color:#f92672">);</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>dumpPriority<span style="color:#f92672">);</span>
        mRemote<span style="color:#f92672">.</span><span style="color:#a6e22e">transact</span><span style="color:#f92672">(</span>ADD_SERVICE_TRANSACTION<span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> reply<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
        reply<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="writestrongbinder记录bbinder">writeStrongBinder记录BBinder</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Write an object into the parcel at the current dataPosition(),
</span><span style="color:#75715e"> * growing dataCapacity() if needed.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">writeStrongBinder</span><span style="color:#f92672">(</span>IBinder val<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    nativeWriteStrongBinder<span style="color:#f92672">(</span>mNativePtr<span style="color:#f92672">,</span> val<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>frameworks/base/core/jni/android_os_Parcel.cpp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">android_os_Parcel_writeStrongBinder</span>(JNIEnv<span style="color:#f92672">*</span> env, jclass clazz, jlong nativePtr, jobject object)
{
    Parcel<span style="color:#f92672">*</span> parcel <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>Parcel<span style="color:#f92672">*&gt;</span>(nativePtr);
    <span style="color:#66d9ef">if</span> (parcel <span style="color:#f92672">!=</span> NULL) {
        <span style="color:#66d9ef">const</span> status_t err <span style="color:#f92672">=</span> parcel<span style="color:#f92672">-&gt;</span>writeStrongBinder(ibinderForJavaObject(env, object));
        <span style="color:#66d9ef">if</span> (err <span style="color:#f92672">!=</span> NO_ERROR) {
            signalExceptionForError(env, clazz, err);
        }
    }
}
</code></pre></div><p>frameworks/base/core/jni/android_util_Binder.cpp</p>
<h6 id="c和javabinder对应">c和javaBinder对应</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    gBinderOffsets.mClass <span style="color:#f92672">=</span> MakeGlobalRefOrDie(env, clazz);
    gBinderOffsets.mExecTransact <span style="color:#f92672">=</span> GetMethodIDOrDie(env, clazz, <span style="color:#e6db74">&#34;execTransact&#34;</span>, <span style="color:#e6db74">&#34;(IJJI)Z&#34;</span>);
    gBinderOffsets.mObject <span style="color:#f92672">=</span> GetFieldIDOrDie(env, clazz, <span style="color:#e6db74">&#34;mObject&#34;</span>, <span style="color:#e6db74">&#34;J&#34;</span>);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;</span> ibinderForJavaObject(JNIEnv<span style="color:#f92672">*</span> env, jobject obj)
{
    <span style="color:#66d9ef">if</span> (obj <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">return</span> NULL;

    <span style="color:#75715e">// Instance of Binder?
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (env<span style="color:#f92672">-&gt;</span>IsInstanceOf(obj, gBinderOffsets.mClass)) {
        JavaBBinderHolder<span style="color:#f92672">*</span> jbh <span style="color:#f92672">=</span> (JavaBBinderHolder<span style="color:#f92672">*</span>)
            env<span style="color:#f92672">-&gt;</span>GetLongField(obj, gBinderOffsets.mObject);
        <span style="color:#66d9ef">return</span> jbh<span style="color:#f92672">-&gt;</span>get(env, obj);
    }

    <span style="color:#75715e">// Instance of BinderProxy?
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (env<span style="color:#f92672">-&gt;</span>IsInstanceOf(obj, gBinderProxyOffsets.mClass)) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getBPNativeData</span>(env, obj)<span style="color:#f92672">-&gt;</span>mObject;
    }

    ALOGW(<span style="color:#e6db74">&#34;ibinderForJavaObject: %p is not a Binder object&#34;</span>, obj);
    <span style="color:#66d9ef">return</span> NULL;
}
</code></pre></div><p>frameworks/base/core/jni/android_util_Binder.cpp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JavaBBinderHolder</span>
{
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    sp<span style="color:#f92672">&lt;</span>JavaBBinder<span style="color:#f92672">&gt;</span> get(JNIEnv<span style="color:#f92672">*</span> env, jobject obj)
    {
        sp<span style="color:#f92672">&lt;</span>JavaBBinder<span style="color:#f92672">&gt;</span> b <span style="color:#f92672">=</span> mBinder.promote();
        <span style="color:#66d9ef">if</span> (b <span style="color:#f92672">==</span> NULL) {
            b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JavaBBinder(env, obj);
            mBinder <span style="color:#f92672">=</span> b;
        }
        <span style="color:#66d9ef">return</span> b;
    }
  wp<span style="color:#f92672">&lt;</span>JavaBBinder<span style="color:#f92672">&gt;</span> mBinder;
}
</code></pre></div><p>frameworks/native/libs/binder/Parcel.cpp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t Parcel<span style="color:#f92672">::</span>writeStrongBinder(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;&amp;</span> val)
{
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">flatten_binder</span>(ProcessState<span style="color:#f92672">::</span>self(), val, <span style="color:#66d9ef">this</span>);
}
</code></pre></div><h6 id="将bbinder设置为flat_binder_object的cookie">将BBinder设置为flat_binder_object的cookie</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t <span style="color:#a6e22e">flatten_binder</span>(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>ProcessState<span style="color:#f92672">&gt;&amp;</span> <span style="color:#75715e">/*proc*/</span>,
    <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;&amp;</span> binder, Parcel<span style="color:#f92672">*</span> out)
{
    flat_binder_object obj;

    <span style="color:#66d9ef">if</span> (binder <span style="color:#f92672">!=</span> NULL) {
        IBinder <span style="color:#f92672">*</span>local <span style="color:#f92672">=</span> binder<span style="color:#f92672">-&gt;</span>localBinder();<span style="color:#75715e">//本地Binder即BBinder,即Server端的Binder
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>local) {<span style="color:#75715e">//BBinder为空时
</span><span style="color:#75715e"></span>            BpBinder <span style="color:#f92672">*</span>proxy <span style="color:#f92672">=</span> binder<span style="color:#f92672">-&gt;</span>remoteBinder();
            <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int32_t</span> handle <span style="color:#f92672">=</span> proxy <span style="color:#f92672">?</span> proxy<span style="color:#f92672">-&gt;</span>handle() <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
            obj.hdr.type <span style="color:#f92672">=</span> BINDER_TYPE_HANDLE;
            obj.binder <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">/* Don&#39;t pass uninitialized stack data to a remote process */</span>
            obj.handle <span style="color:#f92672">=</span> handle;
            obj.cookie <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        } <span style="color:#66d9ef">else</span> { <span style="color:#75715e">//进入该分支
</span><span style="color:#75715e"></span>            obj.hdr.type <span style="color:#f92672">=</span> BINDER_TYPE_BINDER;<span style="color:#75715e">//后续在binder_transaction时会被调整为BINDER_TYPE_HANDLE类型，进而保存到serviceManager的链表当中
</span><span style="color:#75715e"></span>            obj.binder <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>uintptr_t<span style="color:#f92672">&gt;</span>(local<span style="color:#f92672">-&gt;</span>getWeakRefs());
            obj.cookie <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>uintptr_t<span style="color:#f92672">&gt;</span>(local);<span style="color:#75715e">//BBinder设置为flat_binder_object的cookie
</span><span style="color:#75715e"></span>        }
    } <span style="color:#66d9ef">else</span> {
        obj.hdr.type <span style="color:#f92672">=</span> BINDER_TYPE_BINDER;
        obj.binder <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        obj.cookie <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
    <span style="color:#66d9ef">return</span> finish_flatten_binder(binder, obj, out);
}
</code></pre></div><h6 id="将flat_binder_object写入parcel">将flat_binder_object写入Parcel</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">static</span> status_t <span style="color:#a6e22e">finish_flatten_binder</span>(
    <span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;&amp;</span> , <span style="color:#66d9ef">const</span> flat_binder_object<span style="color:#f92672">&amp;</span> flat, Parcel<span style="color:#f92672">*</span> out)
{
    <span style="color:#66d9ef">return</span> out<span style="color:#f92672">-&gt;</span>writeObject(flat, false);<span style="color:#75715e">//将flat_binder_object写入out
</span><span style="color:#75715e"></span>}
</code></pre></div><h5 id="transactadd_service_transaction">transact(ADD_SERVICE_TRANSACTION&hellip;)</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">mRemote.transact(ADD_SERVICE_TRANSACTION, data, reply, <span style="color:#ae81ff">0</span>);
</code></pre></div><h2 id="serverinit">serverInit</h2>
<p><a href="../../../zygote/zygotesource#nativezygoteinit">camefromzygote</a></p>
<p>frameworks/native/libs/binder/ProcessState.cpp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#define BINDER_VM_SIZE ((1 * 1024 * 1024) - sysconf(_SC_PAGE_SIZE) * 2)
</span><span style="color:#75715e">#define DEFAULT_MAX_BINDER_THREADS 15
</span></code></pre></div><h3 id="processstateself">ProcessState::self</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#f92672">&lt;</span>ProcessState<span style="color:#f92672">&gt;</span> ProcessState<span style="color:#f92672">::</span>self()
{
    gProcess <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessState(<span style="color:#e6db74">&#34;/dev/binder&#34;</span>);
    <span style="color:#66d9ef">return</span> gProcess;
}
</code></pre></div><h3 id="open_driver--mmap">open_driver &amp;&amp; mmap</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">ProcessState<span style="color:#f92672">::</span>ProcessState(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>driver)
    <span style="color:#f92672">:</span> mDriverName(String8(driver))
    , mDriverFD(open_driver(driver))<span style="color:#75715e">//call open_driver
</span><span style="color:#75715e"></span>    , mVMStart(MAP_FAILED)
    , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER)
    , mThreadCountDecrement(PTHREAD_COND_INITIALIZER)
    , mExecutingThreadsCount(<span style="color:#ae81ff">0</span>)
    , mMaxThreads(DEFAULT_MAX_BINDER_THREADS)
    , mStarvationStartTimeMs(<span style="color:#ae81ff">0</span>)
    , mManagesContexts(false)
    , mBinderContextCheckFunc(NULL)
    , mBinderContextUserData(NULL)
    , mThreadPoolStarted(false)
    , mThreadPoolSeq(<span style="color:#ae81ff">1</span>)
{
    <span style="color:#66d9ef">if</span> (mDriverFD <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#75715e">// mmap the binder, providing a chunk of virtual address space to receive transactions.
</span><span style="color:#75715e"></span>        mVMStart <span style="color:#f92672">=</span> mmap(<span style="color:#ae81ff">0</span>, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE <span style="color:#f92672">|</span> MAP_NORESERVE, mDriverFD, <span style="color:#ae81ff">0</span>);
    }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">open_driver</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>driver)
{
    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> open(driver, O_RDWR <span style="color:#f92672">|</span> O_CLOEXEC);
    <span style="color:#66d9ef">if</span> (fd <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#66d9ef">int</span> vers <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        status_t result <span style="color:#f92672">=</span> ioctl(fd, BINDER_VERSION, <span style="color:#f92672">&amp;</span>vers);
        
        size_t maxThreads <span style="color:#f92672">=</span> DEFAULT_MAX_BINDER_THREADS;
        result <span style="color:#f92672">=</span> ioctl(fd, BINDER_SET_MAX_THREADS, <span style="color:#f92672">&amp;</span>maxThreads);
    } <span style="color:#66d9ef">else</span> {
        ALOGW(<span style="color:#e6db74">&#34;Opening &#39;%s&#39; failed: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, driver, strerror(errno));
    }
    <span style="color:#66d9ef">return</span> fd;
}
</code></pre></div><h3 id="startthreadpool">startThreadPool</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> ProcessState<span style="color:#f92672">::</span>startThreadPool()
{
    AutoMutex <span style="color:#a6e22e">_l</span>(mLock);
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mThreadPoolStarted) {
        mThreadPoolStarted <span style="color:#f92672">=</span> true;
        spawnPooledThread(true);
    }
}
</code></pre></div><h3 id="spawnpooledthread">spawnPooledThread</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> ProcessState<span style="color:#f92672">::</span>spawnPooledThread(<span style="color:#66d9ef">bool</span> isMain)<span style="color:#75715e">//创建一个Thread用于提供Binder服务
</span><span style="color:#75715e"></span>{
    <span style="color:#66d9ef">if</span> (mThreadPoolStarted) {
        String8 name <span style="color:#f92672">=</span> makeBinderThreadName();
        ALOGV(<span style="color:#e6db74">&#34;Spawning new pooled thread, name=%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, name.string());
        sp<span style="color:#f92672">&lt;</span>Thread<span style="color:#f92672">&gt;</span> t <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PoolThread(isMain);
        t<span style="color:#f92672">-&gt;</span>run(name.string());
    }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">String8 ProcessState<span style="color:#f92672">::</span>makeBinderThreadName() {
    <span style="color:#66d9ef">int32_t</span> s <span style="color:#f92672">=</span> android_atomic_add(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>mThreadPoolSeq);
    pid_t pid <span style="color:#f92672">=</span> getpid();
    String8 name;
    name.appendFormat(<span style="color:#e6db74">&#34;Binder:%d_%X&#34;</span>, pid, s);
    <span style="color:#66d9ef">return</span> name;
}
</code></pre></div><h3 id="poolthreadthreadloop">PoolThread::threadLoop</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">50</span>      <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PoolThread</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Thread                                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">51</span>      {                                                   
       <span style="color:#ae81ff">58</span>      <span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>                                                                                                
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">59</span>          <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">bool</span> threadLoop()                                                                             
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">60</span>          {                                                                                                     
  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">61</span>              IPCThreadState<span style="color:#f92672">::</span>self()<span style="color:#f92672">-&gt;</span>joinThreadPool(mIsMain);                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">62</span>              <span style="color:#66d9ef">return</span> false;                                                                                     
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">63</span>          }                                               
       <span style="color:#ae81ff">66</span>      }; 
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> IPCThreadState<span style="color:#f92672">::</span>threadDestructor(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>st)
{
        IPCThreadState<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> self <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span>IPCThreadState<span style="color:#f92672">*&gt;</span>(st);
        <span style="color:#66d9ef">if</span> (self) {
            self<span style="color:#f92672">-&gt;</span>flushCommands();
        <span style="color:#66d9ef">if</span> (self<span style="color:#f92672">-&gt;</span>mProcess<span style="color:#f92672">-&gt;</span>mDriverFD <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
            ioctl(self<span style="color:#f92672">-&gt;</span>mProcess<span style="color:#f92672">-&gt;</span>mDriverFD, BINDER_THREAD_EXIT, <span style="color:#ae81ff">0</span>);
        }
            <span style="color:#66d9ef">delete</span> self;
        }
}
</code></pre></div><h3 id="ipcthreadstatejointhreadpool">IPCThreadState::joinThreadPool</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#ae81ff">528</span>     <span style="color:#66d9ef">void</span> IPCThreadState<span style="color:#f92672">::</span>joinThreadPool(<span style="color:#66d9ef">bool</span> isMain)                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">529</span>     {                                                                                                                                                                                                           
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">532</span>         mOut.writeInt32(isMain <span style="color:#f92672">?</span> BC_ENTER_LOOPER : BC_REGISTER_LOOPER);                                       
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">533</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">534</span>         status_t result;                                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">535</span>         <span style="color:#66d9ef">do</span> {                                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">536</span>             processPendingDerefs();                                                                           
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">537</span>             <span style="color:#75715e">// now get the next command to be processed, waiting if necessary                                 
</span><span style="color:#75715e"></span>  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">538</span>             result <span style="color:#f92672">=</span> getAndExecuteCommand();                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">539</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">540</span>             <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">&lt;</span> NO_ERROR <span style="color:#f92672">&amp;&amp;</span> result <span style="color:#f92672">!=</span> TIMED_OUT <span style="color:#f92672">&amp;&amp;</span> result <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>ECONNREFUSED <span style="color:#f92672">&amp;&amp;</span> result <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>EBADF) {    
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">541</span>                 ALOGE(<span style="color:#e6db74">&#34;getAndExecuteCommand(fd=%d) returned unexpected error %d, aborting&#34;</span>,                   
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">542</span>                       mProcess<span style="color:#f92672">-&gt;</span>mDriverFD, result);                                                           
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">543</span>                 abort();                                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">544</span>             }                                                                                                 
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">545</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">546</span>             <span style="color:#75715e">// Let this thread exit the thread pool if it is no longer                                        
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">547</span>             <span style="color:#75715e">// needed and it is not the main process thread.                                                  
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">548</span>             <span style="color:#66d9ef">if</span>(result <span style="color:#f92672">==</span> TIMED_OUT <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isMain) {                                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">549</span>                 <span style="color:#66d9ef">break</span>;                                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">550</span>             }                                                                                                 
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">551</span>         } <span style="color:#66d9ef">while</span> (result <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>ECONNREFUSED <span style="color:#f92672">&amp;&amp;</span> result <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>EBADF);                                                
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">552</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">556</span>         mOut.writeInt32(BC_EXIT_LOOPER);                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">557</span>         talkWithDriver(false);                                                                                
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">558</span>     }           
</code></pre></div><h3 id="ipcthreadstategetandexecutecommand">IPCThreadState::getAndExecuteCommand</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">435</span>     status_t IPCThreadState<span style="color:#f92672">::</span>getAndExecuteCommand()                                                           
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">436</span>     {                                                                                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">437</span>         status_t result;                                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">438</span>         <span style="color:#66d9ef">int32_t</span> cmd;                                                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">439</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">440</span>         result <span style="color:#f92672">=</span> talkWithDriver();     
    <span style="color:#ae81ff">441</span>         <span style="color:#a6e22e">if</span> (result <span style="color:#f92672">&gt;=</span> NO_ERROR) {                                                                             
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">442</span>             size_t IN <span style="color:#f92672">=</span> mIn.dataAvail();                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">443</span>             <span style="color:#66d9ef">if</span> (IN <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int32_t</span>)) <span style="color:#66d9ef">return</span> result;                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">444</span>             cmd <span style="color:#f92672">=</span> mIn.readInt32();                
  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">458</span>             result <span style="color:#f92672">=</span> executeCommand(cmd);                                                                     
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">459</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">460</span>             pthread_mutex_lock(<span style="color:#f92672">&amp;</span>mProcess<span style="color:#f92672">-&gt;</span>mThreadCountLock);                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">461</span>             mProcess<span style="color:#f92672">-&gt;</span>mExecutingThreadsCount<span style="color:#f92672">--</span>;      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">471</span>             pthread_cond_broadcast(<span style="color:#f92672">&amp;</span>mProcess<span style="color:#f92672">-&gt;</span>mThreadCountDecrement);                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">472</span>             pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mProcess<span style="color:#f92672">-&gt;</span>mThreadCountLock);                                                
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">473</span>         }                                                                                                     
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">474</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">475</span>         <span style="color:#66d9ef">return</span> result;                                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">476</span>     }                                                                                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">477</span>                
</code></pre></div><h3 id="ipcthreadstateexecutecommand">IPCThreadState::executeCommand</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">998</span>     status_t IPCThreadState<span style="color:#f92672">::</span>executeCommand(<span style="color:#66d9ef">int32_t</span> cmd)                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">999</span>     {                                                                                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1000</span>        BBinder<span style="color:#f92672">*</span> obj;                                                                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1001</span>        RefBase<span style="color:#f92672">::</span>weakref_type<span style="color:#f92672">*</span> refs;                                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1002</span>        status_t result <span style="color:#f92672">=</span> NO_ERROR;                                                                           
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1003</span>                                                                                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1004</span>        <span style="color:#66d9ef">switch</span> ((<span style="color:#66d9ef">uint32_t</span>)cmd) {  
    <span style="color:#ae81ff">1077</span>        <span style="color:#66d9ef">case</span> BR_TRANSACTION:                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1078</span>            {                                                                                                 
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1079</span>                binder_transaction_data tr;                                                                   
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1080</span>                result <span style="color:#f92672">=</span> mIn.read(<span style="color:#f92672">&amp;</span>tr, <span style="color:#66d9ef">sizeof</span>(tr));    
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1103</span>                Parcel reply;                                                                                 
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1104</span>                status_t error;                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1116</span>                <span style="color:#66d9ef">if</span> (tr.target.ptr) {                                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1117</span>                    <span style="color:#75715e">// We only have a weak reference on the target object, so we must first try to            
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1118</span>                    <span style="color:#75715e">// safely acquire a strong reference before doing anything else with it.                  
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1119</span>                    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>RefBase<span style="color:#f92672">::</span>weakref_type<span style="color:#f92672">*&gt;</span>(                                             
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1120</span>                            tr.target.ptr)<span style="color:#f92672">-&gt;</span>attemptIncStrong(<span style="color:#66d9ef">this</span>)) {                                         
  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1121</span>                        error <span style="color:#f92672">=</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>BBinder<span style="color:#f92672">*&gt;</span>(tr.cookie)<span style="color:#f92672">-&gt;</span>transact(tr.code, buffer,              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1122</span>                                <span style="color:#f92672">&amp;</span>reply, tr.flags);                                                            
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1123</span>                        <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>BBinder<span style="color:#f92672">*&gt;</span>(tr.cookie)<span style="color:#f92672">-&gt;</span>decStrong(<span style="color:#66d9ef">this</span>);                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1124</span>                    } <span style="color:#66d9ef">else</span> {                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1125</span>                        error <span style="color:#f92672">=</span> UNKNOWN_TRANSACTION;                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1126</span>                    }                                                                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1127</span>                                                                                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1128</span>                } <span style="color:#66d9ef">else</span> {                                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1129</span>                    error <span style="color:#f92672">=</span> the_context_object<span style="color:#f92672">-&gt;</span>transact(tr.code, buffer, <span style="color:#f92672">&amp;</span>reply, tr.flags);                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1130</span>                }                   
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1135</span>                <span style="color:#66d9ef">if</span> ((tr.flags <span style="color:#f92672">&amp;</span> TF_ONE_WAY) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {                                                           
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1136</span>                    LOG_ONEWAY(<span style="color:#e6db74">&#34;Sending reply to %d!&#34;</span>, mCallingPid);                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1137</span>                    <span style="color:#66d9ef">if</span> (error <span style="color:#f92672">&lt;</span> NO_ERROR) reply.setError(error);                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1138</span>                    sendReply(reply, <span style="color:#ae81ff">0</span>);                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1139</span>                } <span style="color:#66d9ef">else</span> {                                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1140</span>                    LOG_ONEWAY(<span style="color:#e6db74">&#34;NOT sending reply to %d!&#34;</span>, mCallingPid);                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1141</span>                }       
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">1155</span>            <span style="color:#66d9ef">break</span>; 
       
           <span style="color:#66d9ef">case</span> BR_SPAWN_LOOPER:
           mProcess<span style="color:#f92672">-&gt;</span>spawnPooledThread(false);
           <span style="color:#66d9ef">break</span>;

</code></pre></div><h3 id="binder_transaction_datacookie作为bbinder调用其transact">binder_transaction_data.cookie作为BBinder,调用其transact</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">118</span>     status_t BBinder<span style="color:#f92672">::</span>transact(                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">119</span>         <span style="color:#66d9ef">uint32_t</span> code, <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data, Parcel<span style="color:#f92672">*</span> reply, <span style="color:#66d9ef">uint32_t</span> flags)                                     
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">120</span>     {                                                                                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">121</span>         data.setDataPosition(<span style="color:#ae81ff">0</span>);                                                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">122</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">123</span>         status_t err <span style="color:#f92672">=</span> NO_ERROR;                                                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">124</span>         <span style="color:#66d9ef">switch</span> (code) {                                                                                       
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">125</span>             <span style="color:#66d9ef">case</span> PING_TRANSACTION:                                                                            
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">126</span>                 reply<span style="color:#f92672">-&gt;</span>writeInt32(pingBinder());                                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">127</span>                 <span style="color:#66d9ef">break</span>;                                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">128</span>             <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>                                                                                          
  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">129</span>                 err <span style="color:#f92672">=</span> onTransact(code, data, reply, flags);                                                   
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">130</span>                 <span style="color:#66d9ef">break</span>;                                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">131</span>         }                                                                                                     
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">132</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">133</span>         <span style="color:#66d9ef">if</span> (reply <span style="color:#f92672">!=</span> NULL) {                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">134</span>             reply<span style="color:#f92672">-&gt;</span>setDataPosition(<span style="color:#ae81ff">0</span>);                                                                        
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">135</span>         }                                                                                                     
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">136</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">137</span>         <span style="color:#66d9ef">return</span> err;                                                                                           
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">138</span>     } 
</code></pre></div><h3 id="javabbinderontransact调用java层binder对应的exectransact方法">JavaBBinder::onTransact调用java层Binder对应的execTransact方法</h3>
<p><a href="#c%E5%92%8Cjavabinder%E5%AF%B9%E5%BA%94">参考c和javabinder对应</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    <span style="color:#66d9ef">virtual</span> status_t <span style="color:#a6e22e">onTransact</span>(
        <span style="color:#66d9ef">uint32_t</span> code, <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data, Parcel<span style="color:#f92672">*</span> reply, <span style="color:#66d9ef">uint32_t</span> flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
    {
        JNIEnv<span style="color:#f92672">*</span> env <span style="color:#f92672">=</span> javavm_to_jnienv(mVM);

        <span style="color:#75715e">//printf(&#34;Transact from %p to Java code sending: &#34;, this);
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//data.print();
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//printf(&#34;\n&#34;);
</span><span style="color:#75715e"></span>        jboolean res <span style="color:#f92672">=</span> env<span style="color:#f92672">-&gt;</span>CallBooleanMethod(mObject, gBinderOffsets.mExecTransact,
            code, <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>jlong<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>data), <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>jlong<span style="color:#f92672">&gt;</span>(reply), flags);
</code></pre></div><p>Binder.java</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">// Entry point from android_util_Binder.cpp&#39;s onTransact
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">execTransact</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> code<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> dataObj<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> replyObj<span style="color:#f92672">,</span>
            <span style="color:#66d9ef">int</span> flags<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            res <span style="color:#f92672">=</span> onTransact<span style="color:#f92672">(</span>code<span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> reply<span style="color:#f92672">,</span> flags<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h2 id="其他关联知识点">其他关联知识点</h2>
<p>system/core/libutils/Threads.cpp</p>
<h3 id="threadsrun">Threads::run</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t Thread<span style="color:#f92672">::</span>run(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> name, <span style="color:#66d9ef">int32_t</span> priority, size_t stack)
{
    <span style="color:#66d9ef">if</span> (mCanCallJava) {
        res <span style="color:#f92672">=</span> createThreadEtc(_threadLoop,
                <span style="color:#66d9ef">this</span>, name, priority, stack, <span style="color:#f92672">&amp;</span>mThread);
    } <span style="color:#66d9ef">else</span> {
        res <span style="color:#f92672">=</span> androidCreateRawThreadEtc(_threadLoop,
                <span style="color:#66d9ef">this</span>, name, priority, stack, <span style="color:#f92672">&amp;</span>mThread);
    }

</code></pre></div><h3 id="androidcreaterawthreadetc">androidCreateRawThreadEtc</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">androidCreateRawThreadEtc</span>(android_thread_func_t entryFunction,
                               <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>userData,
                               <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> threadName __android_unused,
                               <span style="color:#66d9ef">int32_t</span> threadPriority,
                               size_t threadStackSize,
                               android_thread_id_t <span style="color:#f92672">*</span>threadId)
{
        <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> pthread_create(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">thread</span>, <span style="color:#f92672">&amp;</span>attr,
                    (android_pthread_entry)entryFunction, userData);
}
</code></pre></div><h3 id="_threadloop">_threadLoop</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"> <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">711</span>     <span style="color:#66d9ef">int</span> Thread<span style="color:#f92672">::</span>_threadLoop(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> user)                                                                       
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">712</span>     {   
<span style="color:#ae81ff">726</span>         <span style="color:#66d9ef">do</span> {                                                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">727</span>             <span style="color:#66d9ef">bool</span> result;                                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">728</span>             <span style="color:#66d9ef">if</span> (first) {                                                                                      
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">729</span>                 first <span style="color:#f92672">=</span> false;                                                                                
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">730</span>                 self<span style="color:#f92672">-&gt;</span>mStatus <span style="color:#f92672">=</span> self<span style="color:#f92672">-&gt;</span>readyToRun();                                                           
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">731</span>                 result <span style="color:#f92672">=</span> (self<span style="color:#f92672">-&gt;</span>mStatus <span style="color:#f92672">==</span> NO_ERROR);                                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">732</span>                                                                                                               
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">733</span>                 <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>self<span style="color:#f92672">-&gt;</span>exitPending()) {                                                         
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">734</span>                     <span style="color:#75715e">// Binder threads (and maybe others) rely on threadLoop                                   
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">735</span>                     <span style="color:#75715e">// running at least once after a successful ::readyToRun()                                
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">736</span>                     <span style="color:#75715e">// (unless, of course, the thread has already been asked to exit                          
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">737</span>                     <span style="color:#75715e">// at that point).                                                                        
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">738</span>                     <span style="color:#75715e">// This is because threads are essentially used like this:                                
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">739</span>                     <span style="color:#75715e">//   (new ThreadSubclass())-&gt;run();                                                       
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">740</span>                     <span style="color:#75715e">// The caller therefore does not retain a strong reference to                             
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">741</span>                     <span style="color:#75715e">// the thread and the thread would simply disappear after the                             
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">742</span>                     <span style="color:#75715e">// successful ::readyToRun() call instead of entering the                                 
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">743</span>                     <span style="color:#75715e">// threadLoop at least once.                                                              
</span><span style="color:#75715e"></span>  <span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">744</span>                     result <span style="color:#f92672">=</span> self<span style="color:#f92672">-&gt;</span>threadLoop();                                                              
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">745</span>                 }                                                                                             
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">746</span>             } <span style="color:#66d9ef">else</span> {                                                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">747</span>                 result <span style="color:#f92672">=</span> self<span style="color:#f92672">-&gt;</span>threadLoop();                                                                  
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">748</span>             }       
    <span style="color:#ae81ff">766</span>             <span style="color:#75715e">// Release our strong reference, to let a chance to the thread                                    
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">767</span>             <span style="color:#75715e">// to die a peaceful death.                                                                       
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">768</span>             strong.clear();                                                                                   
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">769</span>             <span style="color:#75715e">// And immediately, re-acquire a strong reference for the next loop                               
</span><span style="color:#75715e"></span>   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">770</span>             strong <span style="color:#f92672">=</span> weak.promote();                                                                          
   <span style="color:#960050;background-color:#1e0010">│</span><span style="color:#ae81ff">771</span>         } <span style="color:#66d9ef">while</span>(strong <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>);   
</code></pre></div><p>frameworks/native/libs/binder/include/binder/IBinder.h</p>
<h3 id="ibinder">IBinder</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Base class and low-level protocol for a remotable object.
</span><span style="color:#75715e"> * You can derive from this class to create an object for which other
</span><span style="color:#75715e"> * processes can hold references to it.  Communication between processes
</span><span style="color:#75715e"> * (method calls, property get and set) is down through a low-level
</span><span style="color:#75715e"> * protocol implemented on top of the transact() API.
</span><span style="color:#75715e"> */</span>
class IBinder : public virtual RefBase
{
    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Check if this IBinder implements the interface named by
</span><span style="color:#75715e">     * @a descriptor.  If it does, the base pointer to it is returned,
</span><span style="color:#75715e">     * which you can safely static_cast&lt;&gt; to the concrete C++ interface.
</span><span style="color:#75715e">     */</span>
    virtual sp<span style="color:#f92672">&lt;</span>IInterface<span style="color:#f92672">&gt;</span>  queryLocalInterface(<span style="color:#66d9ef">const</span> String16<span style="color:#f92672">&amp;</span> descriptor);
    
    virtual status_t        <span style="color:#a6e22e">transact</span>(   uint32_t code,
                                        <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data,
                                        Parcel<span style="color:#f92672">*</span> reply,
                                        uint32_t flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    
     <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Register the @a recipient for a notification if this binder
</span><span style="color:#75715e">     * goes away.  If this binder object unexpectedly goes away
</span><span style="color:#75715e">     * (typically because its hosting process has been killed),
</span><span style="color:#75715e">     * then DeathRecipient::binderDied() will be called with a reference
</span><span style="color:#75715e">     * to this.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * The @a cookie is optional -- if non-NULL, it should be a
</span><span style="color:#75715e">     * memory address that you own (that is, you know it is unique).
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @note You will only receive death notifications for remote binders,
</span><span style="color:#75715e">     * as local binders by definition can&#39;t die without you dying as well.
</span><span style="color:#75715e">     * Trying to use this function on a local binder will result in an
</span><span style="color:#75715e">     * INVALID_OPERATION code being returned and nothing happening.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @note This link always holds a weak reference to its recipient.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @note You will only receive a weak reference to the dead
</span><span style="color:#75715e">     * binder.  You should not try to promote this to a strong reference.
</span><span style="color:#75715e">     * (Nor should you need to, as there is nothing useful you can
</span><span style="color:#75715e">     * directly do with it now that it has passed on.)
</span><span style="color:#75715e">     */</span>
    virtual status_t        <span style="color:#a6e22e">linkToDeath</span>(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>DeathRecipient<span style="color:#f92672">&gt;&amp;</span> recipient,
                                        <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> cookie <span style="color:#f92672">=</span> NULL,
                                        uint32_t flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</code></pre></div><p>frameworks/native/libs/binder/include/binder/Binder.h</p>
<h3 id="bbinder">BBinder</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-h" data-lang="h">class BBinder : public IBinder
{ 
public:
    virtual status_t    transact(   uint32_t code,
                                    <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data,
                                    Parcel<span style="color:#f92672">*</span> reply,
                                    uint32_t flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);

    virtual status_t    <span style="color:#a6e22e">linkToDeath</span>(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>DeathRecipient<span style="color:#f92672">&gt;&amp;</span> recipient,
                                    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> cookie <span style="color:#f92672">=</span> NULL,
                                    uint32_t flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);
    
protected:
    virtual             <span style="color:#f92672">~</span>BBinder();

    virtual status_t    <span style="color:#a6e22e">onTransact</span>( uint32_t code,
                                    <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data,
                                    Parcel<span style="color:#f92672">*</span> reply,
                                    uint32_t flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);
</code></pre></div><p>frameworks/native/libs/binder/include/binder/IInterface.h</p>
<h3 id="iinterface">IInterface</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IInterface</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> RefBase
{
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
            IInterface();
            <span style="color:#66d9ef">static</span> sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;</span>  asBinder(<span style="color:#66d9ef">const</span> IInterface<span style="color:#f92672">*</span>);
            <span style="color:#66d9ef">static</span> sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;</span>  asBinder(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>IInterface<span style="color:#f92672">&gt;&amp;</span>);

<span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span>                     <span style="color:#f92672">~</span>IInterface();
    <span style="color:#66d9ef">virtual</span> IBinder<span style="color:#f92672">*</span>            <span style="color:#a6e22e">onAsBinder</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
};

     
<span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> INTERFACE<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BnInterface</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> INTERFACE, <span style="color:#66d9ef">public</span> BBinder
{
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> sp<span style="color:#f92672">&lt;</span>IInterface<span style="color:#f92672">&gt;</span>      queryLocalInterface(<span style="color:#66d9ef">const</span> String16<span style="color:#f92672">&amp;</span> _descriptor);
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> String16<span style="color:#f92672">&amp;</span>     getInterfaceDescriptor() <span style="color:#66d9ef">const</span>;

<span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> IBinder<span style="color:#f92672">*</span>            onAsBinder();
};

<span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> INTERFACE<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BpInterface</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> INTERFACE, <span style="color:#66d9ef">public</span> BpRefBase
{
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">explicit</span>                    BpInterface(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;&amp;</span> remote);

<span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> IBinder<span style="color:#f92672">*</span>            onAsBinder();
};

</code></pre></div><h3 id="binderinternal_setmaxthreads">BinderInternal_setMaxThreads</h3>
<p>frameworks/base/core/jni/android_util_Binder.cpp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">android_os_BinderInternal_setMaxThreads</span>(JNIEnv<span style="color:#f92672">*</span> env,
        jobject clazz, jint maxThreads)<span style="color:#75715e">// called by SystemServer.java BinderInternal.setMaxThreads
</span><span style="color:#75715e"></span>{
    ProcessState<span style="color:#f92672">::</span>self()<span style="color:#f92672">-&gt;</span>setThreadPoolMaxThreadCount(maxThreads);
}
</code></pre></div><p>frameworks/native/libs/binder/BpBinder.cpp</p>
<h3 id="bpbindercreate">BpBinder::create</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">BpBinder<span style="color:#f92672">*</span> BpBinder<span style="color:#f92672">::</span>create(<span style="color:#66d9ef">int32_t</span> handle) {
    <span style="color:#66d9ef">int32_t</span> trackedUid <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (sCountByUidEnabled) {
        trackedUid <span style="color:#f92672">=</span> IPCThreadState<span style="color:#f92672">::</span>self()<span style="color:#f92672">-&gt;</span>getCallingUid();
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">BpBinder</span>(handle, trackedUid);
}
</code></pre></div>

<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/" title="BinderKernel"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/" title="BinderServiceManager" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1611382862"></script>
    <script src="/js/perfect-scrollbar.min.js?1611382862"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1611382862"></script>
    <script src="/js/jquery.sticky.js?1611382862"></script>
    <script src="/js/featherlight.min.js?1611382862"></script>
    <script src="/js/highlight.pack.js?1611382862"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1611382862"></script>
    <script src="/js/learn.js?1611382862"></script>
    <script src="/js/hugo-learn.js?1611382862"></script>
    
        
            <script src="/mermaid/mermaid.js?1611382862"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

