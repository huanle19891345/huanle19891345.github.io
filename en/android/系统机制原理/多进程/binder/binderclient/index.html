<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="description" content="Documentation for Hugo Learn Theme">
<meta name="author" content="Mathieu Cornic">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>BinderClient :: 郑欢的学习总结</title>

    
    <link href="/css/nucleus.css?1611382483" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1611382483" rel="stylesheet">
    <link href="/css/hybrid.css?1611382483" rel="stylesheet">
    <link href="/css/featherlight.min.css?1611382483" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1611382483" rel="stylesheet">
    <link href="/css/auto-complete.css?1611382483" rel="stylesheet">
    <link href="/css/atom-one-dark.css?1611382483" rel="stylesheet">
    <link href="/css/theme.css?1611382483" rel="stylesheet">
    <link href="/css/hugo-theme.css?1611382483" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1611382483" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1611382483"></script>

    <script src="/js/auto_toc_scroll.js?1611382483"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/en'>
    <img src="/avatar.png" width="60px" />
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1611382483"></script>
<script type="text/javascript" src="/js/auto-complete.js?1611382483"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/huanle19891345.github.io\/\/en";
    
</script>
<script type="text/javascript" src="/js/search.js?1611382483"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/en/android/" title="android" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/">
          android
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/google/" title="google" class="dd-item
        
        
        
        ">
      <a href="/en/android/google/">
          google
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/google/supporttoandroidx/" title="supportToAndroidx" class="dd-item ">
        <a href="/en/android/google/supporttoandroidx/">
        supportToAndroidx
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/" title="系统机制原理" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/">
          系统机制原理
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/" title="ashmem" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/">
          ashmem
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/" title="匿名共享内存Ashmem" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/ashmem/%E5%8C%BF%E5%90%8D%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98ashmem/">
        匿名共享内存Ashmem
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/" title="bitmap" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/">
          bitmap
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/" title="Bitmap" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmap/">
        Bitmap
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/" title="BitmapSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/bitmap/bitmapsource/">
        BitmapSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/" title="handler" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/">
          handler
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/" title="Looper" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/looper/">
        Looper
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/" title="ThreadLocal" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/handler/threadlocal/">
        ThreadLocal
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/" title="input" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/">
          input
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/" title="touchEventNative" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/input/toucheventnative/">
        touchEventNative
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/" title="zygote" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/">
          zygote
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/" title="SystemServerSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/systemserversource/">
        SystemServerSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/" title="ZygoteSource" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygotesource/">
        ZygoteSource
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/" title="Zygote进程" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/zygote/zygote%E8%BF%9B%E7%A8%8B/">
        Zygote进程
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/" title="多进程" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/">
          多进程
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/" title="binder" class="dd-item
        parent
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/">
          binder
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/" title="BinderClient" class="dd-item active">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderclient/">
        BinderClient
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/" title="BinderDeath" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/">
        BinderDeath
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/" title="BinderKernel" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderkernel/">
        BinderKernel
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/" title="BinderServer" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderserver/">
        BinderServer
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/" title="BinderServiceManager" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderservicemanager/">
        BinderServiceManager
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/" title="Binder原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binder%E5%8E%9F%E7%90%86/">
        Binder原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/" title="mmkv" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/">
          mmkv
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/" title="MMKV" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/mmkv/mmkv/">
        MMKV
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/" title="系统绘制" class="dd-item
        
        
        
        ">
      <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/">
          系统绘制
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/" title="Graphics" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/graphics/">
        Graphics
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/" title="Vsync" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync/">
        Vsync
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/" title="Vsync_SurfaceFlinger" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/vsync_surfaceflinger/">
        Vsync_SurfaceFlinger
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/" title="硬件加速绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E7%BB%98%E5%88%B6/">
        硬件加速绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/" title="绘制原理" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/">
        绘制原理
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/" title="软件绘制" class="dd-item ">
        <a href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E7%B3%BB%E7%BB%9F%E7%BB%98%E5%88%B6/%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6/">
        软件绘制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" title="跨平台" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">
          跨平台
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/" title="flutter" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/">
          flutter
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/" title="通信" class="dd-item
        
        
        
        ">
      <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/">
          通信
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" title="Flutter消息机制" class="dd-item ">
        <a href="/en/%E8%B7%A8%E5%B9%B3%E5%8F%B0/flutter/%E9%80%9A%E4%BF%A1/flutter%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/">
        Flutter消息机制
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/huanle19891345"><i class='fab fa-fw fa-github'></i> GitHub repo</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/showcase"><i class='fas fa-fw fa-camera'></i> Showcases</a>
              </li>
          
              <li>
                  <a class="padding" href="https://gohugo.io/"><i class='fas fa-fw fa-bookmark'></i> Hugo Documentation</a>
              </li>
          
              <li>
                  <a class="padding" href="https://huanle19891345.github.io/en/credits"><i class='fas fa-fw fa-bullhorn'></i> Credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/en/'>技术探索总结</a> > <a href='/en/android/'>android</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/'>系统机制原理</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/'>多进程</a> > <a href='/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/'>binder</a> > BinderClient
          
        
          
        
          
        
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#data-flow">Data Flow</a></li>
    <li><a href="#getservice">getService</a>
      <ul>
        <li><a href="#systemserviceregistry">SystemServiceRegistry</a>
          <ul>
            <li><a href="#contextimplgetsystemservice">ContextImpl.getSystemService</a></li>
            <li><a href="#registerservices">registerServices</a></li>
            <li><a href="#registerservice">registerService</a></li>
            <li><a href="#getsystemservice">getSystemService</a></li>
            <li><a href="#cachedservicefetchergetservice">CachedServiceFetcher.getService</a></li>
            <li><a href="#createservice--servicemanagergetservice">createService&ndash;&gt;ServiceManager.getService</a></li>
          </ul>
        </li>
        <li><a href="#servicemanager">ServiceManager</a>
          <ul>
            <li><a href="#getservice-1">getService</a>
              <ul>
                <li><a href="#rawgetservice">rawGetService</a></li>
                <li><a href="#getiservicemanager">getIServiceManager</a></li>
                <li><a href="#binderinternalgetcontextobject">BinderInternal.getContextObject</a></li>
                <li><a href="#android_os_binderinternal_getcontextobject">android_os_BinderInternal_getContextObject</a></li>
                <li><a href="#processstategetcontextobject">ProcessState::getContextObject</a></li>
                <li><a href="#processstategetstrongproxyforhandle">ProcessState::getStrongProxyForHandle</a></li>
                <li><a href="#processstatelookuphandlelocked">ProcessState::lookupHandleLocked</a></li>
              </ul>
            </li>
            <li><a href="#asinterfacecast-ibinder-into-ixxxinterface">asInterface(cast IBinder into IxxxInterface)</a></li>
            <li><a href="#useservice">useService</a>
              <ul>
                <li><a href="#servicemanagerproxygetservice">ServiceManagerProxy.getService</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#asinterfacecast-ibinder-into-ixxxinterface-1">asInterface(cast IBinder into IxxxInterface)</a>
      <ul>
        <li><a href="#iconnectivitymanager">IConnectivityManager</a></li>
        <li><a href="#stub">Stub</a></li>
        <li><a href="#asinterface">asInterface</a></li>
        <li><a href="#binderquerylocalinterface">Binder.queryLocalInterface</a></li>
        <li><a href="#binderproxyquerylocalinterface">BinderProxy.queryLocalInterface</a></li>
        <li><a href="#proxy">Proxy</a></li>
      </ul>
    </li>
    <li><a href="#useservice-1">useService</a>
      <ul>
        <li><a href="#parcel">Parcel</a>
          <ul>
            <li><a href="#obtain">obtain</a></li>
            <li><a href="#recycle">recycle</a></li>
          </ul>
        </li>
        <li><a href="#transact">transact</a>
          <ul>
            <li><a href="#binderproxy">BinderProxy</a>
              <ul>
                <li><a href="#android_os_binderproxy_transact">android_os_BinderProxy_transact</a></li>
                <li><a href="#parcelforjavaobject">parcelForJavaObject</a></li>
                <li><a href="#getbpnativedata">getBPNativeData</a></li>
              </ul>
            </li>
            <li><a href="#bpbinder">BpBinder</a></li>
            <li><a href="#ipcthreadstate">IPCThreadState</a>
              <ul>
                <li><a href="#self">self</a></li>
                <li><a href="#ipcthreadstate-1">IPCThreadState()</a></li>
                <li><a href="#transact-1">transact</a></li>
                <li><a href="#writetransactiondata">writeTransactionData</a></li>
                <li><a href="#parcelipcdata">Parcel::ipcData</a></li>
                <li><a href="#waitforresponse">waitForResponse</a></li>
                <li><a href="#parceldataavail">Parcel::dataAvail</a></li>
                <li><a href="#talkwithdriver">talkWithDriver</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              BinderClient
            </h1>
          

        


<h2 id="data-flow">Data Flow</h2>
<pre><code class="language-mermaid" data-lang="mermaid">graph LR
parcel_data--&gt;flat_binder_object
flat_binder_object--&gt;binder_transaction_data
</code></pre><h2 id="getservice">getService</h2>
<h3 id="systemserviceregistry">SystemServiceRegistry</h3>
<h4 id="contextimplgetsystemservice">ContextImpl.getSystemService</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> SystemServiceRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> name<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="registerservices">registerServices</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Manages all of the system services that can be returned by {@link Context#getSystemService}. Used by {@link ContextImpl}.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">......</span>
    registerService<span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">ACTIVITY_SERVICE</span><span style="color:#f92672">,</span> ActivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
                <span style="color:#66d9ef">new</span> CachedServiceFetcher<span style="color:#f92672">&lt;</span>ActivityManager<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> ActivityManager <span style="color:#a6e22e">createService</span><span style="color:#f92672">(</span>ContextImpl ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ActivityManager<span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">getOuterContext</span><span style="color:#f92672">(),</span> ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">mMainThread</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getHandler</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}});</span>
    
    <span style="color:#f92672">......</span>
    registerService<span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">DISPLAY_SERVICE</span><span style="color:#f92672">,</span> DisplayManager<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
                <span style="color:#66d9ef">new</span> CachedServiceFetcher<span style="color:#f92672">&lt;</span>DisplayManager<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> DisplayManager <span style="color:#a6e22e">createService</span><span style="color:#f92672">(</span>ContextImpl ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> DisplayManager<span style="color:#f92672">(</span>ctx<span style="color:#f92672">.</span><span style="color:#a6e22e">getOuterContext</span><span style="color:#f92672">());</span>
            <span style="color:#f92672">}});</span>
</code></pre></div><h4 id="registerservice">registerService</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Statically registers a system service with the context.
</span><span style="color:#75715e"> * This method must be called during static initialization only.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerService</span><span style="color:#f92672">(</span>String serviceName<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> serviceClass<span style="color:#f92672">,</span>
        ServiceFetcher<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> serviceFetcher<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    SYSTEM_SERVICE_NAMES<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>serviceClass<span style="color:#f92672">,</span> serviceName<span style="color:#f92672">);</span>
    SYSTEM_SERVICE_FETCHERS<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>serviceName<span style="color:#f92672">,</span> serviceFetcher<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="getsystemservice">getSystemService</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">getSystemService</span><span style="color:#f92672">(</span>ContextImpl ctx<span style="color:#f92672">,</span> String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ServiceFetcher<span style="color:#f92672">&lt;?&gt;</span> fetcher <span style="color:#f92672">=</span> SYSTEM_SERVICE_FETCHERS<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> fetcher <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> fetcher<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>ctx<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="cachedservicefetchergetservice">CachedServiceFetcher.getService</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CachedServiceFetcher</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> ServiceFetcher<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#a6e22e">@SuppressWarnings</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;unchecked&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> T <span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>ContextImpl ctx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        service <span style="color:#f92672">=</span> createService<span style="color:#f92672">(</span>ctx<span style="color:#f92672">);</span>
        cache<span style="color:#f92672">[</span>mCacheIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> service<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> service<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="createservice--servicemanagergetservice">createService&ndash;&gt;ServiceManager.getService</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> IBinder b <span style="color:#f92672">=</span> ServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>Context<span style="color:#f92672">.</span><span style="color:#a6e22e">CONNECTIVITY_SERVICE</span><span style="color:#f92672">);</span><span style="color:#75715e">//getService
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> IConnectivityManager service <span style="color:#f92672">=</span> IConnectivityManager<span style="color:#f92672">.</span><span style="color:#a6e22e">Stub</span><span style="color:#f92672">.</span><span style="color:#a6e22e">asInterface</span><span style="color:#f92672">(</span>b<span style="color:#f92672">);</span><span style="color:#75715e">//asInterface
</span><span style="color:#75715e"></span><span style="color:#66d9ef">final</span> ProxyInfo proxyInfo <span style="color:#f92672">=</span> service<span style="color:#f92672">.</span><span style="color:#a6e22e">getProxyForNetwork</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span><span style="color:#75715e">//useService
</span></code></pre></div><h3 id="servicemanager">ServiceManager</h3>
<h4 id="getservice-1">getService</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Returns a reference to a service with the given name.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * @param name the name of the service to get
</span><span style="color:#75715e"> * @return a reference to the service, or &lt;code&gt;null&lt;/code&gt; if the service doesn&#39;t exist
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> IBinder <span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        IBinder service <span style="color:#f92672">=</span> sCache<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>service <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> service<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">allowBlocking</span><span style="color:#f92672">(</span>rawGetService<span style="color:#f92672">(</span>name<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>RemoteException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Log<span style="color:#f92672">.</span><span style="color:#a6e22e">e</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;error in getService&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="rawgetservice">rawGetService</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> IBinder <span style="color:#a6e22e">rawGetService</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RemoteException <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">final</span> IBinder binder <span style="color:#f92672">=</span> getIServiceManager<span style="color:#f92672">().</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span><span style="color:#75715e">//getService then useService
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">return</span> binder<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="getiservicemanager">getIServiceManager</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> IServiceManager <span style="color:#a6e22e">getIServiceManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sServiceManager <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> sServiceManager<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">// Find the service manager
</span><span style="color:#75715e"></span>    sServiceManager <span style="color:#f92672">=</span> ServiceManagerNative
            <span style="color:#f92672">.</span><span style="color:#a6e22e">asInterface</span><span style="color:#f92672">(</span>Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">allowBlocking</span><span style="color:#f92672">(</span>BinderInternal<span style="color:#f92672">.</span><span style="color:#a6e22e">getContextObject</span><span style="color:#f92672">()));</span>
    <span style="color:#66d9ef">return</span> sServiceManager<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>frameworks/base/core/java/com/android/internal/os/BinderInternal.java</p>
<h5 id="binderinternalgetcontextobject">BinderInternal.getContextObject</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Return the global &#34;context object&#34; of the system.  This is usually
</span><span style="color:#75715e">     * an implementation of IServiceManager, which you can use to find
</span><span style="color:#75715e">     * other services.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">native</span> IBinder <span style="color:#a6e22e">getContextObject</span><span style="color:#f92672">();</span>
    
</code></pre></div><p>frameworks/base/core/jni/android_util_Binder.cpp</p>
<h5 id="android_os_binderinternal_getcontextobject">android_os_BinderInternal_getContextObject</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> jobject <span style="color:#a6e22e">android_os_BinderInternal_getContextObject</span>(JNIEnv<span style="color:#f92672">*</span> env, jobject clazz)
{
    sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;</span> b <span style="color:#f92672">=</span> ProcessState<span style="color:#f92672">::</span>self()<span style="color:#f92672">-&gt;</span>getContextObject(NULL);
    <span style="color:#66d9ef">return</span> javaObjectForIBinder(env, b);
}
</code></pre></div><p>system/libhwbinder/ProcessState.cpp</p>
<h5 id="processstategetcontextobject">ProcessState::getContextObject</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;</span> ProcessState<span style="color:#f92672">::</span>getContextObject(<span style="color:#66d9ef">const</span> sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;&amp;</span> <span style="color:#75715e">/*caller*/</span>)
{
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getStrongProxyForHandle</span>(<span style="color:#ae81ff">0</span>);
}
</code></pre></div><h5 id="processstategetstrongproxyforhandle">ProcessState::getStrongProxyForHandle</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;</span> ProcessState<span style="color:#f92672">::</span>getStrongProxyForHandle(<span style="color:#66d9ef">int32_t</span> handle)
{
    sp<span style="color:#f92672">&lt;</span>IBinder<span style="color:#f92672">&gt;</span> result;
    handle_entry<span style="color:#f92672">*</span> e <span style="color:#f92672">=</span> lookupHandleLocked(handle);
    <span style="color:#66d9ef">if</span> (e <span style="color:#f92672">!=</span> NULL) {
        <span style="color:#75715e">// We need to create a new BpHwBinder if there isn&#39;t currently one, OR we
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// are unable to acquire a weak reference on this current one.  See comment
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// in getWeakProxyForHandle() for more info about this.
</span><span style="color:#75715e"></span>        IBinder<span style="color:#f92672">*</span> b <span style="color:#f92672">=</span> e<span style="color:#f92672">-&gt;</span>binder;
        <span style="color:#66d9ef">if</span> (b <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>e<span style="color:#f92672">-&gt;</span>refs<span style="color:#f92672">-&gt;</span>attemptIncWeak(<span style="color:#66d9ef">this</span>)) {
            b <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BpHwBinder(handle);
            e<span style="color:#f92672">-&gt;</span>binder <span style="color:#f92672">=</span> b;
            <span style="color:#66d9ef">if</span> (b) e<span style="color:#f92672">-&gt;</span>refs <span style="color:#f92672">=</span> b<span style="color:#f92672">-&gt;</span>getWeakRefs();
            result <span style="color:#f92672">=</span> b;
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// This little bit of nastyness is to allow us to add a primary
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// reference to the remote proxy when this team doesn&#39;t have one
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// but another team is sending the handle to us.
</span><span style="color:#75715e"></span>            result.force_set(b);
            e<span style="color:#f92672">-&gt;</span>refs<span style="color:#f92672">-&gt;</span>decWeak(<span style="color:#66d9ef">this</span>);
        }
    }
    <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><h5 id="processstatelookuphandlelocked">ProcessState::lookupHandleLocked</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Vector<span style="color:#f92672">&lt;</span>handle_entry<span style="color:#f92672">&gt;</span> mHandleToObject;
ProcessState<span style="color:#f92672">::</span>handle_entry<span style="color:#f92672">*</span> ProcessState<span style="color:#f92672">::</span>lookupHandleLocked(<span style="color:#66d9ef">int32_t</span> handle)
{
    <span style="color:#66d9ef">const</span> size_t N<span style="color:#f92672">=</span>mHandleToObject.size();
    <span style="color:#66d9ef">if</span> (N <span style="color:#f92672">&lt;=</span> (size_t)handle) {
        handle_entry e;
        e.binder <span style="color:#f92672">=</span> NULL;
        e.refs <span style="color:#f92672">=</span> NULL;
        status_t err <span style="color:#f92672">=</span> mHandleToObject.insertAt(e, N, handle<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>N);
        <span style="color:#66d9ef">if</span> (err <span style="color:#f92672">&lt;</span> NO_ERROR) <span style="color:#66d9ef">return</span> NULL;
    }
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>mHandleToObject.editItemAt(handle);
}
</code></pre></div><h4 id="asinterfacecast-ibinder-into-ixxxinterface">asInterface(cast IBinder into IxxxInterface)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServiceManagerNative</span> <span style="color:#66d9ef">extends</span> Binder <span style="color:#66d9ef">implements</span> IServiceManager
<span style="color:#f92672">{</span>
    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Cast a Binder object into a service manager interface, generating
</span><span style="color:#75715e">     * a proxy if needed.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">public</span> IServiceManager <span style="color:#a6e22e">asInterface</span><span style="color:#f92672">(</span>IBinder obj<span style="color:#f92672">)</span>
    <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>obj <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        IServiceManager in <span style="color:#f92672">=</span>
            <span style="color:#f92672">(</span>IServiceManager<span style="color:#f92672">)</span>obj<span style="color:#f92672">.</span><span style="color:#a6e22e">queryLocalInterface</span><span style="color:#f92672">(</span>descriptor<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>in <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> in<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ServiceManagerProxy<span style="color:#f92672">(</span>obj<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h4 id="useservice">useService</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">IServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>name<span style="color:#f92672">)</span>
</code></pre></div><h5 id="servicemanagerproxygetservice">ServiceManagerProxy.getService</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServiceManagerProxy</span> <span style="color:#66d9ef">implements</span> IServiceManager <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ServiceManagerProxy</span><span style="color:#f92672">(</span>IBinder remote<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        mRemote <span style="color:#f92672">=</span> remote<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> IBinder <span style="color:#a6e22e">asBinder</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> mRemote<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
  
    <span style="color:#66d9ef">public</span> IBinder <span style="color:#a6e22e">getService</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RemoteException <span style="color:#f92672">{</span>
        Parcel data <span style="color:#f92672">=</span> Parcel<span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
        Parcel reply <span style="color:#f92672">=</span> Parcel<span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInterfaceToken</span><span style="color:#f92672">(</span>IServiceManager<span style="color:#f92672">.</span><span style="color:#a6e22e">descriptor</span><span style="color:#f92672">);</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeString</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
        mRemote<span style="color:#f92672">.</span><span style="color:#a6e22e">transact</span><span style="color:#f92672">(</span>GET_SERVICE_TRANSACTION<span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> reply<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
        IBinder binder <span style="color:#f92672">=</span> reply<span style="color:#f92672">.</span><span style="color:#a6e22e">readStrongBinder</span><span style="color:#f92672">();</span>
        reply<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
        data<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> binder<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h2 id="asinterfacecast-ibinder-into-ixxxinterface-1">asInterface(cast IBinder into IxxxInterface)</h2>
<h3 id="iconnectivitymanager">IConnectivityManager</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IConnectivityManager</span> <span style="color:#66d9ef">extends</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IInterface</span>
</code></pre></div><h3 id="stub">Stub</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stub</span> <span style="color:#66d9ef">extends</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Binder</span> <span style="color:#66d9ef">implements</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IConnectivityManager</span>
</code></pre></div><h3 id="asinterface">asInterface</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Cast an IBinder object into an android.net.IConnectivityManager interface,
</span><span style="color:#75715e"> * generating a proxy if needed.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IConnectivityManager</span> <span style="color:#a6e22e">asInterface</span><span style="color:#f92672">(</span>android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IBinder</span> obj<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>obj<span style="color:#f92672">==</span><span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IInterface</span> iin <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span><span style="color:#a6e22e">queryLocalInterface</span><span style="color:#f92672">(</span>DESCRIPTOR<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(((</span>iin<span style="color:#f92672">!=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)&amp;&amp;(</span>iin <span style="color:#66d9ef">instanceof</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IConnectivityManager</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
<span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IConnectivityManager</span><span style="color:#f92672">)</span>iin<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IConnectivityManager</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Stub</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Proxy</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="binderquerylocalinterface">Binder.queryLocalInterface</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Use information supplied to attachInterface() to return the
</span><span style="color:#75715e">     * associated IInterface if it matches the requested
</span><span style="color:#75715e">     * descriptor.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@Nullable</span> IInterface <span style="color:#a6e22e">queryLocalInterface</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@NonNull</span> String descriptor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mDescriptor <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mDescriptor<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>descriptor<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> mOwner<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
</code></pre></div><h3 id="binderproxyquerylocalinterface">BinderProxy.queryLocalInterface</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BinderProxy</span> <span style="color:#66d9ef">implements</span> IBinder <span style="color:#f92672">{</span>
<span style="color:#66d9ef">public</span> IInterface <span style="color:#a6e22e">queryLocalInterface</span><span style="color:#f92672">(</span>String descriptor<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="proxy">Proxy</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Proxy</span> <span style="color:#66d9ef">implements</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IConnectivityManager</span>
<span style="color:#f92672">{</span>
<span style="color:#66d9ef">private</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IBinder</span> mRemote<span style="color:#f92672">;</span>
Proxy<span style="color:#f92672">(</span>android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">IBinder</span> remote<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span>
mRemote <span style="color:#f92672">=</span> remote<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="useservice-1">useService</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span> <span style="color:#66d9ef">public</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ProxyInfo</span> <span style="color:#a6e22e">getProxyForNetwork</span><span style="color:#f92672">(</span>android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Network</span> nework<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RemoteException</span>
<span style="color:#f92672">{</span>
android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Parcel</span> _data <span style="color:#f92672">=</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Parcel</span><span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Parcel</span> _reply <span style="color:#f92672">=</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">os</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Parcel</span><span style="color:#f92672">.</span><span style="color:#a6e22e">obtain</span><span style="color:#f92672">();</span>
android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ProxyInfo</span> _result<span style="color:#f92672">;</span>
<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
_data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInterfaceToken</span><span style="color:#f92672">(</span>DESCRIPTOR<span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>nework<span style="color:#f92672">!=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
_data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
nework<span style="color:#f92672">.</span><span style="color:#a6e22e">writeToParcel</span><span style="color:#f92672">(</span>_data<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
_data<span style="color:#f92672">.</span><span style="color:#a6e22e">writeInt</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
mRemote<span style="color:#f92672">.</span><span style="color:#a6e22e">transact</span><span style="color:#f92672">(</span>Stub<span style="color:#f92672">.</span><span style="color:#a6e22e">TRANSACTION_getProxyForNetwork</span><span style="color:#f92672">,</span> _data<span style="color:#f92672">,</span> _reply<span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
_reply<span style="color:#f92672">.</span><span style="color:#a6e22e">readException</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>0<span style="color:#f92672">!=</span>_reply<span style="color:#f92672">.</span><span style="color:#a6e22e">readInt</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
_result <span style="color:#f92672">=</span> android<span style="color:#f92672">.</span><span style="color:#a6e22e">net</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ProxyInfo</span><span style="color:#f92672">.</span><span style="color:#a6e22e">CREATOR</span><span style="color:#f92672">.</span><span style="color:#a6e22e">createFromParcel</span><span style="color:#f92672">(</span>_reply<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
_result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
_reply<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
_data<span style="color:#f92672">.</span><span style="color:#a6e22e">recycle</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">return</span> _result<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="parcel">Parcel</h3>
<h4 id="obtain">obtain</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Retrieve a new Parcel object from the pool.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Parcel <span style="color:#a6e22e">obtain</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> Parcel<span style="color:#f92672">[]</span> pool <span style="color:#f92672">=</span> sOwnedPool<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>pool<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Parcel p<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span>POOL_SIZE<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            p <span style="color:#f92672">=</span> pool<span style="color:#f92672">[</span>i<span style="color:#f92672">];</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>p <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                pool<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_RECYCLE<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    p<span style="color:#f92672">.</span><span style="color:#a6e22e">mStack</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
                p<span style="color:#f92672">.</span><span style="color:#a6e22e">mReadWriteHelper</span> <span style="color:#f92672">=</span> ReadWriteHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">return</span> p<span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Parcel<span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="recycle">recycle</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Put a Parcel object back into the pool.  You must not touch
</span><span style="color:#75715e"> * the object after this call.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recycle</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>DEBUG_RECYCLE<span style="color:#f92672">)</span> mStack <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    freeBuffer<span style="color:#f92672">();</span>

    <span style="color:#66d9ef">final</span> Parcel<span style="color:#f92672">[]</span> pool<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>mOwnsNativeParcelObject<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        pool <span style="color:#f92672">=</span> sOwnedPool<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        mNativePtr <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        pool <span style="color:#f92672">=</span> sHolderPool<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>pool<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span>POOL_SIZE<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pool<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                pool<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="transact">transact</h3>
<h4 id="binderproxy">BinderProxy</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Java proxy for a native IBinder object.
</span><span style="color:#75715e"> * Allocated and constructed by the native javaObjectforIBinder function. Never allocated
</span><span style="color:#75715e"> * directly from Java code.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BinderProxy</span> <span style="color:#66d9ef">implements</span> IBinder <span style="color:#f92672">{</span>
  
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">transact</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> code<span style="color:#f92672">,</span> Parcel data<span style="color:#f92672">,</span> Parcel reply<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> flags<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RemoteException <span style="color:#f92672">{</span>
    Binder<span style="color:#f92672">.</span><span style="color:#a6e22e">checkParcel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> code<span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Unreasonably large binder buffer&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> transactNative<span style="color:#f92672">(</span>code<span style="color:#f92672">,</span> data<span style="color:#f92672">,</span> reply<span style="color:#f92672">,</span> flags<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tracingEnabled<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">traceEnd</span><span style="color:#f92672">(</span>Trace<span style="color:#f92672">.</span><span style="color:#a6e22e">TRACE_TAG_ALWAYS</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> JNINativeMethod gBinderProxyMethods[] <span style="color:#f92672">=</span> {
     <span style="color:#75715e">/* name, signature, funcPtr */</span>
    {<span style="color:#e6db74">&#34;transactNative&#34;</span>,      <span style="color:#e6db74">&#34;(ILandroid/os/Parcel;Landroid/os/Parcel;I)Z&#34;</span>, (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)android_os_BinderProxy_transact},
</code></pre></div><h5 id="android_os_binderproxy_transact">android_os_BinderProxy_transact</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">static</span> jboolean <span style="color:#a6e22e">android_os_BinderProxy_transact</span>(JNIEnv<span style="color:#f92672">*</span> env, jobject obj,
        jint code, jobject dataObj, jobject replyObj, jint flags) <span style="color:#75715e">// throws RemoteException
</span><span style="color:#75715e"></span>{
    Parcel<span style="color:#f92672">*</span> data <span style="color:#f92672">=</span> parcelForJavaObject(env, dataObj);
    Parcel<span style="color:#f92672">*</span> reply <span style="color:#f92672">=</span> parcelForJavaObject(env, replyObj);
    
    IBinder<span style="color:#f92672">*</span> target <span style="color:#f92672">=</span> getBPNativeData(env, obj)<span style="color:#f92672">-&gt;</span>mObject.get();
    
    <span style="color:#75715e">//printf(&#34;Transact from Java code to %p sending: &#34;, target); data-&gt;print();
</span><span style="color:#75715e"></span>    status_t err <span style="color:#f92672">=</span> target<span style="color:#f92672">-&gt;</span>transact(code, <span style="color:#f92672">*</span>data, reply, flags);
    <span style="color:#75715e">//if (reply) printf(&#34;Transact from Java code to %p received: &#34;, target); reply-&gt;print();
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (kEnableBinderSample) {
        <span style="color:#66d9ef">if</span> (time_binder_calls) {
            conditionally_log_binder_call(start_millis, target, code);
        }
    }
  ......
}
</code></pre></div><h5 id="parcelforjavaobject">parcelForJavaObject</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Parcel<span style="color:#f92672">*</span> <span style="color:#a6e22e">parcelForJavaObject</span>(JNIEnv<span style="color:#f92672">*</span> env, jobject obj)
{
    <span style="color:#66d9ef">if</span> (obj) {
        Parcel<span style="color:#f92672">*</span> p <span style="color:#f92672">=</span> (Parcel<span style="color:#f92672">*</span>)env<span style="color:#f92672">-&gt;</span>GetLongField(obj, gParcelOffsets.mNativePtr);
        <span style="color:#66d9ef">return</span> p;
    }
    <span style="color:#66d9ef">return</span> NULL;
}
</code></pre></div><h5 id="getbpnativedata">getBPNativeData</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">BinderProxyNativeData<span style="color:#f92672">*</span> <span style="color:#a6e22e">getBPNativeData</span>(JNIEnv<span style="color:#f92672">*</span> env, jobject obj) {
    <span style="color:#66d9ef">return</span> (BinderProxyNativeData <span style="color:#f92672">*</span>) env<span style="color:#f92672">-&gt;</span>GetLongField(obj, gBinderProxyOffsets.mNativeData);
}
</code></pre></div><h4 id="bpbinder">BpBinder</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t BpBinder<span style="color:#f92672">::</span>transact(
    <span style="color:#66d9ef">uint32_t</span> code, <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data, Parcel<span style="color:#f92672">*</span> reply, <span style="color:#66d9ef">uint32_t</span> flags)
{
    <span style="color:#75715e">// Once a binder has died, it will never come back to life.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (mAlive) {
        status_t status <span style="color:#f92672">=</span> IPCThreadState<span style="color:#f92672">::</span>self()<span style="color:#f92672">-&gt;</span>transact(
            mHandle, code, data, reply, flags);<span style="color:#75715e">//传递mHandle
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (status <span style="color:#f92672">==</span> DEAD_OBJECT) mAlive <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">return</span> status;
    }

    <span style="color:#66d9ef">return</span> DEAD_OBJECT;
}
</code></pre></div><h4 id="ipcthreadstate">IPCThreadState</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">            Parcel              mIn;
            Parcel              mOut;
</code></pre></div><h5 id="self">self</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">IPCThreadState<span style="color:#f92672">*</span> IPCThreadState<span style="color:#f92672">::</span>self()
{
        <span style="color:#66d9ef">const</span> pthread_key_t k <span style="color:#f92672">=</span> gTLS;
        IPCThreadState<span style="color:#f92672">*</span> st <span style="color:#f92672">=</span> (IPCThreadState<span style="color:#f92672">*</span>)pthread_getspecific(k);
        <span style="color:#66d9ef">if</span> (st) <span style="color:#66d9ef">return</span> st;
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> IPCThreadState;
    
</code></pre></div><h5 id="ipcthreadstate-1">IPCThreadState()</h5>
<p>每个线程都有一个<code>IPCThreadState</code>，每个<code>IPCThreadState</code>中都有一个mIn、一个mOut。成员变量mProcess保存了ProcessState变量(每个进程只有一个)。</p>
<ul>
<li>mIn 用来接收来自Binder设备的数据，默认大小为256字节；</li>
<li>mOut用来存储发往Binder设备的数据，默认大小为256字节。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">IPCThreadState<span style="color:#f92672">::</span>IPCThreadState()
    <span style="color:#f92672">:</span> mProcess(ProcessState<span style="color:#f92672">::</span>self()),
      mStrictModePolicy(<span style="color:#ae81ff">0</span>),
      mLastTransactionBinderFlags(<span style="color:#ae81ff">0</span>)
{
    pthread_setspecific(gTLS, <span style="color:#66d9ef">this</span>);
    clearCaller();
    mIn.setDataCapacity(<span style="color:#ae81ff">256</span>);
    mOut.setDataCapacity(<span style="color:#ae81ff">256</span>);
}
</code></pre></div><h5 id="transact-1">transact</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#f92672">::</span>transact(<span style="color:#66d9ef">int32_t</span> handle,
                                  <span style="color:#66d9ef">uint32_t</span> code, <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data,
                                  Parcel<span style="color:#f92672">*</span> reply, <span style="color:#66d9ef">uint32_t</span> flags)
{
    flags <span style="color:#f92672">|=</span> TF_ACCEPT_FDS;
    err <span style="color:#f92672">=</span> writeTransactionData(BC_TRANSACTION, flags, handle, code, data, NULL);<span style="color:#960050;background-color:#1e0010">、</span><span style="color:#75715e">//传递handle
</span><span style="color:#75715e"></span>    
    <span style="color:#66d9ef">if</span> ((flags <span style="color:#f92672">&amp;</span> TF_ONE_WAY) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
       <span style="color:#66d9ef">if</span> (reply) {<span style="color:#75715e">//call waitForResponse with param reply not null
</span><span style="color:#75715e"></span>            err <span style="color:#f92672">=</span> waitForResponse(reply);
        } <span style="color:#66d9ef">else</span> {
            Parcel fakeReply;
            err <span style="color:#f92672">=</span> waitForResponse(<span style="color:#f92672">&amp;</span>fakeReply);<span style="color:#75715e">//call waitForResponse with param reply null
</span><span style="color:#75715e"></span>        }
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">//oneway，则不需要等待reply的场景
</span><span style="color:#75715e"></span>        err <span style="color:#f92672">=</span> waitForResponse(NULL, NULL);
    }

</code></pre></div><h5 id="writetransactiondata">writeTransactionData</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#f92672">::</span>writeTransactionData(<span style="color:#66d9ef">int32_t</span> cmd, <span style="color:#66d9ef">uint32_t</span> binderFlags,
    <span style="color:#66d9ef">int32_t</span> handle, <span style="color:#66d9ef">uint32_t</span> code, <span style="color:#66d9ef">const</span> Parcel<span style="color:#f92672">&amp;</span> data, status_t<span style="color:#f92672">*</span> statusBuffer)
{
    binder_transaction_data tr;

    tr.target.ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">/* Don&#39;t pass uninitialized stack data to a remote process */</span>
    tr.target.handle <span style="color:#f92672">=</span> handle;<span style="color:#75715e">//准备写入handle
</span><span style="color:#75715e"></span>    tr.code <span style="color:#f92672">=</span> code; <span style="color:#75715e">//wrapped code
</span><span style="color:#75715e"></span>    tr.flags <span style="color:#f92672">=</span> binderFlags;
    tr.cookie <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    tr.sender_pid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    tr.sender_euid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">const</span> status_t err <span style="color:#f92672">=</span> data.errorCheck();
    <span style="color:#66d9ef">if</span> (err <span style="color:#f92672">==</span> NO_ERROR) {
        tr.data_size <span style="color:#f92672">=</span> data.ipcDataSize();<span style="color:#75715e">// mDataSize,binder_transaction的数据大小
</span><span style="color:#75715e"></span>        tr.data.ptr.buffer <span style="color:#f92672">=</span> data.ipcData();<span style="color:#75715e">//mData, binder_transaction的数据的起始地址
</span><span style="color:#75715e"></span>        tr.offsets_size <span style="color:#f92672">=</span> data.ipcObjectsCount()<span style="color:#f92672">*</span><span style="color:#66d9ef">sizeof</span>(binder_size_t);<span style="color:#75715e">//mObjectsSize,记录着flat_binder_object结构体的个数
</span><span style="color:#75715e"></span>        tr.data.ptr.offsets <span style="color:#f92672">=</span> data.ipcObjects();<span style="color:#75715e">//mObjects, 记录着flat_binder_object结构体在数据偏移量
</span><span style="color:#75715e"></span>    }

    mOut.writeInt32(cmd);<span style="color:#75715e">//cmd = BC_TRANSACTION
</span><span style="color:#75715e"></span>    mOut.write(<span style="color:#f92672">&amp;</span>tr, <span style="color:#66d9ef">sizeof</span>(tr));<span style="color:#75715e">//写入binder_transaction_data数据
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return</span> NO_ERROR;
}
</code></pre></div><h5 id="parcelipcdata">Parcel::ipcData</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">uintptr_t Parcel<span style="color:#f92672">::</span>ipcData() <span style="color:#66d9ef">const</span>
{
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span>uintptr_t<span style="color:#f92672">&gt;</span>(mData);
}
</code></pre></div><h5 id="waitforresponse">waitForResponse</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#f92672">::</span>waitForResponse(Parcel <span style="color:#f92672">*</span>reply, status_t <span style="color:#f92672">*</span>acquireResult)
{
    <span style="color:#66d9ef">uint32_t</span> cmd;
    <span style="color:#66d9ef">int32_t</span> err;

    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
        <span style="color:#66d9ef">if</span> ((err<span style="color:#f92672">=</span>talkWithDriver()) <span style="color:#f92672">&lt;</span> NO_ERROR) <span style="color:#66d9ef">break</span>;
        err <span style="color:#f92672">=</span> mIn.errorCheck();
        <span style="color:#66d9ef">if</span> (err <span style="color:#f92672">&lt;</span> NO_ERROR) <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">if</span> (mIn.dataAvail() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">continue</span>;

        cmd <span style="color:#f92672">=</span> (<span style="color:#66d9ef">uint32_t</span>)mIn.readInt32();
        
        <span style="color:#66d9ef">switch</span> (cmd) {
        <span style="color:#66d9ef">case</span> BR_TRANSACTION_COMPLETE:
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>reply <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>acquireResult) <span style="color:#66d9ef">goto</span> finish;
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> BR_REPLY:
            {
                binder_transaction_data tr;
                err <span style="color:#f92672">=</span> mIn.read(<span style="color:#f92672">&amp;</span>tr, <span style="color:#66d9ef">sizeof</span>(tr));
                                <span style="color:#66d9ef">if</span> (reply) {
                <span style="color:#66d9ef">if</span> ((tr.flags <span style="color:#f92672">&amp;</span> TF_STATUS_CODE) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
                        reply<span style="color:#f92672">-&gt;</span>ipcSetDataReference(
                            <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span><span style="color:#f92672">*&gt;</span>(tr.data.ptr.buffer),
                            tr.data_size,
                            <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> binder_size_t<span style="color:#f92672">*&gt;</span>(tr.data.ptr.offsets),
                            tr.offsets_size<span style="color:#f92672">/</span><span style="color:#66d9ef">sizeof</span>(binder_size_t),
                            freeBuffer, <span style="color:#66d9ef">this</span>);
                    } <span style="color:#66d9ef">else</span> {
                        err <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> status_t<span style="color:#f92672">*&gt;</span>(tr.data.ptr.buffer);
                        freeBuffer(NULL,
                            <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span><span style="color:#f92672">*&gt;</span>(tr.data.ptr.buffer),
                            tr.data_size,
                            <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> binder_size_t<span style="color:#f92672">*&gt;</span>(tr.data.ptr.offsets),
                            tr.offsets_size<span style="color:#f92672">/</span><span style="color:#66d9ef">sizeof</span>(binder_size_t), <span style="color:#66d9ef">this</span>);
                    }
                } <span style="color:#66d9ef">else</span> {
                    freeBuffer(NULL,
                        <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span><span style="color:#f92672">*&gt;</span>(tr.data.ptr.buffer),
                        tr.data_size,
                        <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> binder_size_t<span style="color:#f92672">*&gt;</span>(tr.data.ptr.offsets),
                        tr.offsets_size<span style="color:#f92672">/</span><span style="color:#66d9ef">sizeof</span>(binder_size_t), <span style="color:#66d9ef">this</span>);
                    <span style="color:#66d9ef">continue</span>;
                }
                ......
            }
            <span style="color:#66d9ef">goto</span> finish;
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            err <span style="color:#f92672">=</span> executeCommand(cmd);
            <span style="color:#66d9ef">if</span> (err <span style="color:#f92672">!=</span> NO_ERROR) <span style="color:#66d9ef">goto</span> finish;
            <span style="color:#66d9ef">break</span>;
</code></pre></div><h5 id="parceldataavail">Parcel::dataAvail</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">size_t Parcel<span style="color:#f92672">::</span>dataAvail() <span style="color:#66d9ef">const</span>
{
    size_t result <span style="color:#f92672">=</span> dataSize() <span style="color:#f92672">-</span> dataPosition();
    <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">&gt;</span> INT32_MAX) {
        abort();
    }
    <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><h5 id="talkwithdriver">talkWithDriver</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">status_t IPCThreadState<span style="color:#f92672">::</span>talkWithDriver(<span style="color:#66d9ef">bool</span> doReceive)
{
    binder_write_read bwr;
        <span style="color:#75715e">// Is the read buffer empty?
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">bool</span> needRead <span style="color:#f92672">=</span> mIn.dataPosition() <span style="color:#f92672">&gt;=</span> mIn.dataSize();
    
    <span style="color:#75715e">// We don&#39;t want to write anything if we are still reading
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// from data left in the input buffer and the caller
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// has requested to read the next data.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> size_t outAvail <span style="color:#f92672">=</span> (<span style="color:#f92672">!</span>doReceive <span style="color:#f92672">||</span> needRead) <span style="color:#f92672">?</span> mOut.dataSize() <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
    
    bwr.write_size <span style="color:#f92672">=</span> outAvail;
    bwr.write_buffer <span style="color:#f92672">=</span> (uintptr_t)mOut.data();<span style="color:#75715e">//写入write buffer
</span><span style="color:#75715e"></span>    
    <span style="color:#75715e">// This is what we&#39;ll read.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (doReceive <span style="color:#f92672">&amp;&amp;</span> needRead) {
        bwr.read_size <span style="color:#f92672">=</span> mIn.dataCapacity();
        bwr.read_buffer <span style="color:#f92672">=</span> (uintptr_t)mIn.data();
    } <span style="color:#66d9ef">else</span> {
        bwr.read_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        bwr.read_buffer <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
    
    <span style="color:#75715e">// Return immediately if there is nothing to do.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ((bwr.write_size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (bwr.read_size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) <span style="color:#66d9ef">return</span> NO_ERROR;
    
    bwr.write_consumed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    bwr.read_consumed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">do</span> {
          <span style="color:#66d9ef">if</span> (ioctl(mProcess<span style="color:#f92672">-&gt;</span>mDriverFD, BINDER_WRITE_READ, <span style="color:#f92672">&amp;</span>bwr) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>)
              err <span style="color:#f92672">=</span> NO_ERROR;
          <span style="color:#66d9ef">else</span>
              err <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>errno;
        
          <span style="color:#66d9ef">if</span> (mProcess<span style="color:#f92672">-&gt;</span>mDriverFD <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>) {
              err <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>EBADF;
          }
      } <span style="color:#66d9ef">while</span> (err <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>EINTR);
</code></pre></div>

<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/" title="binder"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/en/android/%E7%B3%BB%E7%BB%9F%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86/%E5%A4%9A%E8%BF%9B%E7%A8%8B/binder/binderdeath/" title="BinderDeath" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1611382484"></script>
    <script src="/js/perfect-scrollbar.min.js?1611382484"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1611382484"></script>
    <script src="/js/jquery.sticky.js?1611382484"></script>
    <script src="/js/featherlight.min.js?1611382484"></script>
    <script src="/js/highlight.pack.js?1611382484"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1611382484"></script>
    <script src="/js/learn.js?1611382484"></script>
    <script src="/js/hugo-learn.js?1611382484"></script>
    
        
            <script src="/mermaid/mermaid.js?1611382484"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

